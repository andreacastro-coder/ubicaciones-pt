<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0052CC">
    <title>PT Control | Industronic</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        :root{--primary:#0052CC;--primary-dark:#003d99;--bg-light:#f4f5f7;--text-dark:#172b4d;--text-light:#7a869a;--border:#dfe1e6;--success:#36B37E;--success-bg:#e3fcef;--warning:#FF991F;--warning-bg:#fffae6;--error:#DE350B;--error-bg:#ffebe6;--info:#0065FF;--info-bg:#deebff;--radius:12px}
        body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg-light);color:var(--text-dark);min-height:100vh}
        .screen{display:none;animation:fadeIn .25s}.screen.active{display:block}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        
        .header{background:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
        .header-logo{display:flex;align-items:center;gap:8px;font-weight:700;font-size:14px;color:var(--text-dark)}
        .logo-icon{width:28px;height:28px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:12px}
        .user-pill{background:var(--bg-light);padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;color:var(--text-dark);cursor:pointer}
        
        .login-container{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:24px;background:linear-gradient(180deg,var(--primary) 0%,var(--primary-dark) 40%,var(--bg-light) 40%)}
        .login-card{background:white;border-radius:16px;padding:32px 24px;width:100%;max-width:380px;box-shadow:0 8px 30px rgba(0,0,0,0.12)}
        .login-logo{text-align:center;margin-bottom:20px}
        .login-logo-icon{width:50px;height:50px;background:var(--primary);border-radius:50%;display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:20px}
        .login-title{font-size:20px;font-weight:800;text-align:center;margin-bottom:4px}
        .login-subtitle{color:var(--text-light);text-align:center;font-size:13px;margin-bottom:24px}
        
        .role-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
        .role-btn{background:var(--bg-light);border:2px solid transparent;border-radius:var(--radius);padding:16px 12px;text-align:center;cursor:pointer;transition:all .2s}
        .role-btn:hover,.role-btn:active{border-color:var(--primary);background:var(--info-bg)}
        .role-btn .icon{font-size:24px;margin-bottom:6px}
        .role-btn .name{font-size:13px;font-weight:700}
        .role-btn .desc{font-size:10px;color:var(--text-light);margin-top:2px}
        
        .user-list{display:flex;flex-direction:column;gap:8px;max-height:250px;overflow-y:auto}
        .user-btn{background:var(--bg-light);border:2px solid transparent;border-radius:8px;padding:12px 14px;font-size:14px;font-weight:600;cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px}
        .user-btn:hover,.user-btn:active{border-color:var(--primary);background:var(--info-bg)}
        .user-btn .avatar{width:32px;height:32px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px}
        .back-link{text-align:center;margin-top:16px;font-size:13px;color:var(--primary);cursor:pointer;font-weight:600}
        
        .menu-container{padding:16px}
        .welcome-banner{background:linear-gradient(135deg,var(--primary),#0065FF);border-radius:var(--radius);padding:20px;color:white;margin-bottom:20px}
        .welcome-banner h2{font-size:18px;font-weight:700;margin-bottom:2px}
        .welcome-banner p{font-size:12px;opacity:.9}
        .stats-row{display:flex;gap:10px;margin-top:14px}
        .stat-box{flex:1;background:rgba(255,255,255,.18);border-radius:8px;padding:10px;text-align:center}
        .stat-box .value{font-size:22px;font-weight:800}
        .stat-box .label{font-size:10px;opacity:.85;text-transform:uppercase}
        
        .section-title{font-size:11px;font-weight:700;color:var(--text-light);text-transform:uppercase;letter-spacing:.5px;margin:16px 0 10px}
        .menu-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .menu-card{background:white;border-radius:var(--radius);padding:18px 14px;text-align:center;cursor:pointer;transition:all .15s;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid var(--border)}
        .menu-card:active{transform:scale(0.98)}
        .menu-icon{width:44px;height:44px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:22px}
        .menu-card.recepcion .menu-icon{background:var(--success-bg)}
        .menu-card.acomodo .menu-icon{background:var(--info-bg)}
        .menu-card.traspaso .menu-icon{background:var(--warning-bg)}
        .menu-card.embarque .menu-icon{background:var(--error-bg)}
        .menu-card.consulta .menu-icon{background:#f3e8ff}
        .menu-card.historial .menu-icon{background:var(--bg-light)}
        .menu-card.mis-movs .menu-icon{background:#fef3c7}
        .menu-card.export .menu-icon{background:#dbeafe}
        .menu-title{font-weight:700;font-size:13px}
        .menu-desc{font-size:10px;color:var(--text-light);margin-top:2px}
        
        .scanner-header{display:flex;align-items:center;gap:10px;padding:12px 16px;background:white;border-bottom:1px solid var(--border)}
        .back-btn{background:var(--bg-light);border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-size:16px}
        .scanner-title{font-size:16px;font-weight:700;flex:1}
        .scanner-body{padding:16px}
        
        .config-card{background:white;border-radius:var(--radius);padding:14px;margin-bottom:14px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
        .config-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .config-row+.config-row{margin-top:12px}
        .config-label{font-size:12px;font-weight:600;color:var(--text-light);min-width:70px}
        .config-select,.form-input{flex:1;background:var(--bg-light);border:2px solid var(--border);border-radius:8px;padding:10px 12px;font-size:14px;font-weight:600;min-width:0}
        .config-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%235e6c84' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center}
        .config-select:focus,.form-input:focus{outline:none;border-color:var(--primary)}
        .lock-btn{background:var(--bg-light);border:2px solid var(--border);border-radius:8px;padding:8px 12px;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap}
        .lock-btn.locked{background:var(--primary);border-color:var(--primary);color:white}
        
        .input-tabs{display:flex;background:var(--bg-light);border-radius:8px;padding:3px;margin-bottom:14px}
        .input-tab{flex:1;padding:8px;text-align:center;font-size:12px;font-weight:600;border-radius:6px;cursor:pointer;color:var(--text-light)}
        .input-tab.active{background:white;color:var(--primary);box-shadow:0 1px 3px rgba(0,0,0,0.1)}
        
        .scanner-box{background:white;border-radius:var(--radius);overflow:hidden;margin-bottom:14px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
        .scanner-region{width:100%;aspect-ratio:4/3;background:#1a1a2e}
        .scan-status{padding:12px;display:flex;align-items:center;gap:8px;border-top:1px solid var(--border);font-size:12px;color:var(--text-light)}
        .scan-status .dot{width:8px;height:8px;border-radius:50%;background:var(--success);animation:pulse 1.5s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
        
        .scanned-list{background:white;border-radius:var(--radius);overflow:hidden;margin-bottom:14px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
        .scanned-list-header{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
        .scanned-list-header h4{font-size:13px;font-weight:700}
        .scanned-count{background:var(--primary);color:white;font-size:11px;font-weight:700;padding:3px 8px;border-radius:10px}
        .scanned-items{max-height:180px;overflow-y:auto}
        .scanned-item{padding:10px 14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);font-size:13px}
        .scanned-item:last-child{border-bottom:none}
        .scanned-item .code{font-family:monospace;font-weight:600}
        .scanned-item .time{font-size:10px;color:var(--text-light)}
        .scanned-item .remove-btn{background:none;border:none;color:var(--error);cursor:pointer;padding:4px;font-size:16px}
        .empty-list{padding:24px;text-align:center;color:var(--text-light);font-size:12px}
        
        .btn{width:100%;padding:14px;border:none;border-radius:var(--radius);font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px}
        .btn-primary{background:var(--primary);color:white}
        .btn-success{background:var(--success);color:white}
        .btn-secondary{background:var(--bg-light);color:var(--text-dark);border:2px solid var(--border)}
        .btn:disabled{opacity:.5;cursor:not-allowed}
        
        .location-dropdown{position:relative;flex:1}
        .location-dropdown .suggestions{position:absolute;top:100%;left:0;right:0;background:white;border:2px solid var(--primary);border-top:none;border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:50;display:none}
        .location-dropdown .suggestions.show{display:block}
        .suggestion-item{padding:10px 12px;cursor:pointer;font-size:13px;border-bottom:1px solid var(--border)}
        .suggestion-item:hover{background:var(--info-bg)}
        
        .search-card{background:white;border-radius:var(--radius);padding:16px;margin-bottom:14px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
        .search-row{display:flex;gap:10px}
        .search-btn{background:var(--primary);color:white;border:none;border-radius:8px;padding:12px 16px;font-weight:700;cursor:pointer}
        
        .equipment-card{background:white;border-radius:var(--radius);overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
        .equipment-header{background:var(--primary);color:white;padding:16px}
        .equipment-header .code{font-family:monospace;font-size:18px;font-weight:700}
        .equipment-header .details{display:flex;gap:16px;font-size:12px;opacity:.9;margin-top:4px}
        .equipment-status{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .status-badge{padding:5px 10px;border-radius:16px;font-size:11px;font-weight:700}
        .status-badge.en-bodega{background:var(--success-bg);color:var(--success)}
        .status-badge.embarcado{background:var(--error-bg);color:var(--error)}
        .equipment-timeline{padding:14px 16px}
        .timeline-title{font-size:11px;font-weight:700;color:var(--text-light);text-transform:uppercase;margin-bottom:10px}
        .timeline-item{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
        .timeline-item:last-child{border-bottom:none}
        .timeline-dot{width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0}
        .timeline-dot.recepcion{background:var(--success)}
        .timeline-dot.acomodo{background:var(--info)}
        .timeline-dot.traspaso{background:var(--warning)}
        .timeline-dot.embarque{background:var(--error)}
        .timeline-content .action{font-size:13px;font-weight:600}
        .timeline-content .meta{font-size:11px;color:var(--text-light);margin-top:2px}
        
        .history-filters{display:flex;gap:6px;overflow-x:auto;padding-bottom:6px;margin-bottom:14px}
        .filter-chip{background:white;border:2px solid var(--border);border-radius:16px;padding:6px 12px;font-size:11px;font-weight:600;white-space:nowrap;cursor:pointer}
        .filter-chip.active{border-color:var(--primary);background:var(--primary);color:white}
        .history-list{display:flex;flex-direction:column;gap:10px}
        .history-item{background:white;border-radius:var(--radius);padding:14px;display:flex;gap:10px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
        .history-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
        .history-icon.recepcion{background:var(--success-bg)}
        .history-icon.acomodo{background:var(--info-bg)}
        .history-icon.traspaso{background:var(--warning-bg)}
        .history-icon.embarque{background:var(--error-bg)}
        .history-content{flex:1;min-width:0}
        .history-code{font-family:monospace;font-size:13px;font-weight:600}
        .history-details{font-size:11px;color:var(--text-light);margin-top:2px}
        .history-meta{display:flex;gap:10px;font-size:10px;color:var(--text-light);margin-top:4px;flex-wrap:wrap}
        .history-actions{margin-top:6px;display:flex;gap:6px}
        .history-actions button{background:var(--bg-light);border:1px solid var(--border);border-radius:4px;padding:4px 8px;font-size:10px;font-weight:600;cursor:pointer;color:white}
        .history-actions button.delete{background:var(--error);border-color:var(--error)}
        .history-actions button.edit{background:var(--info);border-color:var(--info)}
        
        .config-select{width:100%;padding:10px 12px;font-size:13px;border:2px solid var(--border);border-radius:8px;background:white;color:var(--text-dark);cursor:pointer}
        .config-select:focus{outline:none;border-color:var(--primary)}
        
        .form-group{margin-bottom:14px}
        .form-group label{display:block;font-size:12px;font-weight:600;color:var(--text-light);margin-bottom:6px}
        
        .toast{position:fixed;bottom:80px;left:16px;right:16px;background:white;border-radius:var(--radius);padding:14px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,0.15);transform:translateY(100px);opacity:0;transition:all .3s;z-index:1000}
        .toast.show{transform:translateY(0);opacity:1}
        .toast.success{border-left:4px solid var(--success)}
        .toast.error{border-left:4px solid var(--error)}
        .toast.warning{border-left:4px solid var(--warning)}
        
        .pending-badge{position:fixed;bottom:20px;right:16px;background:var(--warning);color:white;padding:8px 14px;border-radius:20px;font-size:12px;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,0.15);display:none}
        .pending-badge.show{display:flex;align-items:center;gap:6px}
        .offline-bar{background:var(--warning);color:white;padding:8px;text-align:center;font-size:12px;font-weight:600;display:none}
        .offline-bar.show{display:block}
        .empty-state{text-align:center;padding:40px 20px;color:var(--text-light)}
        .hidden{display:none!important}
        .mt-14{margin-top:14px}
        .form-group{margin-bottom:12px}
        .form-group label{display:block;font-size:12px;font-weight:600;color:var(--text-light);margin-bottom:6px}
        .alert-box{background:var(--warning-bg);border:1px solid var(--warning);border-radius:8px;padding:12px;margin-bottom:14px;font-size:12px;color:#92400e}
        
        .qr-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:200;display:none;flex-direction:column}
        .qr-modal.show{display:flex}
    </style>
</head>
<body>
    <div id="offlineBar" class="offline-bar">‚ö†Ô∏è Sin conexi√≥n - Guardado local</div>

    <!-- LOGIN -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <div class="login-card">
                <div class="login-logo">
                    <div class="login-logo-icon">PT</div>
                </div>
                <h1 class="login-title">PT Control</h1>
                <p class="login-subtitle">Selecciona tu tipo de acceso</p>
                
                <div id="roleSelection">
                    <div class="role-grid">
                        <div class="role-btn" id="roleUsuario"><div class="icon">üë∑</div><div class="name">Usuario</div><div class="desc">Operaciones</div></div>
                        <div class="role-btn" id="roleConsulta"><div class="icon">üîç</div><div class="name">Consulta</div><div class="desc">Buscar + Reportes</div></div>
                        <div class="role-btn" id="roleReparaciones"><div class="icon">üîß</div><div class="name">Reparaciones</div><div class="desc" style="color:var(--warning)">üîí Clave</div></div>
                        <div class="role-btn" id="roleCalidad"><div class="icon">‚úÖ</div><div class="name">Calidad</div><div class="desc" style="color:var(--warning)">üîí Clave</div></div>
                        <div class="role-btn" id="roleAuditoria"><div class="icon">üìã</div><div class="name">Auditoria</div><div class="desc" style="color:var(--warning)">üîí Clave</div></div>
                        <div class="role-btn" id="roleSupervisor"><div class="icon">‚≠ê</div><div class="name">Supervisor</div><div class="desc" style="color:var(--warning)">üîí Clave</div></div>
                    </div>
                </div>
                
                <div id="userSelection" class="hidden">
                    <div class="user-list" id="userGrid"></div>
                    <div class="back-link" id="backToRolesBtn">‚Üê Cambiar tipo de acceso</div>
                </div>
                
                <div id="bodegaReparacionesSection" class="hidden">
                    <h3 style="font-size:14px;text-align:center;margin-bottom:12px">Selecciona Bodega</h3>
                    <div style="display:flex;gap:12px;margin-bottom:16px">
                        <button class="role-btn" id="bodegaB3" style="flex:1"><div class="icon">üè≠</div><div class="name">Bodega 3</div></button>
                        <button class="role-btn" id="bodegaB7" style="flex:1"><div class="icon">üè≠</div><div class="name">Bodega 7</div></button>
                    </div>
                    <div class="back-link" id="backFromBodega">‚Üê Cambiar</div>
                </div>
                
                <div id="passwordSection" class="hidden">
                    <h3 id="passwordTitle" style="font-size:14px;text-align:center;margin-bottom:12px">Clave</h3>
                    <input type="password" id="passwordInput" style="width:100%;padding:12px;font-size:16px;text-align:center;letter-spacing:4px;border:2px solid var(--border);border-radius:8px;background:var(--bg-light)" placeholder="****" maxlength="10">
                    <p id="passwordError" style="color:var(--error);font-size:12px;text-align:center;margin-top:8px;display:none">Clave incorrecta</p>
                    <button id="passwordBtn" style="width:100%;margin-top:12px;padding:14px;background:var(--primary);color:white;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer">Ingresar</button>
                    <div class="back-link" id="backFromPassword">‚Üê Cambiar</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MENU -->
    <div id="menuScreen" class="screen">
        <div class="header">
            <div class="header-logo"><div class="logo-icon">PT</div><span>PT Control</span></div>
            <div class="user-pill" id="logoutBtn"><span id="currentUserName">Usuario</span> ‚ñº</div>
        </div>
        <div class="menu-container">
            <div class="welcome-banner">
                <h2 id="welcomeTitle">Bienvenido</h2>
                <p id="welcomeRole">Sistema de control PT</p>
                <div class="stats-row">
                    <div class="stat-box"><div class="value" id="statToday">0</div><div class="label">Hoy</div></div>
                    <div class="stat-box"><div class="value" id="statPending">0</div><div class="label">Pendientes</div></div>
                    <div class="stat-box"><div class="value" id="statTotal">0</div><div class="label">Total</div></div>
                </div>
            </div>
            
            <div id="operationsSection">
                <div class="section-title">Operaciones</div>
                <div class="menu-grid">
                    <div class="menu-card recepcion" id="menuRecepcion"><div class="menu-icon">üì•</div><div class="menu-title">Recepci√≥n</div><div class="menu-desc">Entrada de equipos</div></div>
                    <div class="menu-card acomodo" id="menuAcomodo"><div class="menu-icon">üìç</div><div class="menu-title">Acomodo</div><div class="menu-desc">Asignar ubicaci√≥n</div></div>
                    <div class="menu-card traspaso" id="menuTraspaso"><div class="menu-icon">üîÑ</div><div class="menu-title">Traspaso</div><div class="menu-desc">Mover a bodega</div></div>
                    <div class="menu-card embarque" id="menuEmbarque"><div class="menu-icon">üì§</div><div class="menu-title">Embarque</div><div class="menu-desc">Salida de equipos</div></div>
                </div>
            </div>
            
            <div id="consultasSection">
                <div class="section-title">Consultas</div>
                <div class="menu-grid">
                    <div class="menu-card consulta" id="menuConsulta"><div class="menu-icon">üîç</div><div class="menu-title">Buscar</div><div class="menu-desc">Serie o ubicaci√≥n</div></div>
                    <div class="menu-card historial" id="menuHistorial"><div class="menu-icon">üìã</div><div class="menu-title">Historial</div><div class="menu-desc">Todos los movimientos</div></div>
                    <div class="menu-card mis-movs" id="menuMisMovs"><div class="menu-icon">‚úèÔ∏è</div><div class="menu-title">Mis Movimientos</div><div class="menu-desc">Editar/Eliminar</div></div>
                    <div class="menu-card export" id="menuExport"><div class="menu-icon">üìä</div><div class="menu-title">Exportar</div><div class="menu-desc">Descargar Excel</div></div>
                    <div class="menu-card traspaso" id="menuPendientes"><div class="menu-icon">‚è≥</div><div class="menu-title">Pendientes</div><div class="menu-desc">Sin acomodar</div></div>
                </div>
            </div>
            
            <div id="calidadSection" class="hidden">
                <div class="section-title">Calidad</div>
                <div class="menu-grid">
                    <div class="menu-card recepcion" id="menuCalidadSalidas"><div class="menu-icon">‚úÖ</div><div class="menu-title">Calidad Salidas</div><div class="menu-desc">Verificar embarques</div></div>
                    <div class="menu-card embarque" id="menuIncidencias"><div class="menu-icon">‚ö†Ô∏è</div><div class="menu-title">Incidencias</div><div class="menu-desc">Reportar problemas</div></div>
                </div>
            </div>
            
            <div id="adminSection" class="hidden">
                <div class="section-title">Administracion</div>
                <div class="menu-grid">
                    <div class="menu-card recepcion" id="menuDashboard"><div class="menu-icon">üìà</div><div class="menu-title">Dashboard</div><div class="menu-desc">Resumen diario</div></div>
                    <div class="menu-card consulta" id="menuAuditSample"><div class="menu-icon">üéØ</div><div class="menu-title">Muestreo</div><div class="menu-desc">Verificar fisico</div></div>
                    <div class="menu-card historial" id="menuMetric"><div class="menu-icon">üìä</div><div class="menu-title">Metrico</div><div class="menu-desc">Confiabilidad</div></div>
                    <div class="menu-card acomodo" id="menuCargaMasiva"><div class="menu-icon">üì§</div><div class="menu-title">Carga Masiva</div><div class="menu-desc">Subir inventario</div></div>
                    <div class="menu-card traspaso" id="menuVerIncidencias"><div class="menu-icon">üìù</div><div class="menu-title">Incidencias Calidad</div><div class="menu-desc">Ver reportes</div></div>
                    <div class="menu-card embarque" id="menuVerCalidadSalidas"><div class="menu-icon">‚úÖ</div><div class="menu-title">Resultado Calidad</div><div class="menu-desc">Diferencias salidas</div></div>
                </div>
            </div>
            
            <div id="reparacionesSection" class="hidden">
                <div class="section-title">Reparaciones</div>
                <div class="menu-grid">
                    <div class="menu-card recepcion" id="menuLiberarReparacion"><div class="menu-icon">üîß</div><div class="menu-title">Liberar Equipo</div><div class="menu-desc">Enviar a PT</div></div>
                    <div class="menu-card historial" id="menuHistorialReparaciones"><div class="menu-icon">üìã</div><div class="menu-title">Historial</div><div class="menu-desc">Mis liberaciones</div></div>
                </div>
            </div>
            
            <div id="supervisorSection" class="hidden">
                <div class="section-title">Control Interno</div>
                <div class="menu-grid">
                    <div class="menu-card acomodo" id="menuMuestreoInterno"><div class="menu-icon">üîé</div><div class="menu-title">Muestreo Interno</div><div class="menu-desc">Verificaci√≥n propia</div></div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- DASHBOARD -->
    <div id="dashboardScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backDashboard">‚Üê</button><h2 class="scanner-title">üìà Dashboard</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="margin-bottom:14px">
                <div class="config-row">
                    <span class="config-label">Fecha:</span>
                    <input type="date" class="form-input" id="dashboardDate">
                    <button class="lock-btn" id="applyDashboardDate">Ver</button>
                </div>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
                <div class="config-card" style="text-align:center;background:var(--success-bg)">
                    <div style="font-size:11px;color:var(--success);font-weight:600">üì• RECEPCIONES</div>
                    <div id="dashRecepcion" style="font-size:32px;font-weight:800;color:var(--success)">0</div>
                </div>
                <div class="config-card" style="text-align:center;background:var(--info-bg)">
                    <div style="font-size:11px;color:var(--info);font-weight:600">üìç ACOMODOS</div>
                    <div id="dashAcomodo" style="font-size:32px;font-weight:800;color:var(--info)">0</div>
                </div>
                <div class="config-card" style="text-align:center;background:var(--warning-bg)">
                    <div style="font-size:11px;color:#92400e;font-weight:600">üîÑ TRASPASOS</div>
                    <div id="dashTraspaso" style="font-size:32px;font-weight:800;color:#92400e">0</div>
                </div>
                <div class="config-card" style="text-align:center;background:var(--error-bg)">
                    <div style="font-size:11px;color:var(--error);font-weight:600">üì§ EMBARQUES</div>
                    <div id="dashEmbarque" style="font-size:32px;font-weight:800;color:var(--error)">0</div>
                </div>
            </div>
            
            <div class="config-card" style="text-align:center;background:linear-gradient(135deg,var(--primary),#0065FF)">
                <div style="font-size:12px;color:rgba(255,255,255,0.8);font-weight:600">TOTAL MOVIMIENTOS</div>
                <div id="dashTotal" style="font-size:40px;font-weight:800;color:white">0</div>
            </div>
            
            <div class="config-card" style="margin-top:14px">
                <h4 style="font-size:12px;margin-bottom:10px">Acumulado General</h4>
                <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
                    <span>Total Recepciones:</span><strong id="dashTotalRecepcion">0</strong>
                </div>
                <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
                    <span>Total Acomodos:</span><strong id="dashTotalAcomodo">0</strong>
                </div>
                <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
                    <span>Total Traspasos:</span><strong id="dashTotalTraspaso">0</strong>
                </div>
                <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
                    <span>Total Embarques:</span><strong id="dashTotalEmbarque">0</strong>
                </div>
                <div style="display:flex;justify-content:space-between;padding:6px 0;font-size:12px;font-weight:700;color:var(--primary)">
                    <span>TOTAL GENERAL:</span><strong id="dashTotalGeneral">0</strong>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CARGA MASIVA -->
    <div id="cargaMasivaScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backCargaMasiva">‚Üê</button><h2 class="scanner-title">üì§ Carga Masiva</h2></div>
        <div class="scanner-body">
            <div class="config-card">
                <h4 style="margin-bottom:8px">Subir Inventario General</h4>
                <p style="font-size:12px;color:var(--text-light);margin-bottom:12px">Sube un archivo Excel (.xlsx) con las series y ubicaciones. Se registrar√°n como "Captura General".</p>
                
                <div style="background:var(--info-bg);border-radius:8px;padding:12px;margin-bottom:14px">
                    <p style="font-size:11px;color:var(--info);font-weight:600;margin-bottom:6px">üìã Formato del archivo Excel:</p>
                    <table style="width:100%;font-size:10px;border-collapse:collapse;margin-top:6px">
                        <tr style="background:rgba(0,101,255,0.1)">
                            <th style="padding:4px;border:1px solid var(--info);text-align:left">SERIE</th>
                            <th style="padding:4px;border:1px solid var(--info);text-align:left">UBICACION</th>
                            <th style="padding:4px;border:1px solid var(--info);text-align:left">FECHA ACTUALIZACION</th>
                        </tr>
                        <tr>
                            <td style="padding:4px;border:1px solid var(--border);font-family:monospace">5208-070225310</td>
                            <td style="padding:4px;border:1px solid var(--border)">RACK1-EST1-A-01</td>
                            <td style="padding:4px;border:1px solid var(--border)">10/01/2026</td>
                        </tr>
                        <tr>
                            <td style="padding:4px;border:1px solid var(--border);font-family:monospace">070225311</td>
                            <td style="padding:4px;border:1px solid var(--border)">RACK2-EST1-B-05</td>
                            <td style="padding:4px;border:1px solid var(--border)">10/01/2026</td>
                        </tr>
                    </table>
                    <p style="font-size:10px;color:var(--text-light);margin-top:6px">* Acepta c√≥digo completo o solo serie de 8-9 d√≠gitos</p>
                </div>
                
                <input type="file" id="xlsxFileInput" accept=".xlsx,.xls" style="display:none">
                <button class="btn btn-primary" id="selectFileBtn">üìÅ Seleccionar Archivo Excel</button>
                
                <div id="fileInfo" class="hidden" style="margin-top:14px;padding:12px;background:var(--bg-light);border-radius:8px">
                    <p style="font-size:12px"><strong>Archivo:</strong> <span id="fileName">-</span></p>
                    <p style="font-size:12px"><strong>Series detectadas:</strong> <span id="seriesCount">0</span></p>
                </div>
            </div>
            
            <div id="previewSection" class="hidden">
                <div class="config-card">
                    <h4 style="margin-bottom:8px">Vista Previa (primeras 10)</h4>
                    <div id="previewList" style="max-height:200px;overflow-y:auto"></div>
                </div>
                
                <div style="background:var(--warning-bg);border-radius:8px;padding:12px;margin-bottom:14px">
                    <p style="font-size:11px;color:#92400e">‚ö†Ô∏è Esta acci√≥n registrar√° todas las series como "Captura General". Los movimientos existentes NO se borrar√°n.</p>
                </div>
                
                <button class="btn btn-success" id="processFileBtn">‚úì Procesar <span id="processCount">0</span> series</button>
            </div>
            
            <div id="progressSection" class="hidden" style="margin-top:14px">
                <div class="config-card" style="text-align:center">
                    <p style="font-size:14px;font-weight:700;margin-bottom:8px">Procesando...</p>
                    <div style="height:8px;background:var(--bg-light);border-radius:4px;overflow:hidden">
                        <div id="progressBar" style="height:100%;width:0%;background:var(--success);border-radius:4px;transition:width 0.3s"></div>
                    </div>
                    <p style="font-size:12px;color:var(--text-light);margin-top:8px"><span id="progressText">0</span> de <span id="progressTotal">0</span></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AUDIT SAMPLE -->
    <div id="auditSampleScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backAuditSample">‚Üê</button><h2 class="scanner-title">üéØ Muestreo</h2></div>
        <div class="scanner-body">
            <div class="config-card">
                <h4 style="margin-bottom:8px">Verificacion Fisica</h4>
                <p style="font-size:12px;color:var(--text-light)">15% recepciones de ayer + 3 con acomodo</p>
                <div style="display:flex;gap:12px;margin-top:12px">
                    <div style="background:var(--bg-light);padding:8px 12px;border-radius:8px;font-size:11px">Fecha: <strong id="auditDate">--</strong></div>
                    <div style="background:var(--bg-light);padding:8px 12px;border-radius:8px;font-size:11px">Series: <strong id="auditSampleSize">0</strong></div>
                </div>
            </div>
            <div id="auditSampleList" style="margin-bottom:14px"></div>
            <button class="btn btn-primary" id="generateSampleBtn">üé≤ Generar Muestra</button>
            <button class="btn btn-success mt-14 hidden" id="finishAuditBtn">‚úì Finalizar Auditoria</button>
        </div>
    </div>
    
    <!-- METRIC -->
    <div id="metricScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backMetric">‚Üê</button><h2 class="scanner-title">üìä Metrico</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="text-align:center">
                <p style="font-size:12px;color:var(--text-light)">Indice de Confiabilidad</p>
                <div id="metricValue" style="font-size:48px;font-weight:800;margin:10px 0;color:var(--success)">--%</div>
                <div style="height:8px;background:var(--bg-light);border-radius:4px;overflow:hidden"><div id="metricBar" style="height:100%;width:0%;background:var(--success);border-radius:4px"></div></div>
                <p id="metricDetail" style="font-size:12px;color:var(--text-light);margin-top:8px">Sin datos</p>
            </div>
            <div class="config-card">
                <h4 style="font-size:12px;margin-bottom:8px">Escala</h4>
                <p style="font-size:11px;color:var(--success)">üü¢ 90-100%: Excelente</p>
                <p style="font-size:11px;color:var(--warning)">üü° 80-89%: Aceptable</p>
                <p style="font-size:11px;color:var(--error)">üî¥ &lt;80%: Critico</p>
            </div>
            <div class="config-card">
                <h4 style="font-size:12px;margin-bottom:8px">Historial</h4>
                <div id="auditHistoryList"></div>
            </div>
        </div>
    </div>

    <!-- RECEPCION -->
    <div id="recepcionScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backRecepcion">‚Üê</button><h2 class="scanner-title">üì• Recepci√≥n</h2></div>
        <div class="scanner-body">
            <div class="config-card">
                <div class="config-row">
                    <span class="config-label">Bodega:</span>
                    <select class="config-select" id="recepcionBodega"><option value="B3">B3</option><option value="B5">B5</option><option value="B6" selected>B6</option><option value="B7">B7</option></select>
                    <button class="lock-btn" id="recepcionLockBtn">üîì Fijar</button>
                </div>
            </div>
            <div class="input-tabs"><div class="input-tab active" id="recepcionTabScan">üì∑ Escanear</div><div class="input-tab" id="recepcionTabManual">‚å®Ô∏è Manual</div></div>
            <div id="recepcionScanView"><div class="scanner-box"><div class="scanner-region" id="recepcion-scanner"></div><div class="scan-status"><div class="dot"></div><span>Escanea c√≥digos de barras</span></div></div></div>
            <div id="recepcionManualView" class="hidden"><div class="form-group"><label>C√≥digo del equipo</label><input type="text" class="form-input" id="recepcionManualInput" placeholder="Ej: 5208-070225310"></div><button class="btn btn-primary" id="recepcionAddBtn">+ Agregar</button></div>
            <div id="recepcionDuplicateAlert" class="alert-box hidden">‚ö†Ô∏è Este equipo ya existe en otra ubicaci√≥n</div>
            <div class="scanned-list mt-14"><div class="scanned-list-header"><h4>Equipos escaneados</h4><span class="scanned-count" id="recepcionCount">0</span></div><div class="scanned-items" id="recepcionItems"><div class="empty-list">Escanea equipos para agregarlos</div></div></div>
            <button class="btn btn-success" id="recepcionConfirmBtn" disabled>‚úì Confirmar Recepci√≥n</button>
        </div>
    </div>

    <!-- ACOMODO -->
    <div id="acomodoScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backAcomodo">‚Üê</button><h2 class="scanner-title">üìç Acomodo</h2></div>
        <div class="scanner-body">
            <div class="config-card">
                <p style="font-size:11px;color:var(--text-light);margin-bottom:10px">1. Escribe/escanea ubicaci√≥n ‚Üí 2. Escanea serie ‚Üí 3. Click "Agregar"</p>
                <div class="form-group" style="margin-bottom:10px">
                    <label>Ubicaci√≥n</label>
                    <div class="config-row">
                        <div class="location-dropdown"><input type="text" class="form-input" id="acomodoLocation" placeholder="Escribe o escanea QR"><div class="suggestions" id="locationSuggestions"></div></div>
                        <button class="lock-btn" id="scanLocationQRBtn">üì∑ QR</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Serie del equipo</label>
                    <div class="config-row">
                        <input type="text" class="form-input" id="acomodoSerieInput" placeholder="Escanea o escribe serie">
                        <button class="lock-btn" id="acomodoScanSerieBtn">üì∑</button>
                    </div>
                </div>
                <button class="btn btn-primary mt-14" id="acomodoAgregarBtn">+ Agregar a lista</button>
            </div>
            <div id="acomodoDuplicateAlert" class="alert-box hidden">‚ö†Ô∏è Este equipo ya existe en otra ubicaci√≥n</div>
            <div class="scanned-list mt-14"><div class="scanned-list-header"><h4>Equipos a acomodar</h4><span class="scanned-count" id="acomodoCount">0</span></div><div class="scanned-items" id="acomodoItems"><div class="empty-list">Agrega equipos con su ubicaci√≥n</div></div></div>
            <button class="btn btn-success" id="acomodoConfirmBtn" disabled>‚úì Confirmar Acomodo</button>
        </div>
    </div>

    <!-- TRASPASO -->
    <div id="traspasoScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backTraspaso">‚Üê</button><h2 class="scanner-title">üîÑ Traspaso</h2></div>
        <div class="scanner-body">
            <div class="config-card">
                <div class="config-row"><span class="config-label">Destino:</span><select class="config-select" id="traspasoBodega"><option value="B3">B3</option><option value="B5">B5</option><option value="B6">B6</option><option value="B7">B7</option></select><button class="lock-btn" id="traspasoLockBtn">üîì Fijar</button></div>
                <div class="config-row"><span class="config-label">Solicit√≥:</span><input type="text" class="form-input" id="traspasoSolicitante" placeholder="Nombre"><button class="lock-btn" id="traspasoSolicitanteLockBtn">üîì</button></div>
                <div class="config-row"><span class="config-label">Motivo:</span><input type="text" class="form-input" id="traspasoMotivo" placeholder="Motivo del traspaso"><button class="lock-btn" id="traspasoMotivoLockBtn">üîì</button></div>
            </div>
            <div class="input-tabs"><div class="input-tab active" id="traspasoTabScan">üì∑ Escanear</div><div class="input-tab" id="traspasoTabManual">‚å®Ô∏è Manual</div></div>
            <div id="traspasoScanView"><div class="scanner-box"><div class="scanner-region" id="traspaso-scanner"></div><div class="scan-status"><div class="dot"></div><span>Escanea c√≥digos de barras</span></div></div></div>
            <div id="traspasoManualView" class="hidden"><div class="form-group"><label>C√≥digo del equipo</label><input type="text" class="form-input" id="traspasoManualInput" placeholder="Ej: 5208-070225310"></div><button class="btn btn-primary" id="traspasoAddBtn">+ Agregar</button></div>
            <div class="scanned-list mt-14"><div class="scanned-list-header"><h4>Equipos a traspasar</h4><span class="scanned-count" id="traspasoCount">0</span></div><div class="scanned-items" id="traspasoItems"><div class="empty-list">Escanea equipos para agregarlos</div></div></div>
            <button class="btn btn-success" id="traspasoConfirmBtn" disabled>‚úì Confirmar Traspaso</button>
        </div>
    </div>

    <!-- EMBARQUE -->
    <div id="embarqueScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backEmbarque">‚Üê</button><h2 class="scanner-title">üì§ Embarque</h2></div>
        <div class="scanner-body">
            <div class="config-card">
                <div class="config-row"><span class="config-label">Tipo salida:</span><select class="config-select" id="embarqueTipoSalida"><option value="">Cliente</option><option value="vallejo">Vallejo</option><option value="traslado">Traslado</option></select></div>
                <div class="config-row"><span class="config-label">Referencia:</span><input type="text" class="form-input" id="embarqueReferencia" placeholder="Pedido / Folio"><button class="lock-btn" id="embarqueLockBtn">üîì Fijar</button></div>
            </div>
            <div class="input-tabs"><div class="input-tab active" id="embarqueTabScan">üì∑ Escanear</div><div class="input-tab" id="embarqueTabManual">‚å®Ô∏è Manual</div></div>
            <div id="embarqueScanView"><div class="scanner-box"><div class="scanner-region" id="embarque-scanner"></div><div class="scan-status"><div class="dot"></div><span>Escanea equipos para embarcar</span></div></div></div>
            <div id="embarqueManualView" class="hidden"><div class="form-group"><label>C√≥digo del equipo</label><input type="text" class="form-input" id="embarqueManualInput" placeholder="Ej: 5208-070225310"></div><button class="btn btn-primary" id="embarqueAddBtn">+ Agregar</button></div>
            <div class="scanned-list mt-14"><div class="scanned-list-header"><h4>Equipos a embarcar</h4><span class="scanned-count" id="embarqueCount">0</span></div><div class="scanned-items" id="embarqueItems"><div class="empty-list">Escanea equipos para embarcar</div></div></div>
            <button class="btn btn-success" id="embarqueConfirmBtn" disabled>‚úì Confirmar Embarque</button>
        </div>
    </div>

    <!-- CONSULTA -->
    <div id="consultaScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backConsulta">‚Üê</button><h2 class="scanner-title">üîç Buscar</h2></div>
        <div class="scanner-body">
            <div class="search-card">
                <div class="config-row" style="margin-bottom:10px">
                    <span class="config-label">Buscar por:</span>
                    <select class="config-select" id="consultaTipo">
                        <option value="serie">Serie</option>
                        <option value="ubicacion">Ubicaci√≥n</option>
                    </select>
                </div>
                <div class="search-row"><input type="text" class="form-input" id="consultaInput" placeholder="Escribe serie o ubicaci√≥n..."><button class="search-btn" id="searchBtn">üîç</button></div>
            </div>
            <div id="consultaResults"><div class="empty-state"><p>Busca por c√≥digo de serie (con o sin prefijo) o por ubicaci√≥n (ej: RACK1)</p></div></div>
        </div>
    </div>
    
    <!-- PENDIENTES -->
    <div id="pendientesScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backPendientes">‚Üê</button><h2 class="scanner-title">‚è≥ Pendientes</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="margin-bottom:14px">
                <div class="config-row">
                    <input type="text" class="form-input" id="pendientesSearch" placeholder="Buscar serie...">
                </div>
                <div class="config-row">
                    <span class="config-label">Fecha:</span>
                    <input type="date" class="form-input" id="pendientesDate">
                </div>
                <div class="config-row">
                    <span class="config-label">Ordenar:</span>
                    <select class="config-select" id="pendientesSort">
                        <option value="fecha-desc">M√°s reciente</option>
                        <option value="fecha-asc">M√°s antiguo</option>
                        <option value="serie-asc">Serie A-Z</option>
                        <option value="serie-desc">Serie Z-A</option>
                    </select>
                </div>
                <button class="btn btn-primary mt-14" id="applyPendientesFilter">Aplicar</button>
            </div>
            <div id="pendientesList"></div>
        </div>
    </div>
    
    <!-- EXPORTAR -->
    <div id="exportScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backExport">‚Üê</button><h2 class="scanner-title">üìä Exportar Reportes</h2></div>
        <div class="scanner-body">
            <p style="font-size:12px;color:var(--text-light);margin-bottom:14px">Selecciona el reporte a descargar</p>
            
            <!-- MOVIMIENTOS CON FILTRO -->
            <div class="config-card" style="cursor:pointer" id="exportMovsBtn">
                <div style="display:flex;align-items:center;gap:12px">
                    <div style="width:44px;height:44px;background:var(--success-bg);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px">üìÖ</div>
                    <div>
                        <div style="font-weight:700;font-size:14px">Movimientos</div>
                        <div style="font-size:11px;color:var(--text-light)">Filtrar por rango de fechas</div>
                    </div>
                </div>
            </div>
            
            <!-- PENDIENTES CON FILTRO -->
            <div class="config-card" style="cursor:pointer;margin-top:10px" id="exportPendientesBtn">
                <div style="display:flex;align-items:center;gap:12px">
                    <div style="width:44px;height:44px;background:var(--warning-bg);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px">‚è≥</div>
                    <div>
                        <div style="font-weight:700;font-size:14px">Pendientes de Acomodo</div>
                        <div style="font-size:11px;color:var(--text-light)">Filtrar por rango de fechas</div>
                    </div>
                </div>
            </div>
            
            <!-- INVENTARIO CON FILTRO -->
            <div class="config-card" style="cursor:pointer;margin-top:10px" id="exportInventarioBtn">
                <div style="display:flex;align-items:center;gap:12px">
                    <div style="width:44px;height:44px;background:var(--info-bg);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px">üì¶</div>
                    <div>
                        <div style="font-weight:700;font-size:14px">Inventario</div>
                        <div style="font-size:11px;color:var(--text-light)">Actual o de d√≠as anteriores</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
                <div style="font-size:12px;font-weight:700;color:var(--text-light);margin-bottom:12px">REPORTES ADICIONALES</div>
                
                <div class="config-card" style="cursor:pointer" id="exportEmbarquesBtn2">
                    <div style="display:flex;align-items:center;gap:12px">
                        <div style="width:44px;height:44px;background:#e8f4fd;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px">üì§</div>
                        <div>
                            <div style="font-weight:700;font-size:14px">Embarques</div>
                            <div style="font-size:11px;color:var(--text-light)">Filtrar por fechas</div>
                        </div>
                    </div>
                </div>
                
                <div class="config-card" style="cursor:pointer;margin-top:10px" id="exportIncidenciasBtn2">
                    <div style="display:flex;align-items:center;gap:12px">
                        <div style="width:44px;height:44px;background:var(--warning-bg);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px">‚ö†Ô∏è</div>
                        <div>
                            <div style="font-weight:700;font-size:14px">Incidencias Calidad</div>
                            <div style="font-size:11px;color:var(--text-light)">Filtrar por fechas</div>
                        </div>
                    </div>
                </div>
                
                <div class="config-card" style="cursor:pointer;margin-top:10px" id="exportCalidadSalidasBtn2">
                    <div style="display:flex;align-items:center;gap:12px">
                        <div style="width:44px;height:44px;background:var(--success-bg);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px">‚úÖ</div>
                        <div>
                            <div style="font-weight:700;font-size:14px">Calidad Salidas</div>
                            <div style="font-size:11px;color:var(--text-light)">Resultados de verificaci√≥n</div>
                        </div>
                    </div>
                </div>
                
                <div class="config-card" style="cursor:pointer;margin-top:10px" id="exportMuestreosBtn2">
                    <div style="display:flex;align-items:center;gap:12px">
                        <div style="width:44px;height:44px;background:#f3e8ff;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px">üéØ</div>
                        <div>
                            <div style="font-weight:700;font-size:14px">Muestreos Auditor√≠a</div>
                            <div style="font-size:11px;color:var(--text-light)">Historial de verificaciones</div>
                        </div>
                    </div>
                </div>
                
                <div class="config-card" style="cursor:pointer;margin-top:10px" id="exportRecepcionesBtn">
                    <div style="display:flex;align-items:center;gap:12px">
                        <div style="width:44px;height:44px;background:var(--success-bg);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px">üì•</div>
                        <div>
                            <div style="font-weight:700;font-size:14px">Recepciones</div>
                            <div style="font-size:11px;color:var(--text-light)">Filtrar por fechas</div>
                        </div>
                    </div>
                </div>
                
                <div class="config-card" style="cursor:pointer;margin-top:10px" id="exportReparacionesBtn">
                    <div style="display:flex;align-items:center;gap:12px">
                        <div style="width:44px;height:44px;background:#fef3c7;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px">üîß</div>
                        <div>
                            <div style="font-weight:700;font-size:14px">Reparaciones</div>
                            <div style="font-size:11px;color:var(--text-light)">Equipos liberados</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
                <div style="font-size:12px;font-weight:700;color:var(--error);margin-bottom:12px">‚ö†Ô∏è ALERTAS</div>
                
                <div class="config-card" style="cursor:pointer;border-left:4px solid var(--warning)" id="exportAlertasBtn">
                    <div style="display:flex;align-items:center;gap:12px">
                        <div style="width:44px;height:44px;background:var(--warning-bg);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px">üîî</div>
                        <div>
                            <div style="font-weight:700;font-size:14px">Sin Movimiento >30 d√≠as</div>
                            <div style="font-size:11px;color:var(--text-light)">Equipos estancados</div>
                        </div>
                    </div>
                </div>
                
                <div class="config-card" style="cursor:pointer;margin-top:10px;border-left:4px solid var(--error)" id="exportObsolescenciaBtn">
                    <div style="display:flex;align-items:center;gap:12px">
                        <div style="width:44px;height:44px;background:var(--error-bg);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px">üö®</div>
                        <div>
                            <div style="font-weight:700;font-size:14px">Obsolescencia >90 d√≠as</div>
                            <div style="font-size:11px;color:var(--text-light)">Sin embarcar</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- HISTORIAL -->
    <div id="historialScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backHistorial">‚Üê</button><h2 class="scanner-title">üìã Historial</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="margin-bottom:14px">
                <div class="config-row">
                    <span class="config-label">Desde:</span>
                    <input type="date" class="form-input" id="historyDateFrom">
                </div>
                <div class="config-row">
                    <span class="config-label">Hasta:</span>
                    <input type="date" class="form-input" id="historyDateTo">
                </div>
                <div class="config-row">
                    <span class="config-label">Serie:</span>
                    <input type="text" class="form-input" id="historySerieFilter" placeholder="Filtrar por serie...">
                </div>
                <button class="btn btn-primary mt-14" id="applyHistoryFilters">Aplicar Filtros</button>
            </div>
            <div class="history-filters" id="historyFilters">
                <div class="filter-chip active" data-filter="all">Todos</div>
                <div class="filter-chip" data-filter="recepcion">Recepci√≥n</div>
                <div class="filter-chip" data-filter="acomodo">Acomodo</div>
                <div class="filter-chip" data-filter="traspaso">Traspaso</div>
                <div class="filter-chip" data-filter="embarque">Embarque</div>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>
    </div>

    <!-- MIS MOVIMIENTOS -->
    <div id="misMovimientosScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backMisMovs">‚Üê</button><h2 class="scanner-title">‚úèÔ∏è Mis Movimientos</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="margin-bottom:14px">
                <div class="config-row">
                    <input type="text" class="form-input" id="misMovsSearch" placeholder="Buscar serie...">
                    <button class="lock-btn" id="scanMisMovsQR">üì∑</button>
                </div>
            </div>
            <p style="font-size:11px;color:var(--text-light);margin-bottom:10px">Puedes editar o eliminar tus movimientos</p>
            <div class="history-list" id="myMovsList"></div>
        </div>
    </div>
    
    <!-- EDIT MODAL -->
    <div id="editModal" class="qr-modal">
        <div class="scanner-header" style="background:var(--primary);border:none">
            <button class="back-btn" id="closeEditModal" style="background:rgba(255,255,255,0.2);color:white">√ó</button>
            <h2 class="scanner-title" style="color:white">Editar Movimiento</h2>
        </div>
        <div style="padding:20px;background:var(--bg-light);flex:1;overflow-y:auto">
            <div class="config-card">
                <div class="form-group">
                    <label>C√≥digo</label>
                    <input type="text" class="form-input" id="editCodigo" readonly style="background:#e9ecef">
                </div>
                <div class="form-group">
                    <label>Tipo</label>
                    <input type="text" class="form-input" id="editTipo" readonly style="background:#e9ecef">
                </div>
                <div class="form-group" id="editUbicacionGroup">
                    <label>Ubicaci√≥n</label>
                    <input type="text" class="form-input" id="editUbicacion" placeholder="Nueva ubicaci√≥n">
                </div>
                <div class="form-group" id="editBodegaGroup">
                    <label>Bodega</label>
                    <select class="config-select" id="editBodega">
                        <option value="B3">B3</option>
                        <option value="B5">B5</option>
                        <option value="B6">B6</option>
                        <option value="B7">B7</option>
                    </select>
                </div>
                <div class="form-group" id="editReferenciaGroup">
                    <label>Referencia</label>
                    <input type="text" class="form-input" id="editReferencia" placeholder="Referencia">
                </div>
                <input type="hidden" id="editMovId">
                <button class="btn btn-success mt-14" id="saveEditBtn">üíæ Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <!-- MIS MOVS QR MODAL -->
    <div id="misMovsQRModal" class="qr-modal">
        <div class="scanner-header" style="background:transparent;border:none">
            <button class="back-btn" id="closeMisMovsQR" style="background:rgba(255,255,255,0.2);color:white">‚Üê</button>
            <h2 class="scanner-title" style="color:white">Escanear Serie</h2>
        </div>
        <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:20px">
            <div class="scanner-box" style="width:100%;max-width:400px">
                <div class="scanner-region" id="mis-movs-qr-scanner"></div>
            </div>
        </div>
    </div>

    <!-- QR MODAL -->
    <div id="locationQRModal" class="qr-modal">
        <div class="scanner-header" style="background:transparent;border:none"><button class="back-btn" id="closeQRModal" style="background:rgba(255,255,255,0.2);color:white">‚Üê</button><h2 class="scanner-title" style="color:white">Escanear QR Ubicaci√≥n</h2></div>
        <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:20px"><div class="scanner-box" style="width:100%;max-width:400px"><div class="scanner-region" id="location-qr-scanner"></div></div></div>
    </div>

    <!-- CALIDAD SALIDAS -->
    <div id="calidadSalidasScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backCalidadSalidas">‚Üê</button><h2 class="scanner-title">‚úÖ Calidad Salidas</h2></div>
        <div class="scanner-body">
            <div class="config-card">
                <div class="config-row"><span class="config-label">Fecha:</span><input type="date" class="form-input" id="calidadFecha"><button class="lock-btn" id="calidadFechaLockBtn">üîì Fijar</button></div>
            </div>
            <div class="input-tabs"><div class="input-tab active" id="calidadTabScan">üì∑ Escanear</div><div class="input-tab" id="calidadTabManual">‚å®Ô∏è Manual</div></div>
            <div id="calidadScanView"><div class="scanner-box"><div class="scanner-region" id="calidad-scanner"></div><div class="scan-status"><div class="dot"></div><span>Escanea c√≥digos de hojas impresas</span></div></div></div>
            <div id="calidadManualView" class="hidden"><div class="form-group"><label>C√≥digo del equipo</label><input type="text" class="form-input" id="calidadManualInput" placeholder="Ej: 5208-070225310"></div><button class="btn btn-primary" id="calidadAddBtn">+ Agregar</button></div>
            <div class="scanned-list mt-14"><div class="scanned-list-header"><h4>Series escaneadas</h4><span class="scanned-count" id="calidadCount">0</span></div><div class="scanned-items" id="calidadItems"><div class="empty-list">Escanea series de hojas impresas</div></div></div>
            <button class="btn btn-primary" id="calidadCompararBtn" disabled>üîç Comparar con Embarques</button>
            <div id="calidadResultados" class="hidden" style="margin-top:14px">
                <div class="config-card" style="background:var(--success-bg)"><div style="font-weight:700;color:var(--success)">‚úÖ Coinciden: <span id="calidadCoinciden">0</span></div></div>
                <div class="config-card" style="background:var(--warning-bg)"><div style="font-weight:700;color:#92400e">‚ö†Ô∏è En hojas pero NO en sistema: <span id="calidadSoloHojas">0</span></div><div id="calidadSoloHojasList" style="font-size:11px;margin-top:6px"></div></div>
                <div class="config-card" style="background:var(--error-bg)"><div style="font-weight:700;color:var(--error)">‚ùå En sistema pero NO en hojas: <span id="calidadSoloSistema">0</span></div><div id="calidadSoloSistemaList" style="font-size:11px;margin-top:6px"></div></div>
                <button class="btn btn-success mt-14" id="calidadExportarBtn">üìä Exportar Reporte</button>
            </div>
        </div>
    </div>

    <!-- INCIDENCIAS -->
    <div id="incidenciasScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backIncidencias">‚Üê</button><h2 class="scanner-title">‚ö†Ô∏è Reportar Incidencia</h2></div>
        <div class="scanner-body">
            <div class="config-card">
                <div class="form-group">
                    <label>Serie del equipo</label>
                    <div class="config-row"><input type="text" class="form-input" id="incidenciaSerie" placeholder="Escanea o escribe la serie"><button class="lock-btn" id="incidenciaScanBtn">üì∑</button></div>
                </div>
                <div class="form-group">
                    <label>Tipo de incidencia</label>
                    <select class="config-select" id="incidenciaTipo">
                        <option value="">Selecciona...</option>
                        <option value="caida">Ca√≠da de equipo</option>
                        <option value="caja">Cambio de caja</option>
                        <option value="serie">Cambio de serie</option>
                        <option value="danio">Da√±o f√≠sico</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea class="form-input" id="incidenciaDescripcion" rows="3" placeholder="Describe el problema..."></textarea>
                </div>
                <div class="form-group">
                    <label>Reporta a</label>
                    <input type="text" class="form-input" id="incidenciaReportaA" placeholder="Nombre de quien recibe el reporte">
                </div>
                <button class="btn btn-success" id="incidenciaGuardarBtn">üíæ Guardar Incidencia</button>
            </div>
            <div style="margin-top:14px">
                <h4 style="font-size:13px;margin-bottom:10px">Mis incidencias recientes</h4>
                <div id="misIncidenciasList"></div>
            </div>
        </div>
    </div>

    <!-- VER INCIDENCIAS (Auditor√≠a/Supervisor) -->
    <div id="verIncidenciasScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backVerIncidencias">‚Üê</button><h2 class="scanner-title">üìù Ver Incidencias</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="margin-bottom:14px">
                <div class="config-row"><span class="config-label">Desde:</span><input type="date" class="form-input" id="incidenciasDateFrom"></div>
                <div class="config-row"><span class="config-label">Hasta:</span><input type="date" class="form-input" id="incidenciasDateTo"></div>
                <button class="btn btn-primary mt-14" id="filtrarIncidenciasBtn">Filtrar</button>
            </div>
            <div id="todasIncidenciasList"></div>
            <button class="btn btn-success mt-14" id="exportarIncidenciasBtn">üìä Exportar Incidencias</button>
        </div>
    </div>

    <!-- VER CALIDAD SALIDAS (Auditor√≠a/Supervisor) -->
    <div id="verCalidadSalidasScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backVerCalidadSalidas">‚Üê</button><h2 class="scanner-title">üìã Reportes Calidad</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="margin-bottom:14px">
                <div class="config-row"><span class="config-label">Desde:</span><input type="date" class="form-input" id="calidadReportesDateFrom"></div>
                <div class="config-row"><span class="config-label">Hasta:</span><input type="date" class="form-input" id="calidadReportesDateTo"></div>
                <button class="btn btn-primary mt-14" id="filtrarCalidadReportesBtn">Filtrar</button>
            </div>
            <div id="calidadReportesList"></div>
        </div>
    </div>

    <!-- MUESTREO INTERNO (Supervisor) -->
    <div id="muestreoInternoScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backMuestreoInterno">‚Üê</button><h2 class="scanner-title">üîé Muestreo Control Interno</h2></div>
        <div class="scanner-body">
            <div class="config-card">
                <div class="config-row">
                    <span class="config-label">Cantidad:</span>
                    <select class="config-select" id="muestreoInternoCantidad">
                        <option value="5">5 series</option>
                        <option value="10">10 series</option>
                        <option value="15">15 series</option>
                        <option value="20">20 series</option>
                        <option value="30">30 series</option>
                    </select>
                </div>
                <button class="btn btn-primary mt-14" id="generarMuestreoInternoBtn">üé≤ Generar Muestreo</button>
            </div>
            <div id="muestreoInternoLista" class="hidden" style="margin-top:14px"></div>
            <div id="muestreoInternoResultados" class="hidden" style="margin-top:14px">
                <button class="btn btn-success" id="finalizarMuestreoInternoBtn">‚úì Finalizar Muestreo</button>
            </div>
            <div style="margin-top:14px">
                <h4 style="font-size:13px;margin-bottom:10px">Historial de muestreos</h4>
                <div id="historialMuestreoInterno"></div>
            </div>
        </div>
    </div>

    <!-- INCIDENCIA SCAN MODAL -->
    <div id="incidenciaScanModal" class="qr-modal">
        <div class="scanner-header" style="background:transparent;border:none">
            <button class="back-btn" id="closeIncidenciaScan" style="background:rgba(255,255,255,0.2);color:white">‚Üê</button>
            <h2 class="scanner-title" style="color:white">Escanear Serie</h2>
        </div>
        <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:20px">
            <div class="scanner-box" style="width:100%;max-width:400px">
                <div class="scanner-region" id="incidencia-scanner"></div>
            </div>
        </div>
    </div>

    <!-- EXPORTAR EMBARQUES -->
    <div id="exportEmbarquesScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backExportEmbarques">‚Üê</button><h2 class="scanner-title">üì§ Exportar Embarques</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="margin-bottom:14px">
                <div class="config-row"><span class="config-label">Desde:</span><input type="date" class="form-input" id="exportEmbarquesDesde"></div>
                <div class="config-row"><span class="config-label">Hasta:</span><input type="date" class="form-input" id="exportEmbarquesHasta"></div>
                <button class="btn btn-primary mt-14" id="filtrarEmbarquesBtn">üîç Filtrar</button>
            </div>
            <div id="embarquesResumen" class="hidden">
                <div class="config-card" style="background:var(--info-bg);margin-bottom:14px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><strong>Embarques encontrados</strong><br><span style="font-size:11px;color:var(--text-light)" id="embarquesRangoFechas"></span></div>
                        <div style="font-size:28px;font-weight:800;color:var(--info)" id="embarquesTotal">0</div>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">
                    <div class="config-card" style="text-align:center;padding:10px"><div style="font-size:11px;color:var(--text-light)">Cliente</div><div style="font-size:18px;font-weight:700" id="embarquesCliente">0</div></div>
                    <div class="config-card" style="text-align:center;padding:10px"><div style="font-size:11px;color:var(--text-light)">Vallejo</div><div style="font-size:18px;font-weight:700" id="embarquesVallejo">0</div></div>
                    <div class="config-card" style="text-align:center;padding:10px"><div style="font-size:11px;color:var(--text-light)">Traslado</div><div style="font-size:18px;font-weight:700" id="embarquesTraslado">0</div></div>
                </div>
                <button class="btn btn-success" id="descargarEmbarquesBtn">üìä Descargar Excel</button>
            </div>
            <div id="embarquesLista" style="margin-top:14px;max-height:300px;overflow-y:auto"></div>
        </div>
    </div>

    <!-- EXPORTAR INCIDENCIAS -->
    <div id="exportIncidenciasScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backExportIncidencias">‚Üê</button><h2 class="scanner-title">‚ö†Ô∏è Exportar Incidencias</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="margin-bottom:14px">
                <div class="config-row"><span class="config-label">Desde:</span><input type="date" class="form-input" id="exportIncidenciasDesde"></div>
                <div class="config-row"><span class="config-label">Hasta:</span><input type="date" class="form-input" id="exportIncidenciasHasta"></div>
                <button class="btn btn-primary mt-14" id="filtrarIncidenciasExportBtn">üîç Filtrar</button>
            </div>
            <div id="incidenciasExportResumen" class="hidden">
                <div class="config-card" style="background:var(--warning-bg);margin-bottom:14px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><strong>Incidencias encontradas</strong><br><span style="font-size:11px;color:var(--text-light)" id="incidenciasRangoFechas"></span></div>
                        <div style="font-size:28px;font-weight:800;color:var(--warning)" id="incidenciasExportTotal">0</div>
                    </div>
                </div>
                <button class="btn btn-success" id="descargarIncidenciasBtn">üìä Descargar Excel</button>
            </div>
            <div id="incidenciasExportLista" style="margin-top:14px;max-height:350px;overflow-y:auto"></div>
        </div>
    </div>

    <!-- EXPORTAR MUESTREOS AUDITORIA -->
    <div id="exportMuestreosScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backExportMuestreos">‚Üê</button><h2 class="scanner-title">üéØ Muestreos Auditor√≠a</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="margin-bottom:14px">
                <div class="config-row"><span class="config-label">Desde:</span><input type="date" class="form-input" id="exportMuestreosDesde"></div>
                <div class="config-row"><span class="config-label">Hasta:</span><input type="date" class="form-input" id="exportMuestreosHasta"></div>
                <button class="btn btn-primary mt-14" id="filtrarMuestreosBtn">üîç Filtrar</button>
            </div>
            <div id="muestreosAuditoriaLista"></div>
            <button class="btn btn-success mt-14" id="descargarMuestreosBtn">üìä Descargar Excel</button>
        </div>
    </div>

    <!-- LIBERAR REPARACION -->
    <div id="liberarReparacionScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backLiberarReparacion">‚Üê</button><h2 class="scanner-title">üîß Liberar Equipo</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="background:var(--info-bg);margin-bottom:14px">
                <div style="font-size:12px"><strong>Origen:</strong> <span id="reparacionBodegaActual">-</span></div>
            </div>
            
            <div class="config-card" style="margin-bottom:14px">
                <div class="form-group" style="margin-bottom:10px">
                    <label style="font-size:12px;font-weight:600">Ubicaci√≥n destino</label>
                    <select class="config-select" id="reparacionUbicacionDestino">
                        <option value="">Selecciona...</option>
                        <option value="B3">B3</option>
                        <option value="B5">B5</option>
                        <option value="B6">B6</option>
                        <option value="B7">B7</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="font-size:12px;font-weight:600">Comentario (opcional)</label>
                    <input type="text" class="form-input" id="reparacionComentario" placeholder="Ej: Reparaci√≥n completa, cambio de tarjeta...">
                </div>
            </div>
            
            <div class="tabs"><div class="tab active" id="reparacionTabScan">üì∑ Escanear</div><div class="tab" id="reparacionTabManual">‚å®Ô∏è Manual</div></div>
            
            <div id="reparacionScanSection">
                <div class="scanner-box"><div class="scanner-region" id="reparacion-scanner"></div></div>
            </div>
            
            <div id="reparacionManualSection" class="hidden">
                <div class="manual-input-section">
                    <input type="text" class="form-input" id="reparacionManualInput" placeholder="Escribe la serie...">
                    <button class="btn btn-primary" id="reparacionAddBtn">Agregar</button>
                </div>
            </div>
            
            <div class="scanned-list" id="reparacionScannedList"></div>
            <div class="confirm-bar"><span id="reparacionCount">0</span> equipos<button class="btn btn-success" id="confirmReparacion">‚úì Liberar a PT</button></div>
        </div>
    </div>

    <!-- HISTORIAL REPARACIONES -->
    <div id="historialReparacionesScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backHistorialReparaciones">‚Üê</button><h2 class="scanner-title">üìã Mis Liberaciones</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="margin-bottom:14px">
                <div class="config-row"><span class="config-label">Fecha:</span><input type="date" class="form-input" id="histReparacionesFecha"></div>
                <button class="btn btn-primary mt-14" id="filtrarHistReparacionesBtn">Ver</button>
            </div>
            <div id="historialReparacionesList"></div>
        </div>
    </div>

    <!-- EXPORTAR MOVIMIENTOS CON FILTRO -->
    <div id="exportMovimientosScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backExportMovimientos">‚Üê</button><h2 class="scanner-title">üìÖ Exportar Movimientos</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="margin-bottom:14px">
                <div class="config-row"><span class="config-label">Desde:</span><input type="date" class="form-input" id="exportMovsDesde"></div>
                <div class="config-row"><span class="config-label">Hasta:</span><input type="date" class="form-input" id="exportMovsHasta"></div>
                <button class="btn btn-primary mt-14" id="filtrarMovsExportBtn">üîç Filtrar</button>
            </div>
            <div id="movsExportResumen" class="hidden">
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:14px">
                    <div class="config-card" style="text-align:center;padding:8px;background:var(--success-bg)"><div style="font-size:10px">Recepci√≥n</div><div style="font-size:18px;font-weight:700" id="movsRecepcion">0</div></div>
                    <div class="config-card" style="text-align:center;padding:8px;background:var(--info-bg)"><div style="font-size:10px">Acomodo</div><div style="font-size:18px;font-weight:700" id="movsAcomodo">0</div></div>
                    <div class="config-card" style="text-align:center;padding:8px;background:var(--warning-bg)"><div style="font-size:10px">Traspaso</div><div style="font-size:18px;font-weight:700" id="movsTraspaso">0</div></div>
                    <div class="config-card" style="text-align:center;padding:8px;background:var(--error-bg)"><div style="font-size:10px">Embarque</div><div style="font-size:18px;font-weight:700" id="movsEmbarque">0</div></div>
                </div>
                <button class="btn btn-success" id="descargarMovsBtn">üìä Descargar Excel</button>
            </div>
        </div>
    </div>

    <!-- EXPORTAR PENDIENTES CON FILTRO -->
    <div id="exportPendientesScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backExportPendientes">‚Üê</button><h2 class="scanner-title">‚è≥ Exportar Pendientes</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="margin-bottom:14px">
                <div class="config-row"><span class="config-label">Desde:</span><input type="date" class="form-input" id="exportPendientesDesde"></div>
                <div class="config-row"><span class="config-label">Hasta:</span><input type="date" class="form-input" id="exportPendientesHasta"></div>
                <button class="btn btn-primary mt-14" id="filtrarPendientesExportBtn">üîç Filtrar</button>
            </div>
            <div id="pendientesExportResumen" class="hidden">
                <div class="config-card" style="background:var(--warning-bg);margin-bottom:14px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><strong>Pendientes encontrados</strong></div>
                        <div style="font-size:28px;font-weight:800;color:var(--warning)" id="pendientesExportTotal">0</div>
                    </div>
                </div>
                <button class="btn btn-success" id="descargarPendientesBtn">üìä Descargar Excel</button>
            </div>
        </div>
    </div>

    <!-- EXPORTAR INVENTARIO CON FILTRO -->
    <div id="exportInventarioScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backExportInventario">‚Üê</button><h2 class="scanner-title">üì¶ Exportar Inventario</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="margin-bottom:14px">
                <p style="font-size:12px;color:var(--text-light);margin-bottom:12px">Selecciona qu√© inventario descargar:</p>
                <button class="btn btn-primary" id="exportInventarioHoyBtn" style="width:100%;margin-bottom:10px">üì¶ Inventario Actual (Hoy)</button>
                <div style="text-align:center;font-size:11px;color:var(--text-light);margin:10px 0">‚Äî o selecciona fecha ‚Äî</div>
                <div class="config-row"><span class="config-label">Fecha:</span><input type="date" class="form-input" id="exportInventarioFecha"></div>
                <button class="btn btn-secondary mt-14" id="exportInventarioFechaBtn">üì¶ Inventario de esa fecha</button>
            </div>
        </div>
    </div>

    <!-- EXPORTAR RECEPCIONES -->
    <div id="exportRecepcionesScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backExportRecepciones">‚Üê</button><h2 class="scanner-title">üì• Exportar Recepciones</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="margin-bottom:14px">
                <div class="config-row"><span class="config-label">Desde:</span><input type="date" class="form-input" id="exportRecepcionesDesde"></div>
                <div class="config-row"><span class="config-label">Hasta:</span><input type="date" class="form-input" id="exportRecepcionesHasta"></div>
                <button class="btn btn-primary mt-14" id="filtrarRecepcionesExportBtn">üîç Filtrar</button>
            </div>
            <div id="recepcionesExportResumen" class="hidden">
                <div class="config-card" style="background:var(--success-bg);margin-bottom:14px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><strong>Recepciones encontradas</strong></div>
                        <div style="font-size:28px;font-weight:800;color:var(--success)" id="recepcionesExportTotal">0</div>
                    </div>
                </div>
                <button class="btn btn-success" id="descargarRecepcionesBtn">üìä Descargar Excel</button>
            </div>
            <div id="recepcionesExportLista" style="margin-top:14px;max-height:300px;overflow-y:auto"></div>
        </div>
    </div>

    <!-- EXPORTAR REPARACIONES -->
    <div id="exportReparacionesScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backExportReparaciones">‚Üê</button><h2 class="scanner-title">üîß Exportar Reparaciones</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="margin-bottom:14px">
                <div class="config-row"><span class="config-label">Desde:</span><input type="date" class="form-input" id="exportReparacionesDesde"></div>
                <div class="config-row"><span class="config-label">Hasta:</span><input type="date" class="form-input" id="exportReparacionesHasta"></div>
                <button class="btn btn-primary mt-14" id="filtrarReparacionesExportBtn">üîç Filtrar</button>
            </div>
            <div id="reparacionesExportResumen" class="hidden">
                <div class="config-card" style="background:#fef3c7;margin-bottom:14px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><strong>Equipos liberados</strong></div>
                        <div style="font-size:28px;font-weight:800;color:#d97706" id="reparacionesExportTotal">0</div>
                    </div>
                </div>
                <button class="btn btn-success" id="descargarReparacionesBtn">üìä Descargar Excel</button>
            </div>
            <div id="reparacionesExportLista" style="margin-top:14px;max-height:300px;overflow-y:auto"></div>
        </div>
    </div>

    <!-- EXPORTAR ALERTAS >30 DIAS -->
    <div id="exportAlertasScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backExportAlertas">‚Üê</button><h2 class="scanner-title">üîî Alertas >30 d√≠as</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="background:var(--warning-bg);margin-bottom:14px">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div><strong>Equipos sin movimiento</strong><br><span style="font-size:11px">M√°s de 30 d√≠as</span></div>
                    <div style="font-size:28px;font-weight:800;color:var(--warning)" id="alertasTotal">0</div>
                </div>
            </div>
            <button class="btn btn-success" id="descargarAlertasBtn">üìä Descargar Excel</button>
            <div id="alertasLista" style="margin-top:14px;max-height:350px;overflow-y:auto"></div>
        </div>
    </div>

    <!-- EXPORTAR OBSOLESCENCIA >90 DIAS -->
    <div id="exportObsolescenciaScreen" class="screen">
        <div class="scanner-header"><button class="back-btn" id="backExportObsolescencia">‚Üê</button><h2 class="scanner-title">üö® Obsolescencia >90 d√≠as</h2></div>
        <div class="scanner-body">
            <div class="config-card" style="background:var(--error-bg);margin-bottom:14px">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div><strong>Equipos sin embarcar</strong><br><span style="font-size:11px">M√°s de 90 d√≠as</span></div>
                    <div style="font-size:28px;font-weight:800;color:var(--error)" id="obsolescenciaTotal">0</div>
                </div>
            </div>
            <button class="btn btn-success" id="descargarObsolescenciaBtn">üìä Descargar Excel</button>
            <div id="obsolescenciaLista" style="margin-top:14px;max-height:350px;overflow-y:auto"></div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast"><span id="toastMessage">Mensaje</span></div>
    <div id="pendingBadge" class="pending-badge">‚è≥ <span id="pendingCount">0</span> pendientes</div>

<script>
// ==================== FIREBASE CONFIG ====================
const firebaseConfig = {
    apiKey: "AIzaSyBnl7Hx8IJRcXhrPnEGXDpSOVC-lIaPu7Y",
    authDomain: "ubicaciones-pt.firebaseapp.com",
    databaseURL: "https://ubicaciones-pt-default-rtdb.firebaseio.com",
    projectId: "ubicaciones-pt",
    storageBucket: "ubicaciones-pt.firebasestorage.app",
    messagingSenderId: "154594257298",
    appId: "1:154594257298:web:ee9df8e25580fb3330f94b"
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

(function(){
    // ==================== CONFIG ====================
    const CONFIG = {
        users: ['Alma Valeria Silva','Azael de Jesus Alfaro','Edson Adan Picon','Gerardo Mayel Perez','Juan Antonio Arreaga','Luis Alonso Canizales','Rene Saucedo','Rolando Ismael Martinez'],
        bodegas: ['B3','B5','B6','B7'],
        locations: generateLocations(),
        sheetsWebAppUrl: null
    };

    function generateLocations(){
        const locs = [];
        for(let r=1; r<=15; r++){
            for(let e=1; e<=2; e++){
                for(const n of ['A','B','C','D','E']){
                    for(let p=1; p<=12; p++){
                        locs.push('RACK'+r+'-EST'+e+'-'+n+'-'+String(p).padStart(2,'0'));
                    }
                }
            }
        }
        locs.push('TARIMA-1','TARIMA-2','TARIMA-3','PISO-AREA1','PISO-AREA2','EQUIPOS-PARED');
        return locs.sort();
    }

    // ==================== STATE ====================
    let state = {
        currentUser: null,
        currentRole: null,
        currentBodegaReparaciones: null,
        movements: [],
        reparaciones: [],
        pendingSync: [],
        scanners: {},
        scannedItems: {recepcion:[],acomodo:[],traspaso:[],embarque:[],reparacion:[]},
        locks: {recepcion:false,traspaso:false,embarque:false},
        locationQRScanner: null,
        currentFilter: 'all',
        auditResults: [],
        currentAudit: null,
        passwords: { auditoria: '7918', supervisor: '2026', calidad: '1234', reparaciones: 'REP' }
    };

    // ==================== DOM READY ====================
    document.addEventListener('DOMContentLoaded', async function(){
        await loadStorage();
        renderUsers();
        updateStats();
        updatePending();
        bindEvents();
        setupRealtimeSync();
        
        window.addEventListener('online', function(){ 
            document.getElementById('offlineBar').classList.remove('show'); 
            saveToFirebase(); // Sincronizar al volver online
        });
        window.addEventListener('offline', function(){ document.getElementById('offlineBar').classList.add('show'); });
        if(!navigator.onLine) document.getElementById('offlineBar').classList.add('show');
    });

    // ==================== BIND EVENTS ====================
    function bindEvents(){
        // Roles
        document.getElementById('roleUsuario').addEventListener('click', function(){ selectRole('usuario'); });
        document.getElementById('roleConsulta').addEventListener('click', function(){ selectRole('consulta'); });
        document.getElementById('roleReparaciones').addEventListener('click', function(){ selectRole('reparaciones'); });
        document.getElementById('roleCalidad').addEventListener('click', function(){ selectRole('calidad'); });
        document.getElementById('roleAuditoria').addEventListener('click', function(){ selectRole('auditoria'); });
        document.getElementById('roleSupervisor').addEventListener('click', function(){ selectRole('supervisor'); });
        document.getElementById('backToRolesBtn').addEventListener('click', backToRoles);
        document.getElementById('backFromPassword').addEventListener('click', backToRoles);
        document.getElementById('backFromBodega').addEventListener('click', backToRoles);
        document.getElementById('passwordBtn').addEventListener('click', validatePassword);
        document.getElementById('passwordInput').addEventListener('keypress', function(e){ if(e.key==='Enter') validatePassword(); });
        document.getElementById('logoutBtn').addEventListener('click', logout);
        
        // Bodega Reparaciones
        document.getElementById('bodegaB3').addEventListener('click', function(){ selectBodegaReparaciones('B3'); });
        document.getElementById('bodegaB7').addEventListener('click', function(){ selectBodegaReparaciones('B7'); });

        // Menu
        document.getElementById('menuRecepcion').addEventListener('click', function(){ openModule('recepcion'); });
        document.getElementById('menuAcomodo').addEventListener('click', function(){ openModule('acomodo'); });
        document.getElementById('menuTraspaso').addEventListener('click', function(){ openModule('traspaso'); });
        document.getElementById('menuEmbarque').addEventListener('click', function(){ openModule('embarque'); });
        document.getElementById('menuConsulta').addEventListener('click', function(){ openModule('consulta'); });
        document.getElementById('menuHistorial').addEventListener('click', function(){ openModule('historial'); });
        document.getElementById('menuMisMovs').addEventListener('click', function(){ openModule('misMovimientos'); });
        document.getElementById('menuExport').addEventListener('click', function(){ openModule('export'); });
        document.getElementById('menuPendientes').addEventListener('click', function(){ openModule('pendientes'); });
        document.getElementById('menuDashboard').addEventListener('click', function(){ openModule('dashboard'); });
        document.getElementById('menuAuditSample').addEventListener('click', function(){ openModule('auditSample'); });
        document.getElementById('menuMetric').addEventListener('click', function(){ openModule('metric'); });
        document.getElementById('menuCargaMasiva').addEventListener('click', function(){ openModule('cargaMasiva'); });
        
        // M√≥dulos Reparaciones
        if(document.getElementById('menuLiberarReparacion')) document.getElementById('menuLiberarReparacion').addEventListener('click', function(){ openModule('liberarReparacion'); });
        if(document.getElementById('menuHistorialReparaciones')) document.getElementById('menuHistorialReparaciones').addEventListener('click', function(){ openModule('historialReparaciones'); });
        
        // Nuevos m√≥dulos Calidad
        if(document.getElementById('menuCalidadSalidas')) document.getElementById('menuCalidadSalidas').addEventListener('click', function(){ openModule('calidadSalidas'); });
        if(document.getElementById('menuIncidencias')) document.getElementById('menuIncidencias').addEventListener('click', function(){ openModule('incidencias'); });
        if(document.getElementById('menuVerIncidencias')) document.getElementById('menuVerIncidencias').addEventListener('click', function(){ openModule('verIncidencias'); });
        if(document.getElementById('menuVerCalidadSalidas')) document.getElementById('menuVerCalidadSalidas').addEventListener('click', function(){ openModule('verCalidadSalidas'); });
        if(document.getElementById('menuMuestreoInterno')) document.getElementById('menuMuestreoInterno').addEventListener('click', function(){ openModule('muestreoInterno'); });

        // Back buttons
        document.getElementById('backRecepcion').addEventListener('click', goBack);
        document.getElementById('backAcomodo').addEventListener('click', goBack);
        document.getElementById('backTraspaso').addEventListener('click', goBack);
        document.getElementById('backEmbarque').addEventListener('click', goBack);
        document.getElementById('backConsulta').addEventListener('click', goBack);
        document.getElementById('backCargaMasiva').addEventListener('click', goBack);
        document.getElementById('backDashboard').addEventListener('click', goBack);
        document.getElementById('backHistorial').addEventListener('click', goBack);
        document.getElementById('backMisMovs').addEventListener('click', goBack);
        document.getElementById('backPendientes').addEventListener('click', goBack);
        document.getElementById('backExport').addEventListener('click', goBack);
        document.getElementById('backAuditSample').addEventListener('click', goBack);
        document.getElementById('backMetric').addEventListener('click', goBack);
        
        // Nuevos back buttons exportar
        if(document.getElementById('backExportEmbarques')) document.getElementById('backExportEmbarques').addEventListener('click', goBack);
        if(document.getElementById('backExportMuestreos')) document.getElementById('backExportMuestreos').addEventListener('click', goBack);
        if(document.getElementById('backExportIncidencias')) document.getElementById('backExportIncidencias').addEventListener('click', goBack);
        
        // Botones exportar embarques
        if(document.getElementById('filtrarEmbarquesBtn')) document.getElementById('filtrarEmbarquesBtn').addEventListener('click', filtrarEmbarques);
        if(document.getElementById('descargarEmbarquesBtn')) document.getElementById('descargarEmbarquesBtn').addEventListener('click', descargarEmbarques);
        
        // Botones exportar incidencias
        if(document.getElementById('filtrarIncidenciasExportBtn')) document.getElementById('filtrarIncidenciasExportBtn').addEventListener('click', filtrarIncidenciasExport);
        if(document.getElementById('descargarIncidenciasBtn')) document.getElementById('descargarIncidenciasBtn').addEventListener('click', descargarIncidenciasExcel);
        
        // Botones exportar muestreos
        if(document.getElementById('filtrarMuestreosBtn')) document.getElementById('filtrarMuestreosBtn').addEventListener('click', filtrarMuestreosAuditoria);
        if(document.getElementById('descargarMuestreosBtn')) document.getElementById('descargarMuestreosBtn').addEventListener('click', descargarMuestreosAuditoria);
        
        // Nuevos back buttons
        if(document.getElementById('backCalidadSalidas')) document.getElementById('backCalidadSalidas').addEventListener('click', goBack);
        if(document.getElementById('backIncidencias')) document.getElementById('backIncidencias').addEventListener('click', goBack);
        if(document.getElementById('backVerIncidencias')) document.getElementById('backVerIncidencias').addEventListener('click', goBack);
        if(document.getElementById('backVerCalidadSalidas')) document.getElementById('backVerCalidadSalidas').addEventListener('click', goBack);
        if(document.getElementById('backMuestreoInterno')) document.getElementById('backMuestreoInterno').addEventListener('click', goBack);
        
        document.getElementById('generateSampleBtn').addEventListener('click', generateAuditSample);
        document.getElementById('finishAuditBtn').addEventListener('click', finishAudit);
        document.getElementById('applyHistoryFilters').addEventListener('click', applyHistoryFilters);
        document.getElementById('applyPendientesFilter').addEventListener('click', renderPendientesList);
        document.getElementById('applyDashboardDate').addEventListener('click', renderDashboard);
        
        // Traspaso lock buttons adicionales
        if(document.getElementById('traspasoSolicitanteLockBtn')) document.getElementById('traspasoSolicitanteLockBtn').addEventListener('click', function(){ toggleLockField('traspasoSolicitante'); });
        if(document.getElementById('traspasoMotivoLockBtn')) document.getElementById('traspasoMotivoLockBtn').addEventListener('click', function(){ toggleLockField('traspasoMotivo'); });
        
        // Calidad Salidas
        if(document.getElementById('calidadFechaLockBtn')) document.getElementById('calidadFechaLockBtn').addEventListener('click', function(){ toggleLockField('calidadFecha'); });
        if(document.getElementById('calidadTabScan')) document.getElementById('calidadTabScan').addEventListener('click', function(){ switchTab('calidad','scan'); });
        if(document.getElementById('calidadTabManual')) document.getElementById('calidadTabManual').addEventListener('click', function(){ switchTab('calidad','manual'); });
        if(document.getElementById('calidadAddBtn')) document.getElementById('calidadAddBtn').addEventListener('click', function(){ addManualCalidad(); });
        if(document.getElementById('calidadCompararBtn')) document.getElementById('calidadCompararBtn').addEventListener('click', compararCalidadSalidas);
        if(document.getElementById('calidadExportarBtn')) document.getElementById('calidadExportarBtn').addEventListener('click', exportarCalidadSalidas);
        
        // Incidencias
        if(document.getElementById('incidenciaScanBtn')) document.getElementById('incidenciaScanBtn').addEventListener('click', openIncidenciaScan);
        if(document.getElementById('closeIncidenciaScan')) document.getElementById('closeIncidenciaScan').addEventListener('click', closeIncidenciaScan);
        if(document.getElementById('incidenciaGuardarBtn')) document.getElementById('incidenciaGuardarBtn').addEventListener('click', guardarIncidencia);
        if(document.getElementById('filtrarIncidenciasBtn')) document.getElementById('filtrarIncidenciasBtn').addEventListener('click', filtrarIncidencias);
        if(document.getElementById('exportarIncidenciasBtn')) document.getElementById('exportarIncidenciasBtn').addEventListener('click', exportarIncidencias);
        if(document.getElementById('filtrarCalidadReportesBtn')) document.getElementById('filtrarCalidadReportesBtn').addEventListener('click', filtrarCalidadReportes);
        
        // Muestreo Interno
        if(document.getElementById('generarMuestreoInternoBtn')) document.getElementById('generarMuestreoInternoBtn').addEventListener('click', generarMuestreoInterno);
        if(document.getElementById('finalizarMuestreoInternoBtn')) document.getElementById('finalizarMuestreoInternoBtn').addEventListener('click', finalizarMuestreoInterno);
        
        // Export buttons - nuevos con filtros
        if(document.getElementById('exportMovsBtn')) document.getElementById('exportMovsBtn').addEventListener('click', function(){ openModule('exportMovimientos'); });
        if(document.getElementById('exportPendientesBtn')) document.getElementById('exportPendientesBtn').addEventListener('click', function(){ openModule('exportPendientes'); });
        if(document.getElementById('exportInventarioBtn')) document.getElementById('exportInventarioBtn').addEventListener('click', function(){ openModule('exportInventario'); });
        
        // Nuevos botones de exportar en secci√≥n Export
        if(document.getElementById('exportEmbarquesBtn2')) document.getElementById('exportEmbarquesBtn2').addEventListener('click', function(){ openModule('exportEmbarques'); });
        if(document.getElementById('exportIncidenciasBtn2')) document.getElementById('exportIncidenciasBtn2').addEventListener('click', function(){ openModule('exportIncidencias'); });
        if(document.getElementById('exportCalidadSalidasBtn2')) document.getElementById('exportCalidadSalidasBtn2').addEventListener('click', function(){ openModule('verCalidadSalidas'); });
        if(document.getElementById('exportMuestreosBtn2')) document.getElementById('exportMuestreosBtn2').addEventListener('click', function(){ openModule('exportMuestreos'); });
        if(document.getElementById('exportReparacionesBtn')) document.getElementById('exportReparacionesBtn').addEventListener('click', function(){ openModule('exportReparaciones'); });
        if(document.getElementById('exportAlertasBtn')) document.getElementById('exportAlertasBtn').addEventListener('click', function(){ openModule('exportAlertas'); });
        if(document.getElementById('exportObsolescenciaBtn')) document.getElementById('exportObsolescenciaBtn').addEventListener('click', function(){ openModule('exportObsolescencia'); });
        
        // Back buttons nuevos
        if(document.getElementById('backLiberarReparacion')) document.getElementById('backLiberarReparacion').addEventListener('click', goBack);
        if(document.getElementById('backHistorialReparaciones')) document.getElementById('backHistorialReparaciones').addEventListener('click', goBack);
        if(document.getElementById('backExportMovimientos')) document.getElementById('backExportMovimientos').addEventListener('click', goBack);
        if(document.getElementById('backExportPendientes')) document.getElementById('backExportPendientes').addEventListener('click', goBack);
        if(document.getElementById('backExportInventario')) document.getElementById('backExportInventario').addEventListener('click', goBack);
        if(document.getElementById('backExportReparaciones')) document.getElementById('backExportReparaciones').addEventListener('click', goBack);
        if(document.getElementById('backExportAlertas')) document.getElementById('backExportAlertas').addEventListener('click', goBack);
        if(document.getElementById('backExportObsolescencia')) document.getElementById('backExportObsolescencia').addEventListener('click', goBack);
        
        // Filtros de exportar
        if(document.getElementById('filtrarMovsExportBtn')) document.getElementById('filtrarMovsExportBtn').addEventListener('click', filtrarMovimientosExport);
        if(document.getElementById('descargarMovsBtn')) document.getElementById('descargarMovsBtn').addEventListener('click', descargarMovimientosExcel);
        if(document.getElementById('filtrarPendientesExportBtn')) document.getElementById('filtrarPendientesExportBtn').addEventListener('click', filtrarPendientesExport);
        if(document.getElementById('descargarPendientesBtn')) document.getElementById('descargarPendientesBtn').addEventListener('click', descargarPendientesExcel);
        if(document.getElementById('exportInventarioHoyBtn')) document.getElementById('exportInventarioHoyBtn').addEventListener('click', exportarInventarioHoy);
        if(document.getElementById('exportInventarioFechaBtn')) document.getElementById('exportInventarioFechaBtn').addEventListener('click', exportarInventarioFecha);
        if(document.getElementById('filtrarReparacionesExportBtn')) document.getElementById('filtrarReparacionesExportBtn').addEventListener('click', filtrarReparacionesExport);
        if(document.getElementById('descargarReparacionesBtn')) document.getElementById('descargarReparacionesBtn').addEventListener('click', descargarReparacionesExcel);
        if(document.getElementById('descargarAlertasBtn')) document.getElementById('descargarAlertasBtn').addEventListener('click', descargarAlertasExcel);
        if(document.getElementById('descargarObsolescenciaBtn')) document.getElementById('descargarObsolescenciaBtn').addEventListener('click', descargarObsolescenciaExcel);
        
        // Recepciones export
        if(document.getElementById('exportRecepcionesBtn')) document.getElementById('exportRecepcionesBtn').addEventListener('click', function(){ openModule('exportRecepciones'); });
        if(document.getElementById('backExportRecepciones')) document.getElementById('backExportRecepciones').addEventListener('click', goBack);
        if(document.getElementById('filtrarRecepcionesExportBtn')) document.getElementById('filtrarRecepcionesExportBtn').addEventListener('click', filtrarRecepcionesExport);
        if(document.getElementById('descargarRecepcionesBtn')) document.getElementById('descargarRecepcionesBtn').addEventListener('click', descargarRecepcionesExcel);
        
        // Reparaciones
        if(document.getElementById('reparacionTabScan')) document.getElementById('reparacionTabScan').addEventListener('click', function(){ switchTabReparacion('scan'); });
        if(document.getElementById('reparacionTabManual')) document.getElementById('reparacionTabManual').addEventListener('click', function(){ switchTabReparacion('manual'); });
        if(document.getElementById('reparacionAddBtn')) document.getElementById('reparacionAddBtn').addEventListener('click', function(){ addManualReparacion(); });
        if(document.getElementById('confirmReparacion')) document.getElementById('confirmReparacion').addEventListener('click', confirmarReparacion);
        if(document.getElementById('filtrarHistReparacionesBtn')) document.getElementById('filtrarHistReparacionesBtn').addEventListener('click', filtrarHistorialReparaciones);
        
        // Carga Masiva (Excel)
        document.getElementById('selectFileBtn').addEventListener('click', function(){ document.getElementById('xlsxFileInput').click(); });
        document.getElementById('xlsxFileInput').addEventListener('change', handleExcelFile);
        document.getElementById('processFileBtn').addEventListener('click', processExcelFile);
        
        // Mis Movimientos
        document.getElementById('misMovsSearch').addEventListener('input', function(e){ renderMyMovements(e.target.value); });
        document.getElementById('scanMisMovsQR').addEventListener('click', openMisMovsQRScanner);
        document.getElementById('closeMisMovsQR').addEventListener('click', closeMisMovsQRScanner);
        document.getElementById('closeEditModal').addEventListener('click', closeEditModal);
        document.getElementById('saveEditBtn').addEventListener('click', saveEditMovement);

        // Tabs
        document.getElementById('recepcionTabScan').addEventListener('click', function(){ switchTab('recepcion','scan'); });
        document.getElementById('recepcionTabManual').addEventListener('click', function(){ switchTab('recepcion','manual'); });
        document.getElementById('traspasoTabScan').addEventListener('click', function(){ switchTab('traspaso','scan'); });
        document.getElementById('traspasoTabManual').addEventListener('click', function(){ switchTab('traspaso','manual'); });
        document.getElementById('embarqueTabScan').addEventListener('click', function(){ switchTab('embarque','scan'); });
        document.getElementById('embarqueTabManual').addEventListener('click', function(){ switchTab('embarque','manual'); });

        // Lock buttons
        document.getElementById('recepcionLockBtn').addEventListener('click', function(){ toggleLock('recepcion'); });
        document.getElementById('traspasoLockBtn').addEventListener('click', function(){ toggleLock('traspaso'); });
        document.getElementById('embarqueLockBtn').addEventListener('click', function(){ toggleLock('embarque'); });

        // Add buttons
        document.getElementById('recepcionAddBtn').addEventListener('click', function(){ addManual('recepcion'); });
        document.getElementById('traspasoAddBtn').addEventListener('click', function(){ addManual('traspaso'); });
        document.getElementById('embarqueAddBtn').addEventListener('click', function(){ addManual('embarque'); });
        
        // Acomodo nuevo flujo
        if(document.getElementById('acomodoAgregarBtn')) document.getElementById('acomodoAgregarBtn').addEventListener('click', agregarAcomodoMultiple);
        if(document.getElementById('acomodoScanSerieBtn')) document.getElementById('acomodoScanSerieBtn').addEventListener('click', openAcomodoSerieScan);
        if(document.getElementById('acomodoSerieInput')) document.getElementById('acomodoSerieInput').addEventListener('keypress', function(e){ if(e.key==='Enter') agregarAcomodoMultiple(); });

        // Manual inputs enter
        document.getElementById('recepcionManualInput').addEventListener('keypress', function(e){ if(e.key==='Enter') addManual('recepcion'); });
        document.getElementById('traspasoManualInput').addEventListener('keypress', function(e){ if(e.key==='Enter') addManual('traspaso'); });
        document.getElementById('embarqueManualInput').addEventListener('keypress', function(e){ if(e.key==='Enter') addManual('embarque'); });

        // Confirm buttons
        document.getElementById('recepcionConfirmBtn').addEventListener('click', confirmRecepcion);
        document.getElementById('acomodoConfirmBtn').addEventListener('click', confirmAcomodoMultiple);
        document.getElementById('traspasoConfirmBtn').addEventListener('click', confirmTraspaso);
        document.getElementById('embarqueConfirmBtn').addEventListener('click', confirmEmbarque);

        // Location dropdown
        document.getElementById('acomodoLocation').addEventListener('input', function(e){ filterLocs(e.target.value); });
        document.getElementById('acomodoLocation').addEventListener('focus', showLocs);
        document.addEventListener('click', function(e){ if(!e.target.closest('.location-dropdown')) document.getElementById('locationSuggestions').classList.remove('show'); });

        // QR
        document.getElementById('scanLocationQRBtn').addEventListener('click', scanLocationQR);
        document.getElementById('closeQRModal').addEventListener('click', closeLocationQR);

        // Search
        document.getElementById('searchBtn').addEventListener('click', searchSerie);
        document.getElementById('consultaInput').addEventListener('keypress', function(e){ if(e.key==='Enter') searchSerie(); });
        
        // Mis movimientos search
        document.getElementById('misMovsSearch').addEventListener('input', function(e){ renderMyMovements(e.target.value); });

        // History filters
        document.getElementById('historyFilters').addEventListener('click', function(e){
            if(e.target.classList.contains('filter-chip')){
                document.querySelectorAll('.filter-chip').forEach(function(c){ c.classList.remove('active'); });
                e.target.classList.add('active');
                state.currentFilter = e.target.dataset.filter;
                applyHistoryFilters();
            }
        });
    }

    // ==================== FIREBASE STORAGE ====================
    let firebaseLoaded = false;
    
    async function loadStorage(){
        // Primero cargar de localStorage (para que funcione offline)
        try{
            var m = localStorage.getItem('ubicaciones_movements');
            var p = localStorage.getItem('ubicaciones_pending');
            var ar = localStorage.getItem('ubicaciones_auditResults');
            if(m) state.movements = JSON.parse(m);
            if(p) state.pendingSync = JSON.parse(p);
            if(ar) state.auditResults = JSON.parse(ar);
        }catch(e){}
        
        // Luego cargar de Firebase (datos sincronizados)
        try{
            const movDoc = await db.collection('ptcontrol').doc('movements').get();
            if(movDoc.exists && movDoc.data().data){
                state.movements = movDoc.data().data;
                localStorage.setItem('ubicaciones_movements', JSON.stringify(state.movements));
            }
            
            const auditDoc = await db.collection('ptcontrol').doc('auditResults').get();
            if(auditDoc.exists && auditDoc.data().data){
                state.auditResults = auditDoc.data().data;
                localStorage.setItem('ubicaciones_auditResults', JSON.stringify(state.auditResults));
            }
            
            const repDoc = await db.collection('ptcontrol').doc('reparaciones').get();
            if(repDoc.exists && repDoc.data().data){
                localStorage.setItem('ptcontrol_reparaciones', JSON.stringify(repDoc.data().data));
            }
            
            const incDoc = await db.collection('ptcontrol').doc('incidencias').get();
            if(incDoc.exists && incDoc.data().data){
                localStorage.setItem('ubicaciones_incidencias', JSON.stringify(incDoc.data().data));
            }
            
            const calDoc = await db.collection('ptcontrol').doc('calidadSalidas').get();
            if(calDoc.exists && calDoc.data().data){
                localStorage.setItem('ubicaciones_calidadSalidas', JSON.stringify(calDoc.data().data));
            }
            
            firebaseLoaded = true;
            updateStats();
            updatePending();
            console.log('‚úÖ Datos cargados de Firebase');
        }catch(e){
            console.log('‚ö†Ô∏è Firebase offline, usando datos locales', e);
        }
    }

    function saveStorage(){
        // Guardar en localStorage primero (siempre funciona)
        try{
            localStorage.setItem('ubicaciones_movements', JSON.stringify(state.movements));
            localStorage.setItem('ubicaciones_pending', JSON.stringify(state.pendingSync));
            localStorage.setItem('ubicaciones_auditResults', JSON.stringify(state.auditResults));
        }catch(e){}
        
        // Guardar en Firebase (sincronizado)
        saveToFirebase();
    }
    
    async function saveToFirebase(){
        try{
            await db.collection('ptcontrol').doc('movements').set({
                data: state.movements,
                lastUpdate: new Date().toISOString()
            });
            
            await db.collection('ptcontrol').doc('auditResults').set({
                data: state.auditResults,
                lastUpdate: new Date().toISOString()
            });
            
            // Guardar reparaciones
            var reps = JSON.parse(localStorage.getItem('ptcontrol_reparaciones') || '[]');
            await db.collection('ptcontrol').doc('reparaciones').set({
                data: reps,
                lastUpdate: new Date().toISOString()
            });
            
            // Guardar incidencias
            var incs = JSON.parse(localStorage.getItem('ubicaciones_incidencias') || '[]');
            await db.collection('ptcontrol').doc('incidencias').set({
                data: incs,
                lastUpdate: new Date().toISOString()
            });
            
            // Guardar calidad salidas
            var cals = JSON.parse(localStorage.getItem('ubicaciones_calidadSalidas') || '[]');
            await db.collection('ptcontrol').doc('calidadSalidas').set({
                data: cals,
                lastUpdate: new Date().toISOString()
            });
            
            console.log('‚úÖ Guardado en Firebase');
        }catch(e){
            console.log('‚ö†Ô∏è Error guardando en Firebase:', e);
        }
    }
    
    // Escuchar cambios en tiempo real
    function setupRealtimeSync(){
        db.collection('ptcontrol').doc('movements').onSnapshot(function(doc){
            if(doc.exists && doc.data().data && firebaseLoaded){
                state.movements = doc.data().data;
                localStorage.setItem('ubicaciones_movements', JSON.stringify(state.movements));
                updateStats();
                updatePending();
                console.log('üîÑ Movimientos actualizados en tiempo real');
            }
        });
        
        db.collection('ptcontrol').doc('reparaciones').onSnapshot(function(doc){
            if(doc.exists && doc.data().data && firebaseLoaded){
                localStorage.setItem('ptcontrol_reparaciones', JSON.stringify(doc.data().data));
                console.log('üîÑ Reparaciones actualizadas en tiempo real');
            }
        });
    }

    // ==================== ROLES ====================
    function selectRole(role){
        state.currentRole = role;
        if(role === 'consulta'){
            state.currentUser = 'Consulta';
            document.getElementById('currentUserName').textContent = 'Consulta';
            document.getElementById('welcomeTitle').textContent = 'Consulta';
            document.getElementById('welcomeRole').textContent = 'Buscar + Reportes';
            applyRolePermissions();
            showScreen('menuScreen');
            showToast('success','Modo consulta activado');
        }else if(role === 'reparaciones'){
            document.getElementById('roleSelection').classList.add('hidden');
            document.getElementById('userSelection').classList.add('hidden');
            document.getElementById('passwordSection').classList.remove('hidden');
            document.getElementById('passwordTitle').textContent = 'Clave Reparaciones';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('passwordInput').focus();
        }else if(role === 'calidad' || role === 'auditoria' || role === 'supervisor'){
            document.getElementById('roleSelection').classList.add('hidden');
            document.getElementById('userSelection').classList.add('hidden');
            document.getElementById('passwordSection').classList.remove('hidden');
            var titles = {calidad:'Clave Calidad', auditoria:'Clave Auditoria', supervisor:'Clave Supervisor'};
            document.getElementById('passwordTitle').textContent = titles[role];
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('passwordInput').focus();
        }else{
            document.getElementById('roleSelection').classList.add('hidden');
            document.getElementById('userSelection').classList.remove('hidden');
        }
    }
    
    function selectBodegaReparaciones(bodega){
        state.currentBodegaReparaciones = bodega;
        state.currentUser = 'Reparaciones ' + bodega;
        document.getElementById('currentUserName').textContent = 'Rep. ' + bodega;
        document.getElementById('welcomeTitle').textContent = 'Reparaciones';
        document.getElementById('welcomeRole').textContent = 'Bodega: ' + bodega;
        document.getElementById('reparacionBodegaActual').textContent = bodega;
        applyRolePermissions();
        showScreen('menuScreen');
        showToast('success','Reparaciones ' + bodega + ' activado');
    }
    
    function validatePassword(){
        var pass = document.getElementById('passwordInput').value.toUpperCase();
        var storedPass = state.passwords[state.currentRole];
        if(pass === storedPass || pass === storedPass.toUpperCase()){
            if(state.currentRole === 'reparaciones'){
                // Mostrar selecci√≥n de bodega
                document.getElementById('passwordSection').classList.add('hidden');
                document.getElementById('bodegaReparacionesSection').classList.remove('hidden');
                return;
            }else if(state.currentRole === 'calidad'){
                state.currentUser = 'Calidad';
            }else if(state.currentRole === 'auditoria'){
                state.currentUser = 'Auditoria';
            }else{
                state.currentUser = 'Supervisor';
            }
            document.getElementById('currentUserName').textContent = state.currentUser;
            document.getElementById('welcomeTitle').textContent = 'Bienvenido';
            document.getElementById('welcomeRole').textContent = 'Acceso: ' + state.currentUser;
            applyRolePermissions();
            showScreen('menuScreen');
            showToast('success','Acceso autorizado');
        }else{
            document.getElementById('passwordError').style.display = 'block';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        }
    }

    function backToRoles(){
        document.getElementById('roleSelection').classList.remove('hidden');
        document.getElementById('userSelection').classList.add('hidden');
        document.getElementById('passwordSection').classList.add('hidden');
    }

    function renderUsers(){
        var g = document.getElementById('userGrid');
        var html = '';
        CONFIG.users.forEach(function(u){
            var i = u.split(' ').map(function(n){ return n[0]; }).join('');
            html += '<button class="user-btn" data-user="'+u+'"><div class="avatar">'+i+'</div><span>'+u+'</span></button>';
        });
        g.innerHTML = html;
        g.addEventListener('click', function(e){
            var btn = e.target.closest('.user-btn');
            if(btn) selectUser(btn.dataset.user);
        });
    }

    function selectUser(u){
        state.currentUser = u;
        document.getElementById('currentUserName').textContent = u;
        document.getElementById('welcomeTitle').textContent = 'Hola, ' + u.split(' ')[0];
        document.getElementById('welcomeRole').textContent = 'Rol: ' + state.currentRole.charAt(0).toUpperCase() + state.currentRole.slice(1);
        applyRolePermissions();
        showScreen('menuScreen');
        showToast('success','Bienvenido, '+u);
    }

    function applyRolePermissions(){
        var ops = document.getElementById('operationsSection');
        var consultasSec = document.getElementById('consultasSection');
        var hist = document.getElementById('menuHistorial');
        var myMovs = document.getElementById('menuMisMovs');
        var exp = document.getElementById('menuExport');
        var admin = document.getElementById('adminSection');
        var muestreo = document.getElementById('menuAuditSample');
        var calidadSec = document.getElementById('calidadSection');
        var supervisorSec = document.getElementById('supervisorSection');
        var reparacionesSec = document.getElementById('reparacionesSection');
        
        // Ocultar todo por defecto
        ops.classList.add('hidden');
        if(consultasSec) consultasSec.classList.add('hidden');
        hist.classList.add('hidden');
        myMovs.classList.add('hidden');
        exp.classList.add('hidden');
        admin.classList.add('hidden');
        if(calidadSec) calidadSec.classList.add('hidden');
        if(supervisorSec) supervisorSec.classList.add('hidden');
        if(reparacionesSec) reparacionesSec.classList.add('hidden');
        
        if(state.currentRole === 'consulta'){
            // Consulta: buscar + exportar reportes
            if(consultasSec) consultasSec.classList.remove('hidden');
            exp.classList.remove('hidden');
        }else if(state.currentRole === 'usuario'){
            ops.classList.remove('hidden');
            if(consultasSec) consultasSec.classList.remove('hidden');
            myMovs.classList.remove('hidden');
        }else if(state.currentRole === 'reparaciones'){
            // Reparaciones: liberar equipos, consulta, reportes
            if(consultasSec) consultasSec.classList.remove('hidden');
            if(reparacionesSec) reparacionesSec.classList.remove('hidden');
            exp.classList.remove('hidden');
        }else if(state.currentRole === 'calidad'){
            // Calidad: consulta, pendientes, m√≥dulos de calidad
            if(consultasSec) consultasSec.classList.remove('hidden');
            if(calidadSec) calidadSec.classList.remove('hidden');
        }else if(state.currentRole === 'auditoria'){
            // Auditoria: todo incluyendo muestreo y ver calidad/incidencias
            ops.classList.remove('hidden');
            if(consultasSec) consultasSec.classList.remove('hidden');
            hist.classList.remove('hidden');
            exp.classList.remove('hidden');
            admin.classList.remove('hidden');
            if(calidadSec) calidadSec.classList.remove('hidden');
            muestreo.classList.remove('hidden');
        }else if(state.currentRole === 'supervisor'){
            // Supervisor: todo EXCEPTO muestreo auditor√≠a, pero S√ç muestreo interno
            ops.classList.remove('hidden');
            if(consultasSec) consultasSec.classList.remove('hidden');
            hist.classList.remove('hidden');
            exp.classList.remove('hidden');
            admin.classList.remove('hidden');
            if(calidadSec) calidadSec.classList.remove('hidden');
            if(supervisorSec) supervisorSec.classList.remove('hidden');
            muestreo.classList.add('hidden');
        }
    }

    function logout(){
        stopScanners();
        state.currentUser = null;
        state.currentRole = null;
        state.currentBodegaReparaciones = null;
        document.getElementById('roleSelection').classList.remove('hidden');
        document.getElementById('userSelection').classList.add('hidden');
        document.getElementById('passwordSection').classList.add('hidden');
        document.getElementById('bodegaReparacionesSection').classList.add('hidden');
        showScreen('loginScreen');
    }

    // ==================== NAVIGATION ====================
    function showScreen(id){
        document.querySelectorAll('.screen').forEach(function(s){ s.classList.remove('active'); });
        document.getElementById(id).classList.add('active');
    }

    function goBack(){
        stopScanners();
        ['recepcion','traspaso','embarque'].forEach(function(m){
            state.scannedItems[m] = [];
            updateList(m);
        });
        acomodoMultipleItems = [];
        if(document.getElementById('acomodoItems')) renderAcomodoMultipleList();
        showScreen('menuScreen');
        updateStats();
    }

    // ==================== SCANNER ====================
    function startScanner(m){
        if(typeof Html5Qrcode === 'undefined'){
            console.warn('Html5Qrcode no cargado');
            return;
        }
        var id = m + '-scanner';
        var el = document.getElementById(id);
        if(!el) return;
        if(state.scanners[m]){
            try{ state.scanners[m].stop(); }catch(e){}
        }
        state.scanners[m] = new Html5Qrcode(id);
        state.scanners[m].start(
            {facingMode:'environment'},
            {fps:10,qrbox:{width:250,height:150}},
            function(code){ onScan(m, code); },
            function(){}
        ).catch(function(e){ console.log('Error c√°mara:', e); });
    }

    function stopScanners(){
        Object.keys(state.scanners).forEach(function(k){
            if(state.scanners[k]){
                try{ state.scanners[k].stop(); }catch(e){}
                state.scanners[k] = null;
            }
        });
    }

    function onScan(m, code){
        if(navigator.vibrate) navigator.vibrate(100);
        playBeep();
        
        // Validar ubicacion para acomodo
        if(m === 'acomodo'){
            var loc = document.getElementById('acomodoLocation').value.trim();
            if(!loc){
                showToast('error','Primero selecciona ubicaci√≥n');
                return;
            }
        }
        
        var p = parseCode(code);
        if(!p){ showToast('error','C√≥digo no v√°lido'); return; }
        
        // Check duplicate in current list
        var isDup = state.scannedItems[m].some(function(i){ return i.full === p.full; });
        if(isDup){ showToast('warning','Ya escaneado'); return; }
        
        // Check if exists in another location
        var existing = findEquipmentLocation(p.full);
        if(existing && m !== 'embarque'){
            document.getElementById(m+'DuplicateAlert').classList.remove('hidden');
            document.getElementById(m+'DuplicateAlert').textContent = '‚ö†Ô∏è Este equipo est√° en: ' + existing;
            setTimeout(function(){ document.getElementById(m+'DuplicateAlert').classList.add('hidden'); }, 5000);
        }
        
        state.scannedItems[m].push({
            prefix: p.prefix,
            serie: p.serie,
            full: p.full,
            scannedAt: new Date().toISOString()
        });
        updateList(m);
        showToast('success', p.full + ' agregado');
    }

    function parseCode(c){
        var clean = c.trim().toUpperCase();
        
        // Si no tiene guiones, intentar extraer serie de los ultimos 9 digitos
        if(clean.indexOf('-') === -1){
            if(clean.length >= 10){
                var s = clean.slice(-9);
                var pr = clean.slice(0,-9);
                if(/^\d+$/.test(s) && pr.length >= 2){
                    return {prefix:pr, serie:s.padStart(9,'0'), full:pr+'-'+s.padStart(9,'0')};
                }
            }
            return null;
        }
        
        // Buscar el ultimo guion seguido de numeros (la serie)
        var lastDash = clean.lastIndexOf('-');
        var possibleSerie = clean.substring(lastDash + 1);
        
        // Si lo que sigue al ultimo guion son puros numeros de 8-9 digitos, es la serie
        if(/^\d{8,9}$/.test(possibleSerie)){
            var pr = clean.substring(0, lastDash);
            var s = possibleSerie.padStart(9, '0');
            // Prefijo puede tener guiones internos (ej: BAT-1360)
            if(pr.length >= 2){
                return {prefix:pr, serie:s, full:pr+'-'+s};
            }
        }
        
        // Formato simple: PREFIJO-SERIE (un solo guion)
        var dash = clean.lastIndexOf('-');
        var pr = clean.substring(0, dash);
        var s = clean.substring(dash + 1);
        if(pr.length >= 2 && s.length >= 8 && s.length <= 9 && /^\d+$/.test(s)){
            s = s.padStart(9, '0');
            return {prefix:pr, serie:s, full:pr+'-'+s};
        }
        
        return null;
    }

    function findEquipmentLocation(code){
        for(var i=0; i<state.movements.length; i++){
            var m = state.movements[i];
            if(m.equipment.full === code){
                if(m.type === 'embarque') return null;
                if(m.type === 'acomodo') return m.location;
                if(m.type === 'recepcion' || m.type === 'traspaso') return m.bodega;
            }
        }
        return null;
    }

    // ==================== LOCATION QR ====================
    function scanLocationQR(){
        if(typeof Html5Qrcode === 'undefined'){ showToast('warning','C√°mara no disponible'); return; }
        document.getElementById('locationQRModal').classList.add('show');
        setTimeout(function(){
            try{
                if(state.locationQRScanner){
                    try{ state.locationQRScanner.stop(); }catch(e){}
                }
                state.locationQRScanner = new Html5Qrcode('location-qr-scanner');
                state.locationQRScanner.start(
                    {facingMode:'environment'},
                    {fps:10,qrbox:{width:250,height:250}},
                    function(code){
                        if(navigator.vibrate) navigator.vibrate(100);
                        document.getElementById('acomodoLocation').value = code.toUpperCase();
                        closeLocationQR();
                        showToast('success','Ubicaci√≥n: '+code);
                    },
                    function(){}
                ).catch(function(){});
            }catch(e){}
        }, 300);
    }

    function closeLocationQR(){
        if(state.locationQRScanner){
            try{ state.locationQRScanner.stop(); }catch(e){}
        }
        document.getElementById('locationQRModal').classList.remove('show');
    }

    // ==================== UI ====================
    function switchTab(m, tab){
        var scanTab = document.getElementById(m+'TabScan');
        var manualTab = document.getElementById(m+'TabManual');
        var scanView = document.getElementById(m+'ScanView');
        var manualView = document.getElementById(m+'ManualView');
        
        if(tab === 'scan'){
            scanTab.classList.add('active');
            manualTab.classList.remove('active');
            scanView.classList.remove('hidden');
            manualView.classList.add('hidden');
            startScanner(m);
        }else{
            scanTab.classList.remove('active');
            manualTab.classList.add('active');
            scanView.classList.add('hidden');
            manualView.classList.remove('hidden');
            if(state.scanners[m]){
                try{ state.scanners[m].stop(); }catch(e){}
            }
        }
    }

    function toggleLock(m){
        state.locks[m] = !state.locks[m];
        var btn = document.getElementById(m+'LockBtn');
        btn.textContent = state.locks[m] ? 'üîí Fijado' : 'üîì Fijar';
        btn.classList.toggle('locked', state.locks[m]);
        showToast('success', state.locks[m] ? 'Configuraci√≥n fijada' : 'Desbloqueado');
    }

    function updateList(m){
        var items = state.scannedItems[m];
        var cont = document.getElementById(m+'Items');
        var cnt = document.getElementById(m+'Count');
        var btn = document.getElementById(m+'ConfirmBtn');
        
        cnt.textContent = items.length;
        btn.disabled = items.length === 0;
        
        if(!items.length){
            cont.innerHTML = '<div class="empty-list">Escanea equipos para agregarlos</div>';
            return;
        }
        
        var html = '';
        items.forEach(function(item, idx){
            var t = new Date(item.scannedAt).toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'});
            html += '<div class="scanned-item"><div><div class="code">'+item.full+'</div><div class="time">'+t+'</div></div><button class="remove-btn" data-module="'+m+'" data-idx="'+idx+'">‚úï</button></div>';
        });
        cont.innerHTML = html;
        
        cont.querySelectorAll('.remove-btn').forEach(function(btn){
            btn.addEventListener('click', function(){
                removeItem(btn.dataset.module, parseInt(btn.dataset.idx));
            });
        });
    }

    function removeItem(m, i){
        state.scannedItems[m].splice(i, 1);
        updateList(m);
    }

    function addManual(m){
        var inp = document.getElementById(m+'ManualInput');
        
        // Validar ubicacion para acomodo
        if(m === 'acomodo'){
            var loc = document.getElementById('acomodoLocation').value.trim();
            if(!loc){
                showToast('error','Primero selecciona ubicaci√≥n');
                document.getElementById('acomodoLocation').focus();
                return;
            }
        }
        
        var p = parseCode(inp.value);
        if(!p){ showToast('error','C√≥digo no v√°lido'); return; }
        
        var isDup = state.scannedItems[m].some(function(i){ return i.full === p.full; });
        if(isDup){ showToast('warning','Ya agregado'); return; }
        
        state.scannedItems[m].push({
            prefix: p.prefix,
            serie: p.serie,
            full: p.full,
            scannedAt: new Date().toISOString()
        });
        updateList(m);
        inp.value = '';
        inp.focus();
        showToast('success', p.full + ' agregado');
    }

    // ==================== LOCATIONS ====================
    function showLocs(){
        filterLocs(document.getElementById('acomodoLocation').value);
        document.getElementById('locationSuggestions').classList.add('show');
    }

    function filterLocs(q){
        var s = document.getElementById('locationSuggestions');
        var filtered = CONFIG.locations.filter(function(l){
            return l.toLowerCase().indexOf(q.toLowerCase()) !== -1;
        }).slice(0, 15);
        
        if(filtered.length){
            var html = '';
            filtered.forEach(function(l){
                html += '<div class="suggestion-item" data-loc="'+l+'">'+l+'</div>';
            });
            s.innerHTML = html;
            s.querySelectorAll('.suggestion-item').forEach(function(item){
                item.addEventListener('click', function(){
                    document.getElementById('acomodoLocation').value = item.dataset.loc;
                    s.classList.remove('show');
                });
            });
        }else{
            s.innerHTML = '<div class="suggestion-item" style="color:var(--text-light)">No encontrado</div>';
        }
    }

    // ==================== CONFIRM ====================
    function confirmRecepcion(){
        var b = document.getElementById('recepcionBodega').value;
        var items = state.scannedItems.recepcion;
        if(!items.length) return;
        
        items.forEach(function(i){ saveMovement('recepcion', i, {bodega:b}); });
        playBeep();
        showToast('success', items.length + ' equipos recibidos en ' + b);
        state.scannedItems.recepcion = [];
        updateList('recepcion');
        if(!state.locks.recepcion) goBack();
    }

    function confirmAcomodo(){
        var loc = document.getElementById('acomodoLocation').value;
        var items = state.scannedItems.acomodo;
        if(!loc){ showToast('error','Selecciona ubicaci√≥n'); return; }
        if(!items.length) return;
        
        items.forEach(function(i){ saveMovement('acomodo', i, {location:loc}); });
        playBeep();
        showToast('success', items.length + ' equipos en ' + loc);
        state.scannedItems.acomodo = [];
        updateList('acomodo');
        document.getElementById('acomodoLocation').value = '';
    }

    function confirmTraspaso(){
        var b = document.getElementById('traspasoBodega').value;
        var sol = document.getElementById('traspasoSolicitante').value;
        var mot = document.getElementById('traspasoMotivo').value;
        var items = state.scannedItems.traspaso;
        if(!items.length) return;
        
        items.forEach(function(i){ saveMovement('traspaso', i, {bodega:b, solicitante:sol, motivo:mot}); });
        playBeep();
        showToast('success', items.length + ' equipos a ' + b);
        state.scannedItems.traspaso = [];
        updateList('traspaso');
        if(!state.locks.traspaso){
            document.getElementById('traspasoSolicitante').value = '';
            document.getElementById('traspasoMotivo').value = '';
            goBack();
        }
    }

    function confirmEmbarque(){
        var ref = document.getElementById('embarqueReferencia').value;
        var tipoSalida = document.getElementById('embarqueTipoSalida').value || 'cliente';
        var items = state.scannedItems.embarque;
        if(!items.length) return;
        
        items.forEach(function(i){ saveMovement('embarque', i, {referencia:ref, tipoSalida:tipoSalida}); });
        playBeep();
        showToast('success', items.length + ' equipos embarcados');
        state.scannedItems.embarque = [];
        updateList('embarque');
        if(!state.locks.embarque){
            document.getElementById('embarqueReferencia').value = '';
            goBack();
        }
    }

    function saveMovement(type, eq, extra){
        var now = new Date();
        var mov = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2),
            timestamp: now.toISOString(),
            fecha: now.toLocaleDateString('es-MX'),
            hora: now.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),
            type: type,
            user: state.currentUser,
            equipment: eq,
            synced: false
        };
        Object.keys(extra || {}).forEach(function(k){ mov[k] = extra[k]; });
        
        state.movements.unshift(mov);
        state.pendingSync.push(mov);
        saveStorage();
        updateStats();
        updatePending();
    }

    // ==================== SEARCH ====================
    // Funci√≥n auxiliar para b√∫squeda flexible de serie (CAMBIO 1, 9)
    function flexibleSerieMatch(movimiento, query){
        var q = query.replace(/[^0-9]/g, ''); // Solo n√∫meros
        var full = movimiento.equipment.full.toUpperCase();
        var serie = movimiento.equipment.serie;
        
        // Coincidencia exacta con c√≥digo completo
        if(full.indexOf(query.toUpperCase()) !== -1) return true;
        
        // Coincidencia solo con n√∫meros de serie (8-9 d√≠gitos)
        if(q.length >= 8 && q.length <= 9){
            if(serie.indexOf(q) !== -1) return true;
            // Tambi√©n buscar si la serie termina con esos d√≠gitos
            if(serie.slice(-q.length) === q) return true;
        }
        
        return false;
    }
    
    function searchSerie(){
        var q = document.getElementById('consultaInput').value.trim().toUpperCase();
        var tipo = document.getElementById('consultaTipo').value;
        var res = document.getElementById('consultaResults');
        
        if(!q){ showToast('warning','Escribe un valor para buscar'); return; }
        
        if(tipo === 'ubicacion'){
            // CAMBIO 2: B√∫squeda por ubicaci√≥n
            searchByUbicacion(q, res);
        }else{
            // B√∫squeda por serie (flexible)
            searchBySerieFlexible(q, res);
        }
    }
    
    function searchBySerieFlexible(q, res){
        var matches = state.movements.filter(function(m){
            return flexibleSerieMatch(m, q);
        });
        
        if(!matches.length){
            res.innerHTML = '<div class="empty-state"><p>No se encontr√≥ "'+q+'"</p></div>';
            return;
        }
        
        var last = matches[0];
        var isEmb = last.type === 'embarque';
        var loc = last.location || last.bodega || '-';
        var typeNames = {recepcion:'Recepci√≥n',acomodo:'Acomodo',traspaso:'Traspaso',embarque:'Embarque'};
        
        var html = '<div class="equipment-card">';
        html += '<div class="equipment-header"><div class="code">'+matches[0].equipment.full+'</div>';
        html += '<div class="details"><span>Prefijo: '+matches[0].equipment.prefix+'</span><span>Serie: '+matches[0].equipment.serie+'</span></div></div>';
        html += '<div class="equipment-status"><span class="status-badge '+(isEmb?'embarcado':'en-bodega')+'">'+(isEmb?'üì§ Embarcado':'üìç En Bodega')+'</span>';
        html += '<span>'+(isEmb?'Ref: '+(last.referencia||'-'):'Ubicaci√≥n: '+loc)+'</span></div>';
        html += '<div class="equipment-timeline"><div class="timeline-title">Historial de movimientos</div>';
        
        matches.forEach(function(m){
            var det = '';
            if(m.type==='recepcion') det = 'Bodega: '+m.bodega;
            else if(m.type==='acomodo') det = 'Ubicaci√≥n: '+m.location;
            else if(m.type==='traspaso') det = 'Destino: '+m.bodega+(m.solicitante?' | Solicit√≥: '+m.solicitante:'')+(m.motivo?' | Motivo: '+m.motivo:'');
            else if(m.type==='embarque') det = 'Ref: '+(m.referencia||'-');
            
            html += '<div class="timeline-item"><div class="timeline-dot '+m.type+'"></div>';
            html += '<div class="timeline-content"><div class="action">'+typeNames[m.type]+'</div>';
            html += '<div class="meta">'+m.fecha+' '+m.hora+' ‚Ä¢ '+m.user+' ‚Ä¢ '+det+'</div></div></div>';
        });
        
        html += '</div></div>';
        res.innerHTML = html;
    }
    
    // CAMBIO 2: B√∫squeda por ubicaci√≥n
    function searchByUbicacion(q, res){
        // Obtener √∫ltimo estado de cada equipo
        var equipmentStatus = {};
        state.movements.forEach(function(m){
            var code = m.equipment.full;
            if(!equipmentStatus[code] || new Date(m.timestamp) > new Date(equipmentStatus[code].timestamp)){
                equipmentStatus[code] = m;
            }
        });
        
        // Filtrar equipos que est√°n en ubicaciones que coinciden
        var matches = [];
        for(var code in equipmentStatus){
            var m = equipmentStatus[code];
            // Solo equipos con acomodo (tienen ubicaci√≥n) y no embarcados
            if(m.type === 'acomodo' && m.location){
                // B√∫squeda parcial o exacta
                if(m.location.toUpperCase().indexOf(q) !== -1){
                    matches.push(m);
                }
            }
        }
        
        if(!matches.length){
            res.innerHTML = '<div class="empty-state"><p>No hay equipos en ubicaci√≥n "'+q+'"</p></div>';
            return;
        }
        
        // Ordenar por ubicaci√≥n
        matches.sort(function(a,b){ return a.location.localeCompare(b.location); });
        
        var html = '<div class="config-card" style="background:var(--info-bg);margin-bottom:14px">';
        html += '<div style="font-weight:700;color:var(--info)">üìç '+matches.length+' equipos encontrados en "'+q+'"</div></div>';
        
        matches.forEach(function(m){
            html += '<div class="history-item">';
            html += '<div class="history-icon acomodo">üìç</div>';
            html += '<div class="history-content">';
            html += '<div class="history-code">'+m.equipment.full+'</div>';
            html += '<div class="history-details">Ubicaci√≥n: <strong>'+m.location+'</strong></div>';
            html += '<div class="history-meta"><span>Acomodado: '+m.fecha+'</span><span>'+m.user+'</span></div>';
            html += '</div></div>';
        });
        
        res.innerHTML = html;
    }
    
    function renderPendientesList(){
        var list = document.getElementById('pendientesList');
        var searchQuery = document.getElementById('pendientesSearch').value.trim().toUpperCase();
        var dateFilter = document.getElementById('pendientesDate').value;
        var sortBy = document.getElementById('pendientesSort').value;
        
        // Obtener equipos pendientes de acomodo
        var equipmentStatus = {};
        var sortedMovs = state.movements.slice().sort(function(a,b){
            return new Date(a.timestamp) - new Date(b.timestamp);
        });
        
        sortedMovs.forEach(function(m){
            var code = m.equipment.full;
            if(!equipmentStatus[code]){
                equipmentStatus[code] = { needsAcomodo: false, lastMove: null, equipment: m.equipment };
            }
            equipmentStatus[code].lastMove = m;
            
            if(m.type === 'recepcion' || m.type === 'traspaso'){
                equipmentStatus[code].needsAcomodo = true;
            }else if(m.type === 'acomodo' || m.type === 'embarque'){
                equipmentStatus[code].needsAcomodo = false;
            }
        });
        
        var pending = [];
        for(var code in equipmentStatus){
            if(equipmentStatus[code].needsAcomodo){
                pending.push({
                    code: code,
                    equipment: equipmentStatus[code].equipment,
                    lastMove: equipmentStatus[code].lastMove
                });
            }
        }
        
        // Aplicar filtro de busqueda
        if(searchQuery){
            pending = pending.filter(function(p){
                return p.code.indexOf(searchQuery) !== -1 || p.equipment.serie.indexOf(searchQuery) !== -1;
            });
        }
        
        // Aplicar filtro de fecha
        if(dateFilter){
            var filterDate = new Date(dateFilter + 'T00:00:00').toDateString();
            pending = pending.filter(function(p){
                return new Date(p.lastMove.timestamp).toDateString() === filterDate;
            });
        }
        
        // Ordenar
        if(sortBy === 'fecha-desc'){
            pending.sort(function(a,b){ return new Date(b.lastMove.timestamp) - new Date(a.lastMove.timestamp); });
        }else if(sortBy === 'fecha-asc'){
            pending.sort(function(a,b){ return new Date(a.lastMove.timestamp) - new Date(b.lastMove.timestamp); });
        }else if(sortBy === 'serie-asc'){
            pending.sort(function(a,b){ return a.code.localeCompare(b.code); });
        }else if(sortBy === 'serie-desc'){
            pending.sort(function(a,b){ return b.code.localeCompare(a.code); });
        }
        
        if(!pending.length){
            list.innerHTML = '<div class="empty-state" style="background:var(--success-bg);border-radius:12px;padding:20px"><p style="color:var(--success);font-weight:700">‚úì '+(searchQuery || dateFilter ? 'Sin resultados' : 'Todo acomodado')+'</p><p style="font-size:12px;color:var(--text-light);margin-top:4px">'+(searchQuery || dateFilter ? 'Intenta con otros filtros' : 'No hay equipos pendientes')+'</p></div>';
            return;
        }
        
        var html = '<div style="background:var(--warning-bg);border-radius:12px;padding:12px;margin-bottom:14px;text-align:center">';
        html += '<p style="font-weight:700;color:#92400e">‚è≥ '+pending.length+' equipos pendientes</p></div>';
        
        pending.forEach(function(p){
            var lastType = p.lastMove.type === 'recepcion' ? 'Recepci√≥n' : 'Traspaso';
            var lastLoc = p.lastMove.bodega || '-';
            html += '<div class="history-item">';
            html += '<div class="history-icon '+(p.lastMove.type === 'recepcion' ? 'recepcion' : 'traspaso')+'">'+(p.lastMove.type === 'recepcion' ? 'üì•' : 'üîÑ')+'</div>';
            html += '<div class="history-content">';
            html += '<div class="history-code">'+p.code+'</div>';
            html += '<div class="history-details">'+lastType+' en '+lastLoc+'</div>';
            html += '<div class="history-meta"><span>'+p.lastMove.fecha+' '+p.lastMove.hora+'</span><span>'+p.lastMove.user+'</span></div>';
            html += '</div></div>';
        });
        
        list.innerHTML = html;
    }

    // ==================== HISTORY ====================
    function applyHistoryFilters(){
        var dateFrom = document.getElementById('historyDateFrom').value;
        var dateTo = document.getElementById('historyDateTo').value;
        var serieFilter = document.getElementById('historySerieFilter').value.trim().toUpperCase();
        
        var f = state.movements;
        
        // Filtrar por tipo
        if(state.currentFilter && state.currentFilter !== 'all'){
            f = f.filter(function(m){ return m.type === state.currentFilter; });
        }
        
        // Filtrar por fecha desde
        if(dateFrom){
            var fromDate = new Date(dateFrom);
            f = f.filter(function(m){
                var mDate = new Date(m.timestamp);
                return mDate >= fromDate;
            });
        }
        
        // Filtrar por fecha hasta
        if(dateTo){
            var toDate = new Date(dateTo);
            toDate.setHours(23,59,59);
            f = f.filter(function(m){
                var mDate = new Date(m.timestamp);
                return mDate <= toDate;
            });
        }
        
        // Filtrar por serie
        if(serieFilter){
            f = f.filter(function(m){
                return m.equipment.full.indexOf(serieFilter) !== -1 || m.equipment.serie.indexOf(serieFilter) !== -1;
            });
        }
        
        renderHistoryFiltered(f);
    }
    
    function renderHistoryFiltered(f){
        var list = document.getElementById('historyList');
        
        if(!f.length){
            list.innerHTML = '<div class="empty-state"><p>No hay movimientos</p></div>';
            return;
        }
        
        var typeNames = {recepcion:'Recepci√≥n',acomodo:'Acomodo',traspaso:'Traspaso',embarque:'Embarque'};
        var icons = {recepcion:'üì•',acomodo:'üìç',traspaso:'üîÑ',embarque:'üì§'};
        
        var html = '<p style="font-size:11px;color:var(--text-light);margin-bottom:10px">Mostrando '+Math.min(f.length,100)+' de '+f.length+' resultados</p>';
        f.slice(0,100).forEach(function(m){
            var det = '';
            if(m.type==='recepcion') det = 'Bodega: '+m.bodega;
            else if(m.type==='acomodo') det = '‚Üí '+m.location;
            else if(m.type==='traspaso') det = '‚Üí '+m.bodega+(m.motivo?' ('+m.motivo+')':'');
            else if(m.type==='embarque') det = 'Ref: '+(m.referencia||'-');
            
            html += '<div class="history-item"><div class="history-icon '+m.type+'">'+icons[m.type]+'</div>';
            html += '<div class="history-content"><div class="history-code">'+m.equipment.full+'</div>';
            html += '<div class="history-details">'+typeNames[m.type]+' '+det+'</div>';
            html += '<div class="history-meta"><span>'+m.fecha+' '+m.hora+'</span><span>'+m.user+'</span>';
            if(!m.synced) html += '<span style="color:var(--warning)">‚è≥</span>';
            html += '</div></div></div>';
        });
        
        list.innerHTML = html;
    }
    
    function renderHistory(filter){
        state.currentFilter = filter;
        applyHistoryFilters();
    }

    // ==================== MY MOVEMENTS ====================
    function renderMyMovements(searchQuery){
        var list = document.getElementById('myMovsList');
        var myMovs = state.movements.filter(function(m){ return m.user === state.currentUser; });
        
        // Filtrar por busqueda si hay query
        if(searchQuery && searchQuery.trim()){
            var q = searchQuery.trim().toUpperCase();
            myMovs = myMovs.filter(function(m){
                return m.equipment.full.indexOf(q) !== -1 || m.equipment.serie.indexOf(q) !== -1;
            });
        }
        
        if(!myMovs.length){
            list.innerHTML = '<div class="empty-state"><p>'+(searchQuery ? 'No encontrado' : 'No tienes movimientos')+'</p></div>';
            return;
        }
        
        var typeNames = {recepcion:'Recepci√≥n',acomodo:'Acomodo',traspaso:'Traspaso',embarque:'Embarque'};
        var icons = {recepcion:'üì•',acomodo:'üìç',traspaso:'üîÑ',embarque:'üì§'};
        
        var html = '<p style="font-size:11px;color:var(--text-light);margin-bottom:10px">'+myMovs.length+' movimientos</p>';
        myMovs.slice(0,50).forEach(function(m){
            var det = '';
            if(m.type==='recepcion') det = 'Bodega: '+m.bodega;
            else if(m.type==='acomodo') det = '‚Üí '+m.location;
            else if(m.type==='traspaso') det = '‚Üí '+m.bodega;
            else if(m.type==='embarque') det = 'Ref: '+(m.referencia||'-');
            
            html += '<div class="history-item"><div class="history-icon '+m.type+'">'+icons[m.type]+'</div>';
            html += '<div class="history-content"><div class="history-code">'+m.equipment.full+'</div>';
            html += '<div class="history-details">'+typeNames[m.type]+' '+det+'</div>';
            html += '<div class="history-meta"><span>'+m.fecha+' '+m.hora+'</span></div>';
            html += '<div class="history-actions">';
            html += '<button class="edit" data-id="'+m.id+'" style="background:var(--info);margin-right:6px">‚úèÔ∏è Editar</button>';
            html += '<button class="delete" data-id="'+m.id+'">üóëÔ∏è Eliminar</button>';
            html += '</div></div></div>';
        });
        
        list.innerHTML = html;
        
        list.querySelectorAll('.edit').forEach(function(btn){
            btn.addEventListener('click', function(){
                openEditModal(btn.dataset.id);
            });
        });
        
        list.querySelectorAll('.delete').forEach(function(btn){
            btn.addEventListener('click', function(){
                deleteMovement(btn.dataset.id);
            });
        });
    }

    function deleteMovement(id){
        if(!confirm('¬øSeguro que quieres eliminar este movimiento?')) return;
        
        var mov = state.movements.find(function(m){ return m.id === id; });
        if(mov && mov.user !== state.currentUser){
            showToast('error','Solo puedes eliminar tus propios movimientos');
            return;
        }
        
        state.movements = state.movements.filter(function(m){ return m.id !== id; });
        state.pendingSync = state.pendingSync.filter(function(m){ return m.id !== id; });
        saveStorage();
        renderMyMovements();
        updateStats();
        showToast('success','Movimiento eliminado');
    }

    // ==================== EXPORT ====================
    function downloadCSV(csv, filename){
        var blob = new Blob(['\ufeff' + csv], {type:'text/csv;charset=utf-8;'});
        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        showToast('success','Archivo descargado');
    }
    
    function exportMovimientosHoy(){
        var today = new Date().toDateString();
        var todayMovs = state.movements.filter(function(m){
            return new Date(m.timestamp).toDateString() === today;
        });
        
        if(!todayMovs.length){
            showToast('warning','No hay movimientos de hoy');
            return;
        }
        
        var typeNames = {recepcion:'Recepcion',acomodo:'Acomodo',traspaso:'Traspaso',embarque:'Embarque'};
        var csv = 'MOVIMIENTOS DEL DIA - ' + new Date().toLocaleDateString('es-MX') + '\n\n';
        csv += 'Hora,Tipo,Usuario,Codigo,Ubicacion/Bodega,Referencia\n';
        
        todayMovs.forEach(function(m){
            var ubicacion = m.location || m.bodega || '';
            var ref = m.referencia || m.motivo || '';
            csv += '"'+m.hora+'","'+typeNames[m.type]+'","'+m.user+'","'+m.equipment.full+'","'+ubicacion+'","'+ref+'"\n';
        });
        
        csv += '\nTotal: ' + todayMovs.length + ' movimientos';
        
        downloadCSV(csv, 'movimientos_hoy_'+new Date().toISOString().slice(0,10)+'.csv');
    }
    
    function exportPendientes(){
        var equipmentStatus = {};
        var sortedMovs = state.movements.slice().sort(function(a,b){
            return new Date(a.timestamp) - new Date(b.timestamp);
        });
        
        sortedMovs.forEach(function(m){
            var code = m.equipment.full;
            if(!equipmentStatus[code]){
                equipmentStatus[code] = { needsAcomodo: false, lastMove: null, equipment: m.equipment };
            }
            equipmentStatus[code].lastMove = m;
            
            if(m.type === 'recepcion' || m.type === 'traspaso'){
                equipmentStatus[code].needsAcomodo = true;
            }else if(m.type === 'acomodo' || m.type === 'embarque'){
                equipmentStatus[code].needsAcomodo = false;
            }
        });
        
        var pending = [];
        for(var code in equipmentStatus){
            if(equipmentStatus[code].needsAcomodo){
                pending.push({
                    code: code,
                    equipment: equipmentStatus[code].equipment,
                    lastMove: equipmentStatus[code].lastMove
                });
            }
        }
        
        if(!pending.length){
            showToast('success','No hay pendientes - todo acomodado');
            return;
        }
        
        var csv = 'PENDIENTES DE ACOMODO - ' + new Date().toLocaleDateString('es-MX') + '\n\n';
        csv += 'Codigo,Prefijo,Serie,Ultimo Movimiento,Bodega,Fecha,Usuario\n';
        
        pending.forEach(function(p){
            var lastType = p.lastMove.type === 'recepcion' ? 'Recepcion' : 'Traspaso';
            csv += '"'+p.code+'","'+p.equipment.prefix+'","'+p.equipment.serie+'","'+lastType+'","'+(p.lastMove.bodega||'')+'","'+p.lastMove.fecha+'","'+p.lastMove.user+'"\n';
        });
        
        csv += '\nTotal: ' + pending.length + ' equipos pendientes';
        
        downloadCSV(csv, 'pendientes_acomodo_'+new Date().toISOString().slice(0,10)+'.csv');
    }
    
    function exportInventario(){
        var equipmentStatus = {};
        var sortedMovs = state.movements.slice().sort(function(a,b){
            return new Date(a.timestamp) - new Date(b.timestamp);
        });
        
        sortedMovs.forEach(function(m){
            var code = m.equipment.full;
            if(!equipmentStatus[code]){
                equipmentStatus[code] = { 
                    equipment: m.equipment,
                    ubicacion: null,
                    bodega: null,
                    embarcado: false,
                    fechaUbicacion: null,
                    usuarioUbicacion: null
                };
            }
            
            if(m.type === 'recepcion'){
                equipmentStatus[code].bodega = m.bodega;
                equipmentStatus[code].embarcado = false;
            }else if(m.type === 'acomodo'){
                equipmentStatus[code].ubicacion = m.location;
                equipmentStatus[code].fechaUbicacion = m.fecha;
                equipmentStatus[code].usuarioUbicacion = m.user;
                equipmentStatus[code].embarcado = false;
            }else if(m.type === 'traspaso'){
                equipmentStatus[code].bodega = m.bodega;
                equipmentStatus[code].ubicacion = null;
                equipmentStatus[code].embarcado = false;
            }else if(m.type === 'embarque'){
                equipmentStatus[code].embarcado = true;
            }
        });
        
        var inventario = [];
        for(var code in equipmentStatus){
            var eq = equipmentStatus[code];
            if(!eq.embarcado){
                inventario.push({
                    code: code,
                    equipment: eq.equipment,
                    ubicacion: eq.ubicacion || 'SIN UBICACION',
                    bodega: eq.bodega || '',
                    fechaUbicacion: eq.fechaUbicacion || '',
                    usuarioUbicacion: eq.usuarioUbicacion || ''
                });
            }
        }
        
        if(!inventario.length){
            showToast('warning','No hay equipos en inventario');
            return;
        }
        
        // Ordenar por ubicacion
        inventario.sort(function(a,b){
            return a.ubicacion.localeCompare(b.ubicacion);
        });
        
        var csv = 'INVENTARIO ACTUAL - ' + new Date().toLocaleDateString('es-MX') + '\n\n';
        csv += 'Codigo,Prefijo,Serie,Ubicacion,Bodega,Fecha Acomodo,Usuario\n';
        
        inventario.forEach(function(i){
            csv += '"'+i.code+'","'+i.equipment.prefix+'","'+i.equipment.serie+'","'+i.ubicacion+'","'+i.bodega+'","'+i.fechaUbicacion+'","'+i.usuarioUbicacion+'"\n';
        });
        
        csv += '\nTotal: ' + inventario.length + ' equipos en inventario';
        
        downloadCSV(csv, 'inventario_'+new Date().toISOString().slice(0,10)+'.csv');
    }

    // ==================== STATS ====================
    function updateStats(){
        var today = new Date().toDateString();
        var todayM = state.movements.filter(function(m){ return new Date(m.timestamp).toDateString() === today; });
        document.getElementById('statToday').textContent = todayM.length;
        
        // Pendientes = equipos recibidos o traspasados que no tienen acomodo posterior
        var pendingCount = countPendingAcomodo();
        document.getElementById('statPending').textContent = pendingCount;
        
        document.getElementById('statTotal').textContent = state.movements.length;
    }
    
    function countPendingAcomodo(){
        // Construir estado de cada equipo
        var equipmentStatus = {};
        
        // Procesar movimientos en orden cronologico (mas antiguos primero)
        var sortedMovs = state.movements.slice().sort(function(a,b){
            return new Date(a.timestamp) - new Date(b.timestamp);
        });
        
        sortedMovs.forEach(function(m){
            var code = m.equipment.full;
            if(!equipmentStatus[code]){
                equipmentStatus[code] = { needsAcomodo: false, lastType: null };
            }
            
            if(m.type === 'recepcion'){
                // Recepcion = necesita acomodo
                equipmentStatus[code].needsAcomodo = true;
                equipmentStatus[code].lastType = 'recepcion';
            }else if(m.type === 'acomodo'){
                // Acomodo = ya no necesita
                equipmentStatus[code].needsAcomodo = false;
                equipmentStatus[code].lastType = 'acomodo';
            }else if(m.type === 'traspaso'){
                // Traspaso = necesita reacomodo
                equipmentStatus[code].needsAcomodo = true;
                equipmentStatus[code].lastType = 'traspaso';
            }else if(m.type === 'embarque'){
                // Embarque = ya salio, no cuenta
                equipmentStatus[code].needsAcomodo = false;
                equipmentStatus[code].lastType = 'embarque';
            }
        });
        
        // Contar cuantos necesitan acomodo
        var count = 0;
        for(var code in equipmentStatus){
            if(equipmentStatus[code].needsAcomodo) count++;
        }
        return count;
    }

    function updatePending(){
        var b = document.getElementById('pendingBadge');
        var c = countPendingAcomodo();
        document.getElementById('pendingCount').textContent = c;
        b.classList.toggle('show', c > 0);
    }

    // ==================== TOAST ====================
    function showToast(type, msg){
        var t = document.getElementById('toast');
        t.className = 'toast ' + type;
        document.getElementById('toastMessage').textContent = msg;
        t.classList.add('show');
        setTimeout(function(){ t.classList.remove('show'); }, 3000);
    }

    // ==================== AUDIT ====================
    function getAvailableEquipment(){
        var equipmentStatus = {};
        state.movements.forEach(function(m){
            var code = m.equipment.full;
            if(!equipmentStatus[code]) equipmentStatus[code] = {moves:[], lastMove:null};
            equipmentStatus[code].moves.push(m);
            if(!equipmentStatus[code].lastMove || new Date(m.timestamp) > new Date(equipmentStatus[code].lastMove.timestamp)){
                equipmentStatus[code].lastMove = m;
            }
        });
        
        var available = [];
        for(var code in equipmentStatus){
            var eq = equipmentStatus[code];
            if(eq.lastMove.type !== 'embarque'){
                var acomodoMove = null;
                for(var j=0; j<eq.moves.length; j++){
                    if(eq.moves[j].type === 'acomodo'){ acomodoMove = eq.moves[j]; break; }
                }
                if(acomodoMove){
                    available.push({
                        code: code, equipment: eq.lastMove.equipment,
                        location: acomodoMove.location, acomodoDate: acomodoMove.fecha, acomodoUser: acomodoMove.user
                    });
                }
            }
        }
        return available;
    }

    function getYesterdayReceptions(){
        var yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        var yesterdayStr = yesterday.toDateString();
        return state.movements.filter(function(m){
            return m.type === 'recepcion' && new Date(m.timestamp).toDateString() === yesterdayStr;
        });
    }

    function shuffleArray(arr){
        var a = arr.slice();
        for(var i = a.length - 1; i > 0; i--){
            var j = Math.floor(Math.random() * (i + 1));
            var temp = a[i]; a[i] = a[j]; a[j] = temp;
        }
        return a;
    }

    function generateAuditSample(){
        var yesterdayReceps = getYesterdayReceptions();
        var availableWithLocation = getAvailableEquipment();
        
        if(yesterdayReceps.length === 0 && availableWithLocation.length === 0){
            showToast('warning','No hay datos para muestreo');
            return;
        }
        
        var sample = [];
        var auditId = Date.now().toString(36);
        var now = new Date();
        
        var recepSampleSize = Math.max(1, Math.ceil(yesterdayReceps.length * 0.15));
        var shuffledReceps = shuffleArray(yesterdayReceps);
        
        for(var i=0; i<Math.min(recepSampleSize, shuffledReceps.length); i++){
            var m = shuffledReceps[i];
            var eq = null;
            for(var j=0; j<availableWithLocation.length; j++){
                if(availableWithLocation[j].code === m.equipment.full){ eq = availableWithLocation[j]; break; }
            }
            sample.push({
                id: auditId + '-' + sample.length, code: m.equipment.full, equipment: m.equipment,
                type: 'recepcion', expectedLocation: eq ? eq.location : m.bodega,
                sourceDate: m.fecha, sourceUser: m.user, result: null
            });
        }
        
        var alreadyIn = {};
        sample.forEach(function(s){ alreadyIn[s.code] = true; });
        var filteredAvail = availableWithLocation.filter(function(a){ return !alreadyIn[a.code]; });
        var shuffledAvail = shuffleArray(filteredAvail);
        
        for(var k=0; k<Math.min(3, shuffledAvail.length); k++){
            var eq = shuffledAvail[k];
            sample.push({
                id: auditId + '-' + sample.length, code: eq.code, equipment: eq.equipment,
                type: 'acomodo', expectedLocation: eq.location,
                sourceDate: eq.acomodoDate, sourceUser: eq.acomodoUser, result: null
            });
        }
        
        var fechaStr = now.toLocaleDateString('es-MX');
        state.currentAudit = { id: auditId, date: now.toISOString(), dateStr: fechaStr, samples: sample };
        renderAuditSample();
        showToast('success', sample.length + ' series para verificar');
    }

    function renderAuditSample(){
        var list = document.getElementById('auditSampleList');
        var finishBtn = document.getElementById('finishAuditBtn');
        var now = new Date();
        
        if(!state.currentAudit || state.currentAudit.samples.length === 0){
            document.getElementById('auditDate').textContent = now.toLocaleDateString('es-MX');
            document.getElementById('auditSampleSize').textContent = '0';
            list.innerHTML = '<div style="background:var(--info-bg);padding:20px;border-radius:12px;text-align:center"><p style="color:var(--info);font-weight:700">Sin muestra activa</p><p style="font-size:12px;color:var(--text-light)">Presiona generar muestra</p></div>';
            finishBtn.classList.add('hidden');
            return;
        }
        
        document.getElementById('auditDate').textContent = state.currentAudit.dateStr;
        document.getElementById('auditSampleSize').textContent = state.currentAudit.samples.length;
        
        var html = '';
        state.currentAudit.samples.forEach(function(s, idx){
            var typeLabel = s.type === 'recepcion' ? 'Recepcion' : 'Acomodo';
            html += '<div style="background:white;border-radius:12px;margin-bottom:10px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.08)">';
            html += '<div style="padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">';
            html += '<span style="font-family:monospace;font-weight:700">'+s.code+'</span>';
            html += '<span style="font-size:10px;padding:3px 8px;border-radius:10px;background:'+(s.type==='recepcion'?'var(--success-bg)':'var(--info-bg)')+';color:'+(s.type==='recepcion'?'var(--success)':'var(--info)')+'">'+typeLabel+'</span>';
            html += '</div><div style="padding:12px">';
            html += '<p style="font-size:13px;margin-bottom:8px">Ubicacion: <strong style="color:var(--primary)">'+s.expectedLocation+'</strong></p>';
            html += '<p style="font-size:11px;color:var(--text-light)">Registro: '+s.sourceDate+' por '+s.sourceUser+'</p>';
            
            if(s.result !== null){
                html += '<div style="padding:8px 12px;border-radius:8px;margin-top:8px;text-align:center;background:'+(s.result?'var(--success-bg)':'var(--error-bg)')+';color:'+(s.result?'var(--success)':'var(--error)')+';font-weight:600">'+(s.result?'ENCONTRADO':'NO ENCONTRADO')+'</div>';
            }else{
                html += '<div style="display:flex;gap:8px;margin-top:12px">';
                html += '<button data-idx="'+idx+'" data-result="1" style="flex:1;padding:10px;border-radius:8px;border:none;background:var(--success);color:white;font-weight:700;cursor:pointer">Si</button>';
                html += '<button data-idx="'+idx+'" data-result="0" style="flex:1;padding:10px;border-radius:8px;border:none;background:var(--error);color:white;font-weight:700;cursor:pointer">No</button>';
                html += '</div>';
            }
            html += '</div></div>';
        });
        
        list.innerHTML = html;
        
        list.querySelectorAll('button[data-idx]').forEach(function(btn){
            btn.addEventListener('click', function(){
                var idx = parseInt(btn.dataset.idx);
                var result = btn.dataset.result === '1';
                state.currentAudit.samples[idx].result = result;
                renderAuditSample();
                showToast(result ? 'success' : 'warning', result ? 'Encontrado' : 'No encontrado');
            });
        });
        
        var allDone = state.currentAudit.samples.every(function(s){ return s.result !== null; });
        if(allDone) finishBtn.classList.remove('hidden');
        else finishBtn.classList.add('hidden');
    }

    function finishAudit(){
        if(!state.currentAudit) return;
        var total = state.currentAudit.samples.length;
        var found = state.currentAudit.samples.filter(function(s){ return s.result === true; }).length;
        var pct = total > 0 ? Math.round((found / total) * 100) : 0;
        
        state.auditResults.unshift({
            id: state.currentAudit.id, date: state.currentAudit.date, dateStr: state.currentAudit.dateStr,
            total: total, found: found, notFound: total - found, percentage: pct, samples: state.currentAudit.samples
        });
        state.currentAudit = null;
        saveStorage();
        showToast('success', 'Auditoria: ' + pct + '%');
        renderAuditSample();
        openModule('metric');
    }

    function renderMetric(){
        var metricValue = document.getElementById('metricValue');
        var metricBar = document.getElementById('metricBar');
        var metricDetail = document.getElementById('metricDetail');
        var historyList = document.getElementById('auditHistoryList');
        
        if(state.auditResults.length === 0){
            metricValue.textContent = '--%';
            metricValue.style.color = 'var(--text-light)';
            metricBar.style.width = '0%';
            metricDetail.textContent = 'Sin datos. Genera una muestra.';
            historyList.innerHTML = '<p style="text-align:center;color:var(--text-light);font-size:12px;padding:20px">No hay auditorias</p>';
            return;
        }
        
        var recentCount = Math.min(state.auditResults.length, 4);
        var sum = 0;
        for(var i=0; i<recentCount; i++) sum += state.auditResults[i].percentage;
        var avg = Math.round(sum / recentCount);
        
        metricValue.textContent = avg + '%';
        metricBar.style.width = avg + '%';
        
        if(avg >= 90){ metricValue.style.color = 'var(--success)'; metricBar.style.background = 'var(--success)'; }
        else if(avg >= 80){ metricValue.style.color = 'var(--warning)'; metricBar.style.background = 'var(--warning)'; }
        else{ metricValue.style.color = 'var(--error)'; metricBar.style.background = 'var(--error)'; }
        
        var last = state.auditResults[0];
        metricDetail.textContent = 'Ultima: ' + last.dateStr + ' | ' + last.found + '/' + last.total;
        
        var html = '';
        var histCount = Math.min(state.auditResults.length, 10);
        for(var j=0; j<histCount; j++){
            var a = state.auditResults[j];
            var color = a.percentage >= 90 ? 'var(--success)' : (a.percentage >= 80 ? 'var(--warning)' : 'var(--error)');
            html += '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px"><span>'+a.dateStr+'</span><span style="font-weight:700;color:'+color+'">'+a.percentage+'% ('+a.found+'/'+a.total+')</span></div>';
        }
        historyList.innerHTML = html;
    }

    // ==================== CARGA MASIVA (EXCEL) ====================
    var pendingExcelData = [];
    
    function resetCargaMasiva(){
        pendingExcelData = [];
        document.getElementById('fileInfo').classList.add('hidden');
        document.getElementById('previewSection').classList.add('hidden');
        document.getElementById('progressSection').classList.add('hidden');
        document.getElementById('xlsxFileInput').value = '';
    }
    
    function handleExcelFile(e){
        var file = e.target.files[0];
        if(!file) return;
        
        document.getElementById('fileName').textContent = file.name;
        
        var reader = new FileReader();
        reader.onload = function(event){
            try{
                var data = new Uint8Array(event.target.result);
                var workbook = XLSX.read(data, {type: 'array'});
                var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                var jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                parseExcelData(jsonData);
            }catch(err){
                showToast('error', 'Error al leer archivo Excel');
                console.error(err);
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    function parseExcelData(rows){
        pendingExcelData = [];
        
        // Buscar indices de columnas
        var headerRow = rows[0] || [];
        var serieIdx = -1, ubicacionIdx = -1, fechaIdx = -1;
        
        for(var i=0; i<headerRow.length; i++){
            var h = String(headerRow[i]).toUpperCase().trim();
            if(h === 'SERIE' || h === 'CODIGO' || h === 'CODE') serieIdx = i;
            if(h === 'UBICACION' || h === 'UBICACI√ìN' || h === 'LOCATION') ubicacionIdx = i;
            if(h.indexOf('FECHA') !== -1 || h.indexOf('DATE') !== -1) fechaIdx = i;
        }
        
        // Si no encontr√≥ headers, asumir orden: Serie, Ubicacion, Fecha
        if(serieIdx === -1) serieIdx = 0;
        if(ubicacionIdx === -1) ubicacionIdx = 1;
        if(fechaIdx === -1) fechaIdx = 2;
        
        // Procesar filas (saltar header)
        for(var r=1; r<rows.length; r++){
            var row = rows[r];
            if(!row || !row[serieIdx]) continue;
            
            var serieRaw = String(row[serieIdx]).trim().toUpperCase();
            var ubicacion = row[ubicacionIdx] ? String(row[ubicacionIdx]).trim().toUpperCase() : '';
            var fechaRaw = row[fechaIdx] || '';
            
            if(!ubicacion) continue;
            
            // Parsear codigo (puede ser completo o solo serie)
            var parsed = parseCode(serieRaw);
            if(!parsed){
                // Intentar como solo serie numerica
                var cleanSerie = serieRaw.replace(/\D/g, '');
                if(cleanSerie.length >= 8 && cleanSerie.length <= 9){
                    parsed = {
                        prefix: 'SERIE',
                        serie: cleanSerie.padStart(9, '0'),
                        full: 'SERIE-' + cleanSerie.padStart(9, '0')
                    };
                }
            }
            
            if(parsed){
                // Parsear fecha
                var fechaStr = '';
                if(fechaRaw){
                    if(typeof fechaRaw === 'number'){
                        // Excel date serial
                        var excelDate = new Date((fechaRaw - 25569) * 86400 * 1000);
                        fechaStr = excelDate.toLocaleDateString('es-MX');
                    }else{
                        fechaStr = String(fechaRaw);
                    }
                }
                
                pendingExcelData.push({
                    equipment: parsed,
                    location: ubicacion,
                    fechaOriginal: fechaStr
                });
            }
        }
        
        document.getElementById('seriesCount').textContent = pendingExcelData.length;
        document.getElementById('fileInfo').classList.remove('hidden');
        
        if(pendingExcelData.length > 0){
            renderExcelPreview();
            document.getElementById('previewSection').classList.remove('hidden');
            document.getElementById('processCount').textContent = pendingExcelData.length;
        }else{
            document.getElementById('previewSection').classList.add('hidden');
            showToast('error', 'No se encontraron series v√°lidas');
        }
    }
    
    function renderExcelPreview(){
        var list = document.getElementById('previewList');
        var html = '';
        var previewCount = Math.min(pendingExcelData.length, 10);
        
        for(var i=0; i<previewCount; i++){
            var item = pendingExcelData[i];
            html += '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:11px">';
            html += '<span style="font-family:monospace;font-weight:600">'+item.equipment.full+'</span>';
            html += '<span style="color:var(--primary)">'+item.location+'</span>';
            if(item.fechaOriginal) html += '<span style="color:var(--text-light);font-size:10px">'+item.fechaOriginal+'</span>';
            html += '</div>';
        }
        
        if(pendingExcelData.length > 10){
            html += '<p style="text-align:center;color:var(--text-light);font-size:11px;padding:8px">... y '+(pendingExcelData.length-10)+' m√°s</p>';
        }
        
        list.innerHTML = html;
    }
    
    function processExcelFile(){
        if(!pendingExcelData.length){
            showToast('error', 'No hay datos para procesar');
            return;
        }
        
        if(!confirm('¬øProcesar '+pendingExcelData.length+' series como Captura General?')){
            return;
        }
        
        document.getElementById('previewSection').classList.add('hidden');
        document.getElementById('progressSection').classList.remove('hidden');
        document.getElementById('progressTotal').textContent = pendingExcelData.length;
        
        var total = pendingExcelData.length;
        var processed = 0;
        var batchSize = 100;
        var currentIndex = 0;
        
        var now = new Date();
        var fechaHoy = now.toLocaleDateString('es-MX');
        var horaHoy = now.toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
        
        function processBatch(){
            var endIndex = Math.min(currentIndex + batchSize, total);
            
            for(var i=currentIndex; i<endIndex; i++){
                var item = pendingExcelData[i];
                
                var mov = {
                    id: now.getTime().toString(36) + '-' + i + '-' + Math.random().toString(36).substr(2,4),
                    timestamp: now.toISOString(),
                    fecha: item.fechaOriginal || fechaHoy,
                    hora: horaHoy,
                    type: 'acomodo',
                    user: 'Captura General',
                    equipment: item.equipment,
                    location: item.location,
                    synced: false,
                    isBulkLoad: true,
                    fechaOriginalUbicacion: item.fechaOriginal || fechaHoy
                };
                
                state.movements.push(mov);
                processed++;
            }
            
            currentIndex = endIndex;
            var percent = Math.round((processed / total) * 100);
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = processed;
            
            if(currentIndex < total){
                setTimeout(processBatch, 10);
            }else{
                saveStorage();
                updateStats();
                pendingExcelData = [];
                
                setTimeout(function(){
                    document.getElementById('progressSection').classList.add('hidden');
                    document.getElementById('fileInfo').classList.add('hidden');
                    document.getElementById('xlsxFileInput').value = '';
                    showToast('success', processed + ' series cargadas correctamente');
                }, 500);
            }
        }
        
        processBatch();
    }

    // ==================== DASHBOARD ====================
    function renderDashboard(){
        var dateInput = document.getElementById('dashboardDate');
        if(!dateInput.value){
            dateInput.value = new Date().toISOString().slice(0,10);
        }
        
        var selectedDate = new Date(dateInput.value + 'T00:00:00');
        var selectedDateStr = selectedDate.toDateString();
        
        var dayMovs = state.movements.filter(function(m){
            return new Date(m.timestamp).toDateString() === selectedDateStr;
        });
        
        var dayRecepcion = dayMovs.filter(function(m){ return m.type === 'recepcion'; }).length;
        var dayAcomodo = dayMovs.filter(function(m){ return m.type === 'acomodo'; }).length;
        var dayTraspaso = dayMovs.filter(function(m){ return m.type === 'traspaso'; }).length;
        var dayEmbarque = dayMovs.filter(function(m){ return m.type === 'embarque'; }).length;
        
        document.getElementById('dashRecepcion').textContent = dayRecepcion;
        document.getElementById('dashAcomodo').textContent = dayAcomodo;
        document.getElementById('dashTraspaso').textContent = dayTraspaso;
        document.getElementById('dashEmbarque').textContent = dayEmbarque;
        document.getElementById('dashTotal').textContent = dayMovs.length;
        
        // Acumulado general
        var totalRecepcion = state.movements.filter(function(m){ return m.type === 'recepcion'; }).length;
        var totalAcomodo = state.movements.filter(function(m){ return m.type === 'acomodo'; }).length;
        var totalTraspaso = state.movements.filter(function(m){ return m.type === 'traspaso'; }).length;
        var totalEmbarque = state.movements.filter(function(m){ return m.type === 'embarque'; }).length;
        
        document.getElementById('dashTotalRecepcion').textContent = totalRecepcion;
        document.getElementById('dashTotalAcomodo').textContent = totalAcomodo;
        document.getElementById('dashTotalTraspaso').textContent = totalTraspaso;
        document.getElementById('dashTotalEmbarque').textContent = totalEmbarque;
        document.getElementById('dashTotalGeneral').textContent = state.movements.length;
    }

    // ==================== MIS MOVIMIENTOS EDIT/QR ====================
    var misMovsQRScanner = null;
    
    function openMisMovsQRScanner(){
        if(typeof Html5Qrcode === 'undefined'){ showToast('warning','C√°mara no disponible'); return; }
        document.getElementById('misMovsQRModal').classList.add('show');
        setTimeout(function(){
            try{
                if(misMovsQRScanner) try{ misMovsQRScanner.stop(); }catch(e){}
                misMovsQRScanner = new Html5Qrcode('mis-movs-qr-scanner');
                misMovsQRScanner.start(
                    {facingMode:'environment'},
                    {fps:10, qrbox:{width:250, height:150}},
                    function(code){
                        if(navigator.vibrate) navigator.vibrate(100);
                        document.getElementById('misMovsSearch').value = code;
                        closeMisMovsQRScanner();
                        renderMyMovements(code);
                    },
                    function(){}
                ).catch(function(){});
            }catch(e){}
        }, 300);
    }
    
    function closeMisMovsQRScanner(){
        if(misMovsQRScanner) try{ misMovsQRScanner.stop(); }catch(e){}
        document.getElementById('misMovsQRModal').classList.remove('show');
    }
    
    function openEditModal(movId){
        var mov = state.movements.find(function(m){ return m.id === movId; });
        if(!mov) return;
        
        document.getElementById('editMovId').value = movId;
        document.getElementById('editCodigo').value = mov.equipment.full;
        document.getElementById('editTipo').value = mov.type.charAt(0).toUpperCase() + mov.type.slice(1);
        
        // Mostrar/ocultar campos segun tipo
        document.getElementById('editUbicacionGroup').classList.add('hidden');
        document.getElementById('editBodegaGroup').classList.add('hidden');
        document.getElementById('editReferenciaGroup').classList.add('hidden');
        
        if(mov.type === 'acomodo'){
            document.getElementById('editUbicacionGroup').classList.remove('hidden');
            document.getElementById('editUbicacion').value = mov.location || '';
        }else if(mov.type === 'recepcion' || mov.type === 'traspaso'){
            document.getElementById('editBodegaGroup').classList.remove('hidden');
            document.getElementById('editBodega').value = mov.bodega || 'B6';
        }else if(mov.type === 'embarque'){
            document.getElementById('editReferenciaGroup').classList.remove('hidden');
            document.getElementById('editReferencia').value = mov.referencia || '';
        }
        
        document.getElementById('editModal').classList.add('show');
    }
    
    function closeEditModal(){
        document.getElementById('editModal').classList.remove('show');
    }
    
    function saveEditMovement(){
        var movId = document.getElementById('editMovId').value;
        var mov = state.movements.find(function(m){ return m.id === movId; });
        if(!mov) return;
        
        if(mov.type === 'acomodo'){
            var newLoc = document.getElementById('editUbicacion').value.trim().toUpperCase();
            if(!newLoc){ showToast('error','Ubicaci√≥n requerida'); return; }
            mov.location = newLoc;
        }else if(mov.type === 'recepcion' || mov.type === 'traspaso'){
            mov.bodega = document.getElementById('editBodega').value;
        }else if(mov.type === 'embarque'){
            mov.referencia = document.getElementById('editReferencia').value.trim();
        }
        
        saveStorage();
        closeEditModal();
        renderMyMovements(document.getElementById('misMovsSearch').value);
        showToast('success','Movimiento actualizado');
    }

    // ==================== ACOMODO M√öLTIPLE ====================
    var acomodoMultipleItems = []; // {equipment, location}
    var acomodoSerieScanner = null;

    function agregarAcomodoMultiple(){
        var loc = document.getElementById('acomodoLocation').value.trim().toUpperCase();
        var serieInput = document.getElementById('acomodoSerieInput').value.trim().toUpperCase();
        
        if(!loc){ showToast('error','Escribe la ubicaci√≥n'); return; }
        if(!serieInput){ showToast('error','Escribe o escanea la serie'); return; }
        
        var parsed = parseCode(serieInput);
        if(!parsed){ showToast('error','C√≥digo no v√°lido'); return; }
        
        // Verificar duplicado en lista actual
        if(acomodoMultipleItems.some(function(i){ return i.equipment.full === parsed.full; })){
            showToast('warning','Esta serie ya est√° en la lista');
            return;
        }
        
        acomodoMultipleItems.push({
            equipment: parsed,
            location: loc
        });
        
        playBeep();
        renderAcomodoMultipleList();
        document.getElementById('acomodoSerieInput').value = '';
        // No limpiar ubicaci√≥n para permitir agregar varias a la misma
    }
    
    function renderAcomodoMultipleList(){
        var container = document.getElementById('acomodoItems');
        var count = document.getElementById('acomodoCount');
        var btn = document.getElementById('acomodoConfirmBtn');
        
        count.textContent = acomodoMultipleItems.length;
        btn.disabled = acomodoMultipleItems.length === 0;
        
        if(!acomodoMultipleItems.length){
            container.innerHTML = '<div class="empty-list">Agrega equipos con su ubicaci√≥n</div>';
            return;
        }
        
        var html = '';
        acomodoMultipleItems.forEach(function(item, idx){
            html += '<div class="scanned-item" style="flex-direction:column;align-items:flex-start;gap:4px">';
            html += '<div style="display:flex;justify-content:space-between;width:100%">';
            html += '<span class="code">'+item.equipment.full+'</span>';
            html += '<button class="remove-btn" onclick="removeAcomodoItem('+idx+')">√ó</button>';
            html += '</div>';
            html += '<span style="font-size:11px;color:var(--primary)">üìç '+item.location+'</span>';
            html += '</div>';
        });
        container.innerHTML = html;
    }
    window.removeAcomodoItem = function(idx){
        acomodoMultipleItems.splice(idx, 1);
        renderAcomodoMultipleList();
    };
    
    function confirmAcomodoMultiple(){
        if(!acomodoMultipleItems.length) return;
        
        acomodoMultipleItems.forEach(function(item){
            saveMovement('acomodo', item.equipment, {location: item.location});
        });
        
        playBeep();
        showToast('success', acomodoMultipleItems.length + ' equipos acomodados');
        acomodoMultipleItems = [];
        renderAcomodoMultipleList();
        document.getElementById('acomodoLocation').value = '';
        document.getElementById('acomodoSerieInput').value = '';
    }
    
    function openAcomodoSerieScan(){
        if(typeof Html5Qrcode === 'undefined'){ showToast('warning','C√°mara no disponible'); return; }
        // Usar el scanner existente de QR para series
        var modal = document.createElement('div');
        modal.id = 'acomodoSerieScanModal';
        modal.className = 'qr-modal show';
        modal.innerHTML = '<div class="scanner-header" style="background:transparent;border:none"><button class="back-btn" onclick="closeAcomodoSerieScan()" style="background:rgba(255,255,255,0.2);color:white">‚Üê</button><h2 class="scanner-title" style="color:white">Escanear Serie</h2></div><div style="flex:1;display:flex;align-items:center;justify-content:center;padding:20px"><div class="scanner-box" style="width:100%;max-width:400px"><div class="scanner-region" id="acomodo-serie-scanner"></div></div></div>';
        document.body.appendChild(modal);
        
        setTimeout(function(){
            try{
                acomodoSerieScanner = new Html5Qrcode('acomodo-serie-scanner');
                acomodoSerieScanner.start(
                    {facingMode:'environment'},
                    {fps:10,qrbox:{width:250,height:150}},
                    function(code){
                        playBeep();
                        document.getElementById('acomodoSerieInput').value = code;
                        closeAcomodoSerieScan();
                    },
                    function(){}
                ).catch(function(){});
            }catch(e){}
        }, 300);
    }
    window.closeAcomodoSerieScan = function(){
        if(acomodoSerieScanner) try{ acomodoSerieScanner.stop(); }catch(e){}
        var modal = document.getElementById('acomodoSerieScanModal');
        if(modal) modal.remove();
    };

    // ==================== CAMBIO 4: SONIDO CONFIRMACI√ìN ====================
    function playBeep(){
        try{
            var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            var oscillator = audioCtx.createOscillator();
            var gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.frequency.value = 1200;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.15);
        }catch(e){}
        if(navigator.vibrate) navigator.vibrate(100);
    }

    // ==================== CAMBIO 5: TOGGLE LOCK FIELD ====================
    function toggleLockField(fieldId){
        var input = document.getElementById(fieldId);
        var btn = document.getElementById(fieldId + 'LockBtn');
        if(!input || !btn) return;
        if(btn.classList.contains('locked')){
            btn.classList.remove('locked');
            btn.textContent = 'üîì';
            input.disabled = false;
        }else{
            btn.classList.add('locked');
            btn.textContent = 'üîí';
            input.disabled = true;
        }
    }

    // ==================== CAMBIO 7: CALIDAD SALIDAS ====================
    var calidadScannedItems = [];
    var calidadScanner = null;
    var calidadLastResult = null;

    function loadCalidadScannedItems(){
        var today = new Date().toISOString().slice(0,10);
        var saved = JSON.parse(localStorage.getItem('calidadScannedItems') || '{}');
        if(saved.fecha === today && saved.items){
            calidadScannedItems = saved.items;
        }else{
            calidadScannedItems = [];
        }
    }
    
    function saveCalidadScannedItems(){
        var today = new Date().toISOString().slice(0,10);
        localStorage.setItem('calidadScannedItems', JSON.stringify({
            fecha: today,
            items: calidadScannedItems
        }));
    }

    function initCalidadScanner(){
        loadCalidadScannedItems();
        renderCalidadList();
        if(calidadScanner) return;
        if(typeof Html5Qrcode === 'undefined') return;
        setTimeout(function(){
            try{
                calidadScanner = new Html5Qrcode('calidad-scanner');
                calidadScanner.start(
                    {facingMode:'environment'},
                    {fps:10,qrbox:{width:250,height:150}},
                    function(code){
                        var parsed = parseCode(code);
                        if(parsed && !calidadScannedItems.some(function(i){return i.full===parsed.full;})){
                            calidadScannedItems.push(parsed);
                            saveCalidadScannedItems();
                            playBeep();
                            renderCalidadList();
                        }
                    },
                    function(){}
                ).catch(function(){});
            }catch(e){}
        },300);
    }

    function addManualCalidad(){
        var input = document.getElementById('calidadManualInput');
        var code = input.value.trim().toUpperCase();
        if(!code) return;
        var parsed = parseCode(code);
        if(!parsed){ showToast('error','C√≥digo no v√°lido'); return; }
        if(calidadScannedItems.some(function(i){return i.full===parsed.full;})){ showToast('warning','Ya escaneado'); return; }
        calidadScannedItems.push(parsed);
        saveCalidadScannedItems();
        playBeep();
        renderCalidadList();
        input.value = '';
    }

    function renderCalidadList(){
        var container = document.getElementById('calidadItems');
        var count = document.getElementById('calidadCount');
        var btn = document.getElementById('calidadCompararBtn');
        count.textContent = calidadScannedItems.length;
        btn.disabled = calidadScannedItems.length === 0;
        if(!calidadScannedItems.length){
            container.innerHTML = '<div class="empty-list">Escanea series de hojas impresas</div>';
            return;
        }
        var html = '';
        calidadScannedItems.forEach(function(item, idx){
            html += '<div class="scanned-item"><span class="code">'+item.full+'</span>';
            html += '<button class="remove-btn" onclick="removeCalidadItem('+idx+')">√ó</button></div>';
        });
        container.innerHTML = html;
    }
    window.removeCalidadItem = function(idx){
        calidadScannedItems.splice(idx, 1);
        saveCalidadScannedItems();
        renderCalidadList();
    };

    function compararCalidadSalidas(){
        var fecha = document.getElementById('calidadFecha').value;
        if(!fecha){ fecha = new Date().toISOString().slice(0,10); document.getElementById('calidadFecha').value = fecha; }
        var embarquesDelDia = state.movements.filter(function(m){ return m.type === 'embarque' && m.timestamp.slice(0,10) === fecha; });
        var seriesHojas = calidadScannedItems.map(function(i){ return i.serie; });
        var seriesSistema = embarquesDelDia.map(function(m){ return m.equipment.serie; });
        var coinciden = [], soloHojas = [], soloSistema = [];
        seriesHojas.forEach(function(s){ if(seriesSistema.indexOf(s) !== -1) coinciden.push(s); else soloHojas.push(s); });
        seriesSistema.forEach(function(s){ if(seriesHojas.indexOf(s) === -1) soloSistema.push(s); });
        document.getElementById('calidadCoinciden').textContent = coinciden.length;
        document.getElementById('calidadSoloHojas').textContent = soloHojas.length;
        document.getElementById('calidadSoloSistema').textContent = soloSistema.length;
        document.getElementById('calidadSoloHojasList').innerHTML = soloHojas.length ? soloHojas.join(', ') : '-';
        document.getElementById('calidadSoloSistemaList').innerHTML = soloSistema.length ? soloSistema.join(', ') : '-';
        document.getElementById('calidadResultados').classList.remove('hidden');
        calidadLastResult = {fecha:fecha,timestamp:new Date().toISOString(),user:state.currentUser,totalHojas:seriesHojas.length,totalSistema:seriesSistema.length,coinciden:coinciden,soloHojas:soloHojas,soloSistema:soloSistema};
        var reportes = JSON.parse(localStorage.getItem('calidadReportes') || '[]');
        reportes.unshift(calidadLastResult);
        localStorage.setItem('calidadReportes', JSON.stringify(reportes.slice(0,100)));
        playBeep();
        showToast('success','Comparaci√≥n completada');
    }

    function exportarCalidadSalidas(){
        if(!calidadLastResult){ showToast('warning','Primero realiza una comparaci√≥n'); return; }
        var r = calidadLastResult;
        var csv = 'REPORTE CALIDAD SALIDAS\nFecha Embarques:,'+r.fecha+'\nGenerado:,'+new Date(r.timestamp).toLocaleString('es-MX')+'\nUsuario:,'+r.user+'\n\nRESUMEN\nTotal en hojas:,'+r.totalHojas+'\nTotal en sistema:,'+r.totalSistema+'\nCoinciden:,'+r.coinciden.length+'\nSolo en hojas:,'+r.soloHojas.length+'\nSolo en sistema:,'+r.soloSistema.length+'\n\n';
        if(r.soloHojas.length){ csv += 'SERIES SOLO EN HOJAS\n'; r.soloHojas.forEach(function(s){ csv += s + '\n'; }); csv += '\n'; }
        if(r.soloSistema.length){ csv += 'SERIES SOLO EN SISTEMA\n'; r.soloSistema.forEach(function(s){ csv += s + '\n'; }); }
        downloadCSV(csv, 'calidad_salidas_'+r.fecha+'.csv');
    }

    function filtrarCalidadReportes(){
        var desde = document.getElementById('calidadReportesDateFrom').value;
        var hasta = document.getElementById('calidadReportesDateTo').value;
        var reportes = JSON.parse(localStorage.getItem('calidadReportes') || '[]');
        var filtered = reportes.filter(function(r){ var f = r.fecha; return (!desde || f >= desde) && (!hasta || f <= hasta); });
        var container = document.getElementById('calidadReportesList');
        if(!filtered.length){ container.innerHTML = '<div class="empty-state"><p>No hay reportes</p></div>'; return; }
        var html = '';
        filtered.forEach(function(r){
            var pct = r.totalHojas > 0 ? Math.round((r.coinciden.length / r.totalHojas) * 100) : 0;
            var color = r.soloHojas.length === 0 && r.soloSistema.length === 0 ? 'var(--success)' : 'var(--warning)';
            html += '<div class="config-card" style="margin-bottom:12px">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center">';
            html += '<div><strong>'+r.fecha+'</strong><br><span style="font-size:11px;color:var(--text-light)">'+r.user+' - '+(new Date(r.timestamp).toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'}))+'</span></div>';
            html += '<div style="text-align:right;color:'+color+';font-weight:700;font-size:18px">'+pct+'%</div>';
            html += '</div>';
            html += '<div style="display:flex;gap:10px;margin-top:8px;font-size:12px">';
            html += '<span style="color:var(--success)">‚úÖ '+r.coinciden.length+' OK</span>';
            html += '<span style="color:var(--warning)">‚ö†Ô∏è '+r.soloHojas.length+' solo hojas</span>';
            html += '<span style="color:var(--error)">‚ùå '+r.soloSistema.length+' solo sistema</span>';
            html += '</div>';
            if(r.soloHojas.length > 0){
                html += '<div style="margin-top:8px;padding:8px;background:var(--warning-bg);border-radius:6px;font-size:11px">';
                html += '<strong style="color:#92400e">En hojas pero NO en sistema:</strong><br>';
                html += '<span style="font-family:monospace">'+r.soloHojas.join(', ')+'</span>';
                html += '</div>';
            }
            if(r.soloSistema.length > 0){
                html += '<div style="margin-top:8px;padding:8px;background:var(--error-bg);border-radius:6px;font-size:11px">';
                html += '<strong style="color:var(--error)">En sistema pero NO en hojas:</strong><br>';
                html += '<span style="font-family:monospace">'+r.soloSistema.join(', ')+'</span>';
                html += '</div>';
            }
            html += '</div>';
        });
        container.innerHTML = html;
    }

    // ==================== CAMBIO 10: INCIDENCIAS ====================
    var incidenciaScanner = null;

    function openIncidenciaScan(){
        if(typeof Html5Qrcode === 'undefined'){ showToast('warning','C√°mara no disponible'); return; }
        document.getElementById('incidenciaScanModal').classList.add('show');
        setTimeout(function(){
            try{
                if(incidenciaScanner) try{ incidenciaScanner.stop(); }catch(e){}
                incidenciaScanner = new Html5Qrcode('incidencia-scanner');
                incidenciaScanner.start({facingMode:'environment'},{fps:10,qrbox:{width:250,height:150}},function(code){ playBeep(); document.getElementById('incidenciaSerie').value = code; closeIncidenciaScan(); },function(){}).catch(function(){});
            }catch(e){}
        },300);
    }

    function closeIncidenciaScan(){
        if(incidenciaScanner) try{ incidenciaScanner.stop(); }catch(e){}
        document.getElementById('incidenciaScanModal').classList.remove('show');
    }

    function guardarIncidencia(){
        var serie = document.getElementById('incidenciaSerie').value.trim();
        var tipo = document.getElementById('incidenciaTipo').value;
        var descripcion = document.getElementById('incidenciaDescripcion').value.trim();
        var reportaA = document.getElementById('incidenciaReportaA').value.trim();
        if(!serie){ showToast('error','Ingresa la serie'); return; }
        if(!tipo){ showToast('error','Selecciona tipo'); return; }
        if(!descripcion){ showToast('error','Describe el problema'); return; }
        var incidencia = {id:Date.now().toString(36)+Math.random().toString(36).substr(2),timestamp:new Date().toISOString(),fecha:new Date().toLocaleDateString('es-MX'),hora:new Date().toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'}),serie:serie.toUpperCase(),tipo:tipo,descripcion:descripcion,reportaA:reportaA,user:state.currentUser,comentarios:[]};
        var incidencias = JSON.parse(localStorage.getItem('incidencias') || '[]');
        incidencias.unshift(incidencia);
        localStorage.setItem('incidencias', JSON.stringify(incidencias));
        playBeep();
        showToast('success','Incidencia guardada');
        document.getElementById('incidenciaSerie').value = '';
        document.getElementById('incidenciaTipo').value = '';
        document.getElementById('incidenciaDescripcion').value = '';
        document.getElementById('incidenciaReportaA').value = '';
        renderMisIncidencias();
    }

    function renderMisIncidencias(){
        var container = document.getElementById('misIncidenciasList');
        if(!container) return;
        var incidencias = JSON.parse(localStorage.getItem('incidencias') || '[]');
        var mis = incidencias.filter(function(i){ return i.user === state.currentUser; }).slice(0,10);
        if(!mis.length){ container.innerHTML = '<div class="empty-state"><p>No tienes incidencias</p></div>'; return; }
        var tipoNames = {caida:'Ca√≠da',caja:'Cambio caja',serie:'Cambio serie',danio:'Da√±o f√≠sico',otro:'Otro'};
        var html = '';
        mis.forEach(function(i){ html += '<div class="config-card" style="margin-bottom:8px"><div style="display:flex;justify-content:space-between"><strong>'+i.serie+'</strong><span style="font-size:11px;color:var(--text-light)">'+i.fecha+'</span></div><div style="font-size:12px;color:var(--warning)">'+tipoNames[i.tipo]+'</div></div>'; });
        container.innerHTML = html;
    }

    function filtrarIncidencias(){
        var desde = document.getElementById('incidenciasDateFrom').value;
        var hasta = document.getElementById('incidenciasDateTo').value;
        var incidencias = JSON.parse(localStorage.getItem('incidencias') || '[]');
        var filtered = incidencias.filter(function(i){ var f = i.timestamp.slice(0,10); return (!desde || f >= desde) && (!hasta || f <= hasta); });
        var container = document.getElementById('todasIncidenciasList');
        if(!filtered.length){ container.innerHTML = '<div class="empty-state"><p>No hay incidencias</p></div>'; return; }
        var tipoNames = {caida:'Ca√≠da',caja:'Cambio caja',serie:'Cambio serie',danio:'Da√±o f√≠sico',otro:'Otro'};
        var html = '';
        filtered.forEach(function(i){ html += '<div class="config-card" style="margin-bottom:10px"><div style="display:flex;justify-content:space-between"><div><strong>'+i.serie+'</strong><br><span style="font-size:11px;color:var(--warning)">'+tipoNames[i.tipo]+'</span></div><div style="text-align:right;font-size:11px;color:var(--text-light)">'+i.fecha+' '+i.hora+'<br>'+i.user+'</div></div><div style="font-size:12px;margin-top:6px;padding:8px;background:var(--bg-light);border-radius:6px">'+i.descripcion+'</div></div>'; });
        container.innerHTML = html;
    }

    function exportarIncidencias(){
        var incidencias = JSON.parse(localStorage.getItem('incidencias') || '[]');
        if(!incidencias.length){ showToast('warning','No hay incidencias'); return; }
        var tipoNames = {caida:'Ca√≠da',caja:'Cambio caja',serie:'Cambio serie',danio:'Da√±o f√≠sico',otro:'Otro'};
        var csv = 'REPORTE DE INCIDENCIAS\n\nFecha,Hora,Serie,Tipo,Descripcion,Reporta A,Usuario\n';
        incidencias.forEach(function(i){ csv += '"'+i.fecha+'","'+i.hora+'","'+i.serie+'","'+tipoNames[i.tipo]+'","'+i.descripcion.replace(/"/g,"'")+'","'+(i.reportaA||'')+'","'+i.user+'"\n'; });
        downloadCSV(csv, 'incidencias_'+new Date().toISOString().slice(0,10)+'.csv');
    }

    // ==================== CAMBIO 11: MUESTREO INTERNO ====================
    var muestreoInternoItems = [];
    var muestreoInternoActual = null;

    function generarMuestreoInterno(){
        var cantidad = parseInt(document.getElementById('muestreoInternoCantidad').value);
        var equipmentStatus = {};
        state.movements.forEach(function(m){ var code = m.equipment.full; if(!equipmentStatus[code]) equipmentStatus[code] = {lastMove:null,equipment:m.equipment}; equipmentStatus[code].lastMove = m; });
        var inventario = [];
        for(var code in equipmentStatus){ var eq = equipmentStatus[code]; if(eq.lastMove.type === 'acomodo') inventario.push({equipment:eq.equipment,location:eq.lastMove.location}); }
        if(inventario.length < cantidad){ showToast('warning','Solo hay '+inventario.length+' equipos'); cantidad = Math.min(cantidad, inventario.length); }
        if(cantidad === 0){ showToast('error','No hay inventario'); return; }
        var shuffled = inventario.sort(function(){ return 0.5 - Math.random(); });
        muestreoInternoItems = shuffled.slice(0, cantidad).map(function(item){ return {equipment:item.equipment,location:item.location,status:null}; });
        muestreoInternoActual = {fecha:new Date().toLocaleDateString('es-MX'),timestamp:new Date().toISOString(),cantidad:cantidad};
        renderMuestreoInternoLista();
        document.getElementById('muestreoInternoLista').classList.remove('hidden');
        document.getElementById('muestreoInternoResultados').classList.remove('hidden');
        playBeep();
    }

    function renderMuestreoInternoLista(){
        var container = document.getElementById('muestreoInternoLista');
        var html = '<div class="config-card"><h4 style="margin-bottom:10px">Series a verificar ('+muestreoInternoItems.length+')</h4>';
        muestreoInternoItems.forEach(function(item, idx){
            var statusColor = item.status === 'ok' ? 'var(--success)' : item.status === 'no_encontrado' ? 'var(--error)' : item.status === 'ubicacion_incorrecta' ? 'var(--warning)' : 'var(--text-light)';
            var statusIcon = item.status === 'ok' ? '‚úÖ' : item.status === 'no_encontrado' ? '‚ùå' : item.status === 'ubicacion_incorrecta' ? 'üìç' : '‚¨ú';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">';
            html += '<div><strong style="font-family:monospace">'+item.equipment.full+'</strong><br><span style="font-size:11px;color:var(--text-light)">'+item.location+'</span></div>';
            html += '<div style="display:flex;gap:4px">';
            html += '<button onclick="marcarMuestreoInterno('+idx+',\'ok\')" style="padding:6px 10px;border:none;border-radius:6px;cursor:pointer;background:'+(item.status==='ok'?'var(--success-bg)':'var(--bg-light)')+'">‚úÖ</button>';
            html += '<button onclick="marcarMuestreoInterno('+idx+',\'no_encontrado\')" style="padding:6px 10px;border:none;border-radius:6px;cursor:pointer;background:'+(item.status==='no_encontrado'?'var(--error-bg)':'var(--bg-light)')+'">‚ùå</button>';
            html += '<button onclick="marcarMuestreoInterno('+idx+',\'ubicacion_incorrecta\')" style="padding:6px 10px;border:none;border-radius:6px;cursor:pointer;background:'+(item.status==='ubicacion_incorrecta'?'var(--warning-bg)':'var(--bg-light)')+'">üìç</button>';
            html += '</div></div>';
        });
        html += '</div>';
        container.innerHTML = html;
    }
    window.marcarMuestreoInterno = function(idx, status){
        muestreoInternoItems[idx].status = status;
        playBeep();
        renderMuestreoInternoLista();
    };

    function finalizarMuestreoInterno(){
        var ok = muestreoInternoItems.filter(function(i){ return i.status === 'ok'; }).length;
        var noEnc = muestreoInternoItems.filter(function(i){ return i.status === 'no_encontrado'; }).length;
        var ubInc = muestreoInternoItems.filter(function(i){ return i.status === 'ubicacion_incorrecta'; }).length;
        var pendientes = muestreoInternoItems.filter(function(i){ return !i.status; }).length;
        if(pendientes > 0){ showToast('warning','Faltan '+pendientes+' por verificar'); return; }
        var resultado = {fecha:muestreoInternoActual.fecha,timestamp:muestreoInternoActual.timestamp,total:muestreoInternoItems.length,ok:ok,noEncontrado:noEnc,ubicacionIncorrecta:ubInc,items:muestreoInternoItems.map(function(i){return {serie:i.equipment.full,ubicacion:i.location,status:i.status};})};
        var historial = JSON.parse(localStorage.getItem('muestreoInternoHistorial') || '[]');
        historial.unshift(resultado);
        localStorage.setItem('muestreoInternoHistorial', JSON.stringify(historial.slice(0,50)));
        showToast('success','Muestreo guardado: '+ok+'/'+muestreoInternoItems.length+' OK');
        muestreoInternoItems = [];
        document.getElementById('muestreoInternoLista').classList.add('hidden');
        document.getElementById('muestreoInternoResultados').classList.add('hidden');
        renderHistorialMuestreoInterno();
    }

    function renderHistorialMuestreoInterno(){
        var container = document.getElementById('historialMuestreoInterno');
        if(!container) return;
        var historial = JSON.parse(localStorage.getItem('muestreoInternoHistorial') || '[]');
        if(!historial.length){ container.innerHTML = '<div class="empty-state"><p>No hay muestreos</p></div>'; return; }
        var html = '';
        historial.slice(0,10).forEach(function(r){
            var pct = Math.round((r.ok / r.total) * 100);
            var color = pct >= 95 ? 'var(--success)' : pct >= 90 ? 'var(--warning)' : 'var(--error)';
            html += '<div class="config-card" style="margin-bottom:12px">';
            html += '<div style="display:flex;justify-content:space-between"><div><strong>'+r.fecha+'</strong><br><span style="font-size:11px;color:var(--text-light)">'+r.total+' verificados</span></div><div style="text-align:right;color:'+color+';font-weight:700;font-size:18px">'+pct+'%</div></div>';
            html += '<div style="display:flex;gap:10px;margin-top:6px;font-size:11px">';
            html += '<span style="color:var(--success)">‚úÖ '+r.ok+' OK</span>';
            html += '<span style="color:var(--error)">‚ùå '+r.noEncontrado+' no enc.</span>';
            html += '<span style="color:var(--warning)">üìç '+r.ubicacionIncorrecta+' ub.inc.</span>';
            html += '</div>';
            // Detalle de incorrectas
            var incorrectas = r.items ? r.items.filter(function(i){ return i.status !== 'ok'; }) : [];
            if(incorrectas.length > 0){
                html += '<div style="margin-top:8px;padding:8px;background:var(--error-bg);border-radius:6px;font-size:11px">';
                html += '<strong style="color:var(--error)">Detalle incorrectas:</strong>';
                incorrectas.forEach(function(i){
                    var statusIcon = i.status === 'no_encontrado' ? '‚ùå' : 'üìç';
                    var statusText = i.status === 'no_encontrado' ? 'No encontrado' : 'Ubicaci√≥n incorrecta';
                    html += '<div style="margin-top:4px">'+statusIcon+' <span style="font-family:monospace">'+i.serie+'</span> ('+i.ubicacion+') - '+statusText+'</div>';
                });
                html += '</div>';
            }
            html += '</div>';
        });
        container.innerHTML = html;
    }

    // ==================== EXPORTAR EMBARQUES ====================
    var embarquesFiltrados = [];
    
    function filtrarEmbarques(){
        var desde = document.getElementById('exportEmbarquesDesde').value;
        var hasta = document.getElementById('exportEmbarquesHasta').value;
        
        if(!desde || !hasta){
            showToast('warning','Selecciona rango de fechas');
            return;
        }
        
        embarquesFiltrados = state.movements.filter(function(m){
            if(m.type !== 'embarque') return false;
            var fecha = m.timestamp.slice(0,10);
            return fecha >= desde && fecha <= hasta;
        });
        
        // Contar por tipo
        var cliente = 0, vallejo = 0, traslado = 0;
        embarquesFiltrados.forEach(function(m){
            var tipo = (m.tipoSalida || 'cliente').toLowerCase();
            if(tipo === 'vallejo') vallejo++;
            else if(tipo === 'traslado') traslado++;
            else cliente++;
        });
        
        document.getElementById('embarquesTotal').textContent = embarquesFiltrados.length;
        document.getElementById('embarquesCliente').textContent = cliente;
        document.getElementById('embarquesVallejo').textContent = vallejo;
        document.getElementById('embarquesTraslado').textContent = traslado;
        document.getElementById('embarquesRangoFechas').textContent = desde + ' a ' + hasta;
        document.getElementById('embarquesResumen').classList.remove('hidden');
        
        // Mostrar lista
        var container = document.getElementById('embarquesLista');
        if(!embarquesFiltrados.length){
            container.innerHTML = '<div class="empty-state"><p>No hay embarques en este rango</p></div>';
            return;
        }
        
        var html = '';
        embarquesFiltrados.slice(0,50).forEach(function(m){
            var tipo = (m.tipoSalida || 'cliente').toUpperCase();
            html += '<div class="config-card" style="margin-bottom:6px;padding:10px">';
            html += '<div style="display:flex;justify-content:space-between">';
            html += '<div><span style="font-family:monospace;font-weight:700">'+m.equipment.full+'</span><br>';
            html += '<span style="font-size:11px;color:var(--text-light)">'+m.fecha+' '+m.hora+' ‚Ä¢ '+m.user+'</span></div>';
            html += '<div style="text-align:right"><span style="font-size:10px;background:var(--info-bg);padding:2px 6px;border-radius:4px">'+tipo+'</span><br>';
            html += '<span style="font-size:11px;color:var(--text-light)">'+(m.referencia||'-')+'</span></div>';
            html += '</div></div>';
        });
        if(embarquesFiltrados.length > 50) html += '<p style="text-align:center;font-size:11px;color:var(--text-light)">Mostrando 50 de '+embarquesFiltrados.length+'</p>';
        container.innerHTML = html;
    }
    
    function descargarEmbarques(){
        if(!embarquesFiltrados.length){
            showToast('warning','No hay embarques para descargar');
            return;
        }
        
        var csv = 'REPORTE DE EMBARQUES\n';
        csv += 'Desde:,' + document.getElementById('exportEmbarquesDesde').value + '\n';
        csv += 'Hasta:,' + document.getElementById('exportEmbarquesHasta').value + '\n';
        csv += 'Total:,' + embarquesFiltrados.length + '\n\n';
        csv += 'Fecha,Hora,Serie,Prefijo,Tipo Salida,Referencia,Usuario\n';
        
        embarquesFiltrados.forEach(function(m){
            csv += '"'+m.fecha+'","'+m.hora+'","'+m.equipment.serie+'","'+m.equipment.prefix+'","'+(m.tipoSalida||'cliente')+'","'+(m.referencia||'')+'","'+m.user+'"\n';
        });
        
        downloadCSV(csv, 'embarques_'+document.getElementById('exportEmbarquesDesde').value+'_'+document.getElementById('exportEmbarquesHasta').value+'.csv');
    }

    // ==================== EXPORTAR MUESTREOS AUDITORIA ====================
    var muestreosFiltrados = [];
    
    function filtrarMuestreosAuditoria(){
        var desde = document.getElementById('exportMuestreosDesde').value;
        var hasta = document.getElementById('exportMuestreosHasta').value;
        
        muestreosFiltrados = state.auditResults.filter(function(r){
            var fecha = r.date;
            if(desde && fecha < desde) return false;
            if(hasta && fecha > hasta) return false;
            return true;
        });
        
        var container = document.getElementById('muestreosAuditoriaLista');
        if(!muestreosFiltrados.length){
            container.innerHTML = '<div class="empty-state"><p>No hay muestreos en este rango</p></div>';
            return;
        }
        
        var html = '';
        muestreosFiltrados.forEach(function(r){
            var pct = r.total > 0 ? Math.round((r.found / r.total) * 100) : 0;
            var color = pct >= 95 ? 'var(--success)' : pct >= 90 ? 'var(--warning)' : 'var(--error)';
            html += '<div class="config-card" style="margin-bottom:10px">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center">';
            html += '<div><strong>'+r.date+'</strong><br><span style="font-size:11px;color:var(--text-light)">'+r.total+' verificados</span></div>';
            html += '<div style="text-align:right;color:'+color+';font-weight:700;font-size:18px">'+pct+'%</div>';
            html += '</div>';
            html += '<div style="display:flex;gap:10px;margin-top:6px;font-size:11px">';
            html += '<span style="color:var(--success)">‚úÖ '+r.found+' encontrados</span>';
            html += '<span style="color:var(--error)">‚ùå '+r.notFound+' no encontrados</span>';
            html += '</div>';
            if(r.notFoundItems && r.notFoundItems.length > 0){
                html += '<div style="margin-top:8px;padding:8px;background:var(--error-bg);border-radius:6px;font-size:11px">';
                html += '<strong style="color:var(--error)">No encontrados:</strong><br>';
                html += '<span style="font-family:monospace">'+r.notFoundItems.join(', ')+'</span>';
                html += '</div>';
            }
            html += '</div>';
        });
        container.innerHTML = html;
    }
    
    function descargarMuestreosAuditoria(){
        if(!muestreosFiltrados.length){
            showToast('warning','No hay muestreos para descargar');
            return;
        }
        
        var csv = 'REPORTE DE MUESTREOS AUDITORIA\n\n';
        csv += 'Fecha,Total,Encontrados,No Encontrados,Porcentaje,No Encontrados (Detalle)\n';
        
        muestreosFiltrados.forEach(function(r){
            var pct = r.total > 0 ? Math.round((r.found / r.total) * 100) : 0;
            var noEnc = r.notFoundItems ? r.notFoundItems.join(' | ') : '';
            csv += '"'+r.date+'",'+r.total+','+r.found+','+r.notFound+','+pct+'%,"'+noEnc+'"\n';
        });
        
        downloadCSV(csv, 'muestreos_auditoria_'+new Date().toISOString().slice(0,10)+'.csv');
    }

    // ==================== EXPORTAR INCIDENCIAS ====================
    var incidenciasFiltradas = [];
    
    function filtrarIncidenciasExport(){
        var desde = document.getElementById('exportIncidenciasDesde').value;
        var hasta = document.getElementById('exportIncidenciasHasta').value;
        
        if(!desde || !hasta){
            showToast('warning','Selecciona rango de fechas');
            return;
        }
        
        var todas = JSON.parse(localStorage.getItem('ubicaciones_incidencias') || '[]');
        incidenciasFiltradas = todas.filter(function(i){
            var fecha = i.fecha;
            return fecha >= desde && fecha <= hasta;
        });
        
        document.getElementById('incidenciasExportTotal').textContent = incidenciasFiltradas.length;
        document.getElementById('incidenciasRangoFechas').textContent = desde + ' a ' + hasta;
        document.getElementById('incidenciasExportResumen').classList.remove('hidden');
        
        // Mostrar lista
        var container = document.getElementById('incidenciasExportLista');
        if(!incidenciasFiltradas.length){
            container.innerHTML = '<div class="empty-state"><p>No hay incidencias en este rango</p></div>';
            return;
        }
        
        var tipos = {caida:'Ca√≠da',caja:'Cambio Caja',serie:'Cambio Serie',danio:'Da√±o',otro:'Otro'};
        var html = '';
        incidenciasFiltradas.forEach(function(i){
            html += '<div class="config-card" style="margin-bottom:8px;padding:10px;border-left:4px solid var(--warning)">';
            html += '<div style="display:flex;justify-content:space-between">';
            html += '<div><strong style="font-family:monospace">'+i.serie+'</strong><br>';
            html += '<span style="font-size:11px;color:var(--text-light)">'+i.fecha+' '+i.hora+'</span></div>';
            html += '<div style="text-align:right"><span style="font-size:10px;background:var(--warning-bg);padding:2px 6px;border-radius:4px">'+(tipos[i.tipo]||i.tipo)+'</span></div>';
            html += '</div>';
            if(i.descripcion) html += '<div style="font-size:11px;margin-top:4px;color:var(--text-light)">'+i.descripcion+'</div>';
            html += '</div>';
        });
        container.innerHTML = html;
    }
    
    function descargarIncidenciasExcel(){
        if(!incidenciasFiltradas.length){
            showToast('warning','No hay incidencias para descargar');
            return;
        }
        
        var tipos = {caida:'Ca√≠da de equipo',caja:'Cambio de caja',serie:'Cambio de serie',danio:'Da√±o f√≠sico',otro:'Otro'};
        var csv = 'REPORTE DE INCIDENCIAS CALIDAD\n';
        csv += 'Desde:,' + document.getElementById('exportIncidenciasDesde').value + '\n';
        csv += 'Hasta:,' + document.getElementById('exportIncidenciasHasta').value + '\n';
        csv += 'Total:,' + incidenciasFiltradas.length + '\n\n';
        csv += 'Fecha,Hora,Serie,Tipo,Descripcion,Reporta A,Usuario\n';
        
        incidenciasFiltradas.forEach(function(i){
            csv += '"'+i.fecha+'","'+i.hora+'","'+i.serie+'","'+(tipos[i.tipo]||i.tipo)+'","'+(i.descripcion||'').replace(/"/g,"'")+'","'+(i.reportaA||'')+'","'+i.user+'"\n';
        });
        
        downloadCSV(csv, 'incidencias_'+document.getElementById('exportIncidenciasDesde').value+'_'+document.getElementById('exportIncidenciasHasta').value+'.csv');
    }

    // ==================== CAMBIO 3: SOPORTE ESC√ÅNER ZEBRA TC22/TC27 ====================
    // El esc√°ner Zebra env√≠a el c√≥digo como entrada de teclado seguido de Enter
    // Detectamos entrada r√°pida de texto (t√≠pico de esc√°ner) y procesamos
    var barcodeBuffer = '';
    var barcodeTimeout = null;

    document.addEventListener('keypress', function(e){
        // Si estamos en un input de texto, dejamos que funcione normal
        var activeEl = document.activeElement;
        var isInput = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA');
        
        // Detectar Enter despu√©s de entrada r√°pida (t√≠pico de esc√°ner)
        if(e.key === 'Enter' && barcodeBuffer.length >= 8){
            e.preventDefault();
            processZebraScan(barcodeBuffer);
            barcodeBuffer = '';
            return;
        }
        
        // Acumular caracteres
        if(e.key.length === 1){
            barcodeBuffer += e.key;
            clearTimeout(barcodeTimeout);
            barcodeTimeout = setTimeout(function(){ barcodeBuffer = ''; }, 100);
        }
    });

    function processZebraScan(code){
        var screen = document.querySelector('.screen.active');
        if(!screen) return;
        var screenId = screen.id;
        
        // Determinar qu√© hacer seg√∫n la pantalla activa
        if(screenId === 'recepcionScreen'){
            var parsed = parseCode(code);
            if(parsed && !state.scannedItems.recepcion.some(function(i){return i.full===parsed.full;})){
                state.scannedItems.recepcion.push(parsed);
                playBeep();
                updateList('recepcion');
            }
        }else if(screenId === 'acomodoScreen'){
            var parsed = parseCode(code);
            if(parsed && !state.scannedItems.acomodo.some(function(i){return i.full===parsed.full;})){
                state.scannedItems.acomodo.push(parsed);
                playBeep();
                updateList('acomodo');
            }
        }else if(screenId === 'traspasoScreen'){
            var parsed = parseCode(code);
            if(parsed && !state.scannedItems.traspaso.some(function(i){return i.full===parsed.full;})){
                state.scannedItems.traspaso.push(parsed);
                playBeep();
                updateList('traspaso');
            }
        }else if(screenId === 'embarqueScreen'){
            var parsed = parseCode(code);
            if(parsed && !state.scannedItems.embarque.some(function(i){return i.full===parsed.full;})){
                state.scannedItems.embarque.push(parsed);
                playBeep();
                updateList('embarque');
            }
        }else if(screenId === 'calidadSalidasScreen'){
            var parsed = parseCode(code);
            if(parsed && !calidadScannedItems.some(function(i){return i.full===parsed.full;})){
                calidadScannedItems.push(parsed);
                playBeep();
                renderCalidadList();
            }
        }else if(screenId === 'consultaScreen'){
            document.getElementById('consultaInput').value = code;
            searchSerie();
        }else if(screenId === 'liberarReparacionScreen'){
            var parsed = parseCode(code);
            if(parsed && !state.scannedItems.reparacion.some(function(i){return i.full===parsed.full;})){
                state.scannedItems.reparacion.push(parsed);
                playBeep();
                renderReparacionList();
            }
        }
    }

    // ==================== REPARACIONES ====================
    function renderReparacionList(){
        var list = document.getElementById('reparacionScannedList');
        var items = state.scannedItems.reparacion;
        document.getElementById('reparacionCount').textContent = items.length;
        if(!items.length){ list.innerHTML = '<div class="empty-state"><p>Escanea equipos</p></div>'; return; }
        var html = '';
        items.forEach(function(item, idx){ html += '<div class="scanned-item"><div class="item-info"><span class="item-serie">'+item.full+'</span></div><button class="item-remove" onclick="removeRepItem('+idx+')">‚úï</button></div>'; });
        list.innerHTML = html;
    }
    window.removeRepItem = function(idx){ state.scannedItems.reparacion.splice(idx,1); renderReparacionList(); };
    
    function switchTabReparacion(tab){
        var scanTab = document.getElementById('reparacionTabScan');
        var manualTab = document.getElementById('reparacionTabManual');
        var scanSec = document.getElementById('reparacionScanSection');
        var manualSec = document.getElementById('reparacionManualSection');
        if(tab === 'scan'){
            scanTab.classList.add('active');
            manualTab.classList.remove('active');
            scanSec.classList.remove('hidden');
            manualSec.classList.add('hidden');
        }else{
            scanTab.classList.remove('active');
            manualTab.classList.add('active');
            scanSec.classList.add('hidden');
            manualSec.classList.remove('hidden');
        }
    }
    
    function addManualReparacion(){
        var input = document.getElementById('reparacionManualInput');
        var code = input.value.trim().toUpperCase();
        if(!code) return;
        var parsed = parseCode(code);
        if(!parsed){ showToast('error','Serie inv√°lida'); return; }
        if(state.scannedItems.reparacion.some(function(i){return i.full===parsed.full;})){ showToast('warning','Ya escaneado'); return; }
        state.scannedItems.reparacion.push(parsed);
        input.value = '';
        renderReparacionList();
        showToast('success','Agregado');
    }
    
    function confirmarReparacion(){
        var items = state.scannedItems.reparacion;
        if(!items.length){ showToast('warning','Escanea equipos'); return; }
        var ubicDestino = document.getElementById('reparacionUbicacionDestino').value;
        if(!ubicDestino){ showToast('warning','Selecciona ubicaci√≥n destino'); return; }
        var comentario = document.getElementById('reparacionComentario').value.trim();
        var now = new Date();
        var reps = JSON.parse(localStorage.getItem('ptcontrol_reparaciones') || '[]');
        items.forEach(function(item){
            reps.push({ 
                id: Date.now()+Math.random(), 
                serie: item.full, 
                prefix: item.prefix, 
                bodegaOrigen: state.currentBodegaReparaciones,
                ubicacionDestino: ubicDestino,
                comentario: comentario,
                user: state.currentUser, 
                fecha: now.toISOString().slice(0,10), 
                hora: now.toTimeString().slice(0,5), 
                timestamp: now.toISOString(),
                origen: 'reparacion'
            });
        });
        localStorage.setItem('ptcontrol_reparaciones', JSON.stringify(reps));
        saveToFirebase(); // Sincronizar con Firebase
        showToast('success', items.length + ' equipos liberados a ' + ubicDestino);
        state.scannedItems.reparacion = [];
        document.getElementById('reparacionComentario').value = '';
        renderReparacionList();
        goBack();
    }
    
    function filtrarHistorialReparaciones(){
        var fecha = document.getElementById('histReparacionesFecha').value || new Date().toISOString().slice(0,10);
        var todas = JSON.parse(localStorage.getItem('ptcontrol_reparaciones') || '[]');
        var filt = todas.filter(function(r){ return r.fecha === fecha; });
        var container = document.getElementById('historialReparacionesList');
        if(!filt.length){ container.innerHTML = '<div class="empty-state"><p>Sin liberaciones</p></div>'; return; }
        var html = '';
        filt.forEach(function(r){ 
            html += '<div class="config-card" style="margin-bottom:8px;padding:10px">';
            html += '<div style="display:flex;justify-content:space-between"><strong style="font-family:monospace">'+r.serie+'</strong><span style="font-size:11px">'+r.hora+'</span></div>';
            html += '<div style="font-size:11px;color:var(--text-light)">'+r.bodegaOrigen+' ‚Üí '+r.ubicacionDestino+'</div>';
            if(r.comentario) html += '<div style="font-size:10px;color:var(--info);margin-top:4px">'+r.comentario+'</div>';
            html += '</div>'; 
        });
        container.innerHTML = html;
    }

    // ==================== EXPORTAR CON FILTROS ====================
    var movsFiltrados=[], pendFiltrados=[], repFiltradas=[];
    
    function filtrarMovimientosExport(){
        var desde = document.getElementById('exportMovsDesde').value, hasta = document.getElementById('exportMovsHasta').value;
        if(!desde||!hasta){ showToast('warning','Selecciona rango'); return; }
        movsFiltrados = state.movements.filter(function(m){ var f=m.timestamp.slice(0,10); return f>=desde && f<=hasta; });
        var r=0,a=0,t=0,e=0;
        movsFiltrados.forEach(function(m){ if(m.type==='recepcion')r++; else if(m.type==='acomodo')a++; else if(m.type==='traspaso')t++; else if(m.type==='embarque')e++; });
        document.getElementById('movsRecepcion').textContent=r; document.getElementById('movsAcomodo').textContent=a;
        document.getElementById('movsTraspaso').textContent=t; document.getElementById('movsEmbarque').textContent=e;
        document.getElementById('movsExportResumen').classList.remove('hidden');
    }
    
    function descargarMovimientosExcel(){
        if(!movsFiltrados.length){ showToast('warning','Sin movimientos'); return; }
        var csv='Fecha,Hora,Tipo,Serie,Prefijo,Usuario,Bodega,Ubicacion\n';
        movsFiltrados.forEach(function(m){ csv+='"'+m.fecha+'","'+m.hora+'","'+m.type+'","'+m.equipment.serie+'","'+m.equipment.prefix+'","'+m.user+'","'+(m.bodega||'')+'","'+(m.location||'')+'"\n'; });
        downloadCSV(csv,'movimientos_'+document.getElementById('exportMovsDesde').value+'.csv');
    }
    
    function filtrarPendientesExport(){
        var desde = document.getElementById('exportPendientesDesde').value, hasta = document.getElementById('exportPendientesHasta').value;
        if(!desde||!hasta){ showToast('warning','Selecciona rango'); return; }
        var recibidos = state.movements.filter(function(m){ return (m.type==='recepcion'||m.type==='traspaso') && m.timestamp.slice(0,10)>=desde && m.timestamp.slice(0,10)<=hasta; });
        var acomodados = state.movements.filter(function(m){ return m.type==='acomodo'; }).map(function(m){ return m.equipment.full; });
        var embarcados = state.movements.filter(function(m){ return m.type==='embarque'; }).map(function(m){ return m.equipment.full; });
        pendFiltrados = recibidos.filter(function(m){ return acomodados.indexOf(m.equipment.full)===-1 && embarcados.indexOf(m.equipment.full)===-1; });
        document.getElementById('pendientesExportTotal').textContent = pendFiltrados.length;
        document.getElementById('pendientesExportResumen').classList.remove('hidden');
    }
    
    function descargarPendientesExcel(){
        if(!pendFiltrados.length){ showToast('warning','Sin pendientes'); return; }
        var csv='Fecha,Hora,Serie,Prefijo,Tipo,Usuario\n';
        pendFiltrados.forEach(function(m){ csv+='"'+m.fecha+'","'+m.hora+'","'+m.equipment.serie+'","'+m.equipment.prefix+'","'+m.type+'","'+m.user+'"\n'; });
        downloadCSV(csv,'pendientes_'+new Date().toISOString().slice(0,10)+'.csv');
    }
    
    function exportarInventarioHoy(){ exportInventario(); }
    function exportarInventarioFecha(){
        var fecha = document.getElementById('exportInventarioFecha').value;
        if(!fecha){ showToast('warning','Selecciona fecha'); return; }
        // Reconstruir inventario a esa fecha
        var movsHastaFecha = state.movements.filter(function(m){ return m.timestamp.slice(0,10) <= fecha; });
        var inv = {};
        movsHastaFecha.forEach(function(m){
            if(m.type==='embarque'){ delete inv[m.equipment.full]; }
            else if(m.type==='acomodo'){ inv[m.equipment.full] = { serie: m.equipment.full, prefix: m.equipment.prefix, location: m.location, fecha: m.fecha }; }
            else if(m.type==='recepcion'||m.type==='traspaso'){ if(!inv[m.equipment.full]) inv[m.equipment.full] = { serie: m.equipment.full, prefix: m.equipment.prefix, location: 'PENDIENTE', fecha: m.fecha }; }
        });
        var items = Object.values(inv);
        if(!items.length){ showToast('warning','Sin inventario'); return; }
        var csv='Serie,Prefijo,Ubicacion,Fecha Registro\n';
        items.forEach(function(i){ csv+='"'+i.serie+'","'+i.prefix+'","'+i.location+'","'+i.fecha+'"\n'; });
        downloadCSV(csv,'inventario_'+fecha+'.csv');
        showToast('success','Inventario al '+fecha);
    }
    
    // Recepciones Export
    var recFiltradas = [];
    function filtrarRecepcionesExport(){
        var desde = document.getElementById('exportRecepcionesDesde').value, hasta = document.getElementById('exportRecepcionesHasta').value;
        if(!desde||!hasta){ showToast('warning','Selecciona rango'); return; }
        recFiltradas = state.movements.filter(function(m){ 
            return m.type==='recepcion' && m.timestamp.slice(0,10)>=desde && m.timestamp.slice(0,10)<=hasta; 
        });
        document.getElementById('recepcionesExportTotal').textContent = recFiltradas.length;
        document.getElementById('recepcionesExportResumen').classList.remove('hidden');
        var container = document.getElementById('recepcionesExportLista');
        if(!recFiltradas.length){ container.innerHTML = '<div class="empty-state"><p>Sin recepciones</p></div>'; return; }
        var html = '';
        recFiltradas.forEach(function(r){ 
            html += '<div class="config-card" style="margin-bottom:6px;padding:8px">';
            html += '<div style="display:flex;justify-content:space-between"><strong style="font-family:monospace">'+r.equipment.full+'</strong><span style="font-size:11px">'+r.hora+'</span></div>';
            html += '<div style="font-size:11px;color:var(--text-light)">'+r.fecha+' ‚Ä¢ '+(r.bodega||'-')+' ‚Ä¢ '+r.user+'</div>';
            html += '</div>'; 
        });
        container.innerHTML = html;
    }
    
    function descargarRecepcionesExcel(){
        if(!recFiltradas.length){ showToast('warning','Sin recepciones'); return; }
        var csv='Fecha,Hora,Serie,Prefijo,Bodega,Usuario\n';
        recFiltradas.forEach(function(r){ csv+='"'+r.fecha+'","'+r.hora+'","'+r.equipment.serie+'","'+r.equipment.prefix+'","'+(r.bodega||'')+'","'+r.user+'"\n'; });
        downloadCSV(csv,'recepciones_'+document.getElementById('exportRecepcionesDesde').value+'.csv');
    }
    
    function filtrarReparacionesExport(){
        var desde = document.getElementById('exportReparacionesDesde').value, hasta = document.getElementById('exportReparacionesHasta').value;
        if(!desde||!hasta){ showToast('warning','Selecciona rango'); return; }
        var todas = JSON.parse(localStorage.getItem('ptcontrol_reparaciones') || '[]');
        repFiltradas = todas.filter(function(r){ return r.fecha>=desde && r.fecha<=hasta; });
        document.getElementById('reparacionesExportTotal').textContent = repFiltradas.length;
        document.getElementById('reparacionesExportResumen').classList.remove('hidden');
        var container = document.getElementById('reparacionesExportLista');
        if(!repFiltradas.length){ container.innerHTML = '<div class="empty-state"><p>Sin reparaciones</p></div>'; return; }
        var html = '';
        repFiltradas.forEach(function(r){ 
            html += '<div class="config-card" style="margin-bottom:6px;padding:8px">';
            html += '<strong style="font-family:monospace">'+r.serie+'</strong>';
            html += '<div style="font-size:11px;color:var(--text-light)">'+r.fecha+' '+r.hora+' ‚Ä¢ '+(r.bodegaOrigen||r.bodega)+' ‚Üí '+(r.ubicacionDestino||'-')+'</div>';
            if(r.comentario) html += '<div style="font-size:10px;color:var(--info)">'+r.comentario+'</div>';
            html += '</div>'; 
        });
        container.innerHTML = html;
    }
    
    function descargarReparacionesExcel(){
        if(!repFiltradas.length){ showToast('warning','Sin reparaciones'); return; }
        var csv='Fecha,Hora,Serie,Bodega Origen,Ubicacion Destino,Comentario,Usuario\n';
        repFiltradas.forEach(function(r){ csv+='"'+r.fecha+'","'+r.hora+'","'+r.serie+'","'+(r.bodegaOrigen||r.bodega)+'","'+(r.ubicacionDestino||'')+'","'+(r.comentario||'')+'","'+r.user+'"\n'; });
        downloadCSV(csv,'reparaciones_'+document.getElementById('exportReparacionesDesde').value+'.csv');
    }

    // ==================== ALERTAS Y OBSOLESCENCIA ====================
    function calcularAlertas(){
        var hoy = new Date();
        var inv = {};
        state.movements.forEach(function(m){
            if(m.type==='embarque'){ delete inv[m.equipment.full]; }
            else { inv[m.equipment.full] = { serie: m.equipment.full, ultimoMov: m.timestamp, tipo: m.type, ubicacion: m.location || 'N/A' }; }
        });
        var alertas = [];
        Object.values(inv).forEach(function(item){
            var dias = Math.floor((hoy - new Date(item.ultimoMov)) / (1000*60*60*24));
            if(dias > 30){ item.dias = dias; alertas.push(item); }
        });
        return alertas.sort(function(a,b){ return b.dias - a.dias; });
    }
    
    function calcularObsolescencia(){
        var hoy = new Date();
        var ultimoEmbarque = {};
        var enInventario = {};
        state.movements.forEach(function(m){
            if(m.type==='embarque'){ ultimoEmbarque[m.equipment.full] = m.timestamp; delete enInventario[m.equipment.full]; }
            else { enInventario[m.equipment.full] = { serie: m.equipment.full, entrada: m.timestamp, ubicacion: m.location || 'N/A' }; }
        });
        var obsoletos = [];
        Object.values(enInventario).forEach(function(item){
            var dias = Math.floor((hoy - new Date(item.entrada)) / (1000*60*60*24));
            if(dias > 90){ item.dias = dias; obsoletos.push(item); }
        });
        return obsoletos.sort(function(a,b){ return b.dias - a.dias; });
    }
    
    function openModule(m){
        showScreen(m+'Screen');
        if(['recepcion','acomodo','traspaso','embarque'].indexOf(m) !== -1){ setTimeout(function(){ startScanner(m); }, 300); }
        if(m === 'historial') applyHistoryFilters();
        if(m === 'misMovimientos') renderMyMovements();
        if(m === 'pendientes') renderPendientesList();
        if(m === 'dashboard') renderDashboard();
        if(m === 'auditSample') renderAuditSample();
        if(m === 'metric') renderMetric();
        if(m === 'cargaMasiva') resetCargaMasiva();
        if(m === 'acomodo'){ acomodoMultipleItems = []; renderAcomodoMultipleList(); }
        if(m === 'calidadSalidas'){ loadCalidadScannedItems(); renderCalidadList(); document.getElementById('calidadResultados').classList.add('hidden'); initCalidadScanner(); }
        if(m === 'incidencias') renderMisIncidencias();
        if(m === 'verIncidencias') filtrarIncidencias();
        if(m === 'verCalidadSalidas') filtrarCalidadReportes();
        if(m === 'muestreoInterno') renderHistorialMuestreoInterno();
        if(m === 'liberarReparacion'){ state.scannedItems.reparacion = []; renderReparacionList(); }
        if(m === 'historialReparaciones') filtrarHistorialReparaciones();
        if(m === 'exportAlertas') renderAlertas();
        if(m === 'exportObsolescencia') renderObsolescencia();
    }
    
    function renderAlertas(){
        var alertas = calcularAlertas();
        document.getElementById('alertasTotal').textContent = alertas.length;
        var container = document.getElementById('alertasLista');
        if(!alertas.length){ container.innerHTML = '<div class="empty-state"><p>Sin alertas</p></div>'; return; }
        var html = '';
        alertas.forEach(function(a){ html += '<div class="config-card" style="margin-bottom:6px;padding:10px;border-left:4px solid var(--warning)"><div style="display:flex;justify-content:space-between"><strong style="font-family:monospace">'+a.serie+'</strong><span style="color:var(--warning);font-weight:700">'+a.dias+' d√≠as</span></div><div style="font-size:11px;color:var(--text-light)">'+a.ubicacion+' ‚Ä¢ √öltimo: '+a.tipo+'</div></div>'; });
        container.innerHTML = html;
    }
    
    function renderObsolescencia(){
        var obsoletos = calcularObsolescencia();
        document.getElementById('obsolescenciaTotal').textContent = obsoletos.length;
        var container = document.getElementById('obsolescenciaLista');
        if(!obsoletos.length){ container.innerHTML = '<div class="empty-state"><p>Sin obsoletos</p></div>'; return; }
        var html = '';
        obsoletos.forEach(function(o){ html += '<div class="config-card" style="margin-bottom:6px;padding:10px;border-left:4px solid var(--error)"><div style="display:flex;justify-content:space-between"><strong style="font-family:monospace">'+o.serie+'</strong><span style="color:var(--error);font-weight:700">'+o.dias+' d√≠as</span></div><div style="font-size:11px;color:var(--text-light)">'+o.ubicacion+'</div></div>'; });
        container.innerHTML = html;
    }
    
    function descargarAlertasExcel(){
        var alertas = calcularAlertas();
        if(!alertas.length){ showToast('warning','Sin alertas'); return; }
        var csv='Serie,Dias Sin Movimiento,Ubicacion,Ultimo Movimiento\n';
        alertas.forEach(function(a){ csv+='"'+a.serie+'",'+a.dias+',"'+a.ubicacion+'","'+a.tipo+'"\n'; });
        downloadCSV(csv,'alertas_30dias_'+new Date().toISOString().slice(0,10)+'.csv');
    }
    
    function descargarObsolescenciaExcel(){
        var obsoletos = calcularObsolescencia();
        if(!obsoletos.length){ showToast('warning','Sin obsoletos'); return; }
        var csv='Serie,Dias Sin Embarque,Ubicacion\n';
        obsoletos.forEach(function(o){ csv+='"'+o.serie+'",'+o.dias+',"'+o.ubicacion+'"\n'; });
        downloadCSV(csv,'obsolescencia_90dias_'+new Date().toISOString().slice(0,10)+'.csv');
    }

})();
</script>
</body>
</html>
